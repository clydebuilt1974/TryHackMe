# Nmap Live Host Discovery
* Nmap (Netwrok Mapper) created in 1997 by Gordon Lyon (Fyodor).
  * Open-source software released under GPL licence.
  * Industry-standard tool for mapping networks, identifying live hosts, and discovering running services.
  * Scripting engine can further extend the functionality, from fingerprinting services to exploiting vulnerabilities.
* Nmap scans usually go through the steps below, although many are optional and depend on the command-line arguments provided.

| Step | Step name
| --- | ---
| 1 | Enumerate targets
| 2 | Discover live hosts
| 3 | Reverse-DNS lookup
| 4 | Scan ports
| 5 | Detect versions
| 6 | Detect OS
| 7 | Traceroute
| 8 | Scripts
| 9 | Write output

## Subnetworks
* Network segment is a group of computers connected using a shared medium.
  * Medium can be the Ethernet switch or WiFi access point.
* Subnetworks (subnets) are usually the equivalent of one or more network segments connected together and configured to use the same router in an IP network.
  * Subnets have their own IP address range and are connected to a more extensive network via the router.
* There might be a firewall enforcing security policies depending on each network.
* Discover more information about a group of hosts or about a subnet as part of active reconnaissance.
* Scanner will likely rely on ARP (Address Resolution Protocol) queries to discover live hosts when connected to the same subnet.
  * ARP query aims to get the hardware address (MAC address) so that communication over the link-layer becomes possible.
  * Can use this to infer that the host is online.
  * ARP is a link-layer protocol, and ARP packets are bound to their subnet.
* If connected to a subnet different from the subnet of the target system(s).
  * All packets generated by the scanner will be routed via the default gateway (router) to reach the systems on another subnet.
  * ARP queries will not be routed and hence cannot cross the subnet router.

## Enumerating Targets
* Need to specify the targets to scan.
* Can provide a list, a range, or a subnet.
  * **list**: `10.10.210.6 scanme.nmap.org example.com` will scan 3 IP addresses.
  * **range**: `10.11.12.15-20` will scan 6 IP addresses: 10.11.12.15, 10.11.12.16,… and 10.11.12.20.
  * **subnet**: `TARGET_IP/30` will scan 4 IP addresses.
* Can provide a file as input for list of targets `nmap -iL list_of_hosts.txt`.
* To check the list of hosts that Nmap will scan use `nmap -sL TARGETS`.
  * This option will give a detailed list of the hosts that Nmap will scan without scanning them.
  * Nmap will attempt a reverse-DNS resolution on all the targets to obtain their names.
  * Names might reveal various information to the pentester.
  * To prevent Nmap from perfroming DNS lookups add `-n`.

## Discovering Live Hosts

<table>
    <thead>
        <tr>
            <th>Layer</th>
            <th>OSI</th>
            <th>TCP/IP</th>
            <th>Protocols</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>7</td>
            <td>Application</td>
            <td rowspan=3>Application</td>
            <td rowspan=3>HTTP, HTTPS, SMTP, POP3, IMAP, SSHY, FTP, SNMP, Telnet, RDP</td>
        </tr>
        <tr>
            <td>6</td>
            <td>Presentation</td>
        </tr>
        <tr>
            <td>5</td>
            <td>Session</td>
        </tr>
        <tr>
            <td>4</td>
            <td>Transport</td>
            <td>Transport</td>
            <td>TCP, UDP</td>
        </tr>
        <tr>
            <td>3</td>
            <td>Network</td>
            <td>Network</td>
            <td>IPv4, IPv6, ICMP, IPsec</td>
        </tr>
        <tr>
            <td>2</td>
            <td>Data Link</td>
            <td rowspan=2>Link</td>
            <td rowspan=2>ARP, Ethernet (802.3), WiFi (802.11), DSL, Bluetooth</td>
        </tr>
        <tr>
            <td>1</td>
            <td>Physical</td>
        </tr>
    </tbody>
</table>

* Leverage protocols to discover live hosts.
  * ARP from Link Layer.
    * One purpose: sending a frame to the broadcast address on the network segment and asking the computer with a specific IP address to respond by providing its MAC (hardware) address.
    * ARP query should precede the ICMP Echo when pinging a system on the same subnet.
  * ICMP from Network Layer.
    * Has [many types](https://www.iana.org/assignments/icmp-parameters/icmp-parameters.xhtml).
    * ICMP ping uses Type 8 (Echo) and Type 0 (Echo Reply).
  * TCP and UDP from Transport Layer.
    * Scanner can send a specially-crafted packet to common TCP or UDP ports to check whether the target will respond.
    * This method is efficient especially when ICMP Echo is blocked.

## Nmap Host Discovery Using ARP
* It is essential to avoid wasting time port-scanning an offline host or an IP address not in use.
1. ARP Requests used when a privileged user scans targets on a local network (Ethernet).
   * Privileged user is `root` or a user who belongs to `sudoers` and can run `sudo`.
   * Live hosts respond to ARP Request with an ARP Reply.
2. ICMP echo requests, TCP ACK (Acknowledge) to port 80, TCP SYN (Synchronise) to port 443, and ICMP timestamp request used when a privileged user scans targets outside the local network.
3. TCP 3-way handshake used by sending SYN packets to ports 80 and 443 when an unprivileged user scans targets outside the local network.
* Uses ping scan to find live hosts then scans them.
  * To discover live hosts without port-scanning them issue `nmap -sn TARGETS`.
* ARP scan is possible only if the source is on the same subnet as the target systems.
  * MAC address of any system must be known before it can be communicated with on an Ethernet (802.3) and WiFi (802.11).
    * MAC address is necessary for the link-layer header.
      * Header contains source MAC address and destination MAC address.
  * Source OS sends an ARP query to get MAC address of the destination.
    * Host that replies to ARP queries is up.
  * Expect to see many ARP queries generated during a Nmap scan of a local network.
    * To perform an ARP scan without port-scanning use `nmap -PR -sn TARGETS`.
* Run nmap -PR -sn 10.10.210.6/24 to discover all the live systems on the same subnet.
```
sudo nmap -PR -sn 10.10.210.6/24

Starting Nmap 7.60 ( https://nmap.org ) at 2021-09-02 07:12 BST
Nmap scan report for ip-10-10-210-75.eu-west-1.compute.internal (10.10.210.75)
Host is up (0.00013s latency).
MAC Address: 02:83:75:3A:F2:89 (Unknown)
Nmap scan report for ip-10-10-210-100.eu-west-1.compute.internal (10.10.210.100)
Host is up (-0.100s latency).
MAC Address: 02:63:D0:1B:2D:CD (Unknown)
Nmap scan report for ip-10-10-210-165.eu-west-1.compute.internal (10.10.210.165)
Host is up (0.00025s latency).
MAC Address: 02:59:79:4F:17:B7 (Unknown)
Nmap scan report for ip-10-10-210-6.eu-west-1.compute.internal (10.10.210.6)
Host is up.
Nmap done: 256 IP addresses (4 hosts up) scanned in 3.12 seconds
```  
* Nmap sends ARP requests to all target computers and those online should send an ARP reply back.
* Viewing ARP scan packet data in Wireshark.
  * Source address is the MAC address of the source.
  * Destination is broadcast address (`FF.FF.FF.FF.FF.FF`) as we the MAC address of the target is unkown.
  * Target’s IP address appears in the Info column.
    * MAC addresses of all the IP addresses on the subnet are being requested.
  * Host with the IP address being asked about will send an ARP reply with its MAC address.
    * Verification that it is online.
* `arp-scan` is a scanner built around ARP queries.
  * Visit the [arp-scan wiki](http://www.royhills.co.uk/wiki/index.php/Main_Page) for detailed information.
  * `arp-scan --localnet` or simply `arp-scan -l` will send ARP queries to all valid IP addresses on your local networks.
  * `sudo arp-scan -I eth0 -l` will send ARP queries for all valid IP addresses on the `eth0` interface.
  * `arp-scan` can be installed using `apt install arp-scan`.
```
sudo arp-scan 10.10.210.6/24

Interface: eth0, datalink type: EN10MB (Ethernet)
WARNING: host part of 10.10.210.6/24 is non-zero
Starting arp-scan 1.9 with 256 hosts (http://www.nta-monitor.com/tools/arp-scan/)
10.10.210.75	02:83:75:3a:f2:89	(Unknown)
10.10.210.100	02:63:d0:1b:2d:cd	(Unknown)
10.10.210.165	02:59:79:4f:17:b7	(Unknown)

4 packets received by filter, 0 packets dropped by kernel
Ending arp-scan 1.9: 256 hosts scanned in 2.726 seconds (93.91 hosts/sec). 3 responded
```   
* `arp-scan` will generate many ARP queries that can be see using tcpdump, Wireshark, or a similar tool.
* Packet capture for `arp-scan` and `nmap -PR -sn` yield similar traffic patterns.

## Nmap Host Discovery Using ICMP
* Can ping every IP address on a target network and see who would respond to the ping (ICMP Type 8/Echo) requests with a ping reply (ICMP Type 0).
  * Many firewalls block ICMP echo.
  * New versions of MS Windows are configured with a host firewall that blocks ICMP echo requests by default.
  * ARP query will precede the ICMP request if the target is on the same subnet.
* To use ICMP echo request to discover live hosts, add the option `-PE`.
  * Add `-sn` to disable the auomatic port-scan.
* ICMP echo scan works by sending an ICMP echo request and expects the target to reply with an ICMP echo reply if it is online.
* The below scan will send ICMP echo packets to every IP address on the subnet.
```
sudo nmap -PE -sn 10.10.68.220/24

Starting Nmap 7.60 ( https://nmap.org ) at 2021-09-02 10:16 BST
Nmap scan report for ip-10-10-68-50.eu-west-1.compute.internal (10.10.68.50)
Host is up (0.00017s latency).
MAC Address: 02:95:36:71:5B:87 (Unknown)
Nmap scan report for ip-10-10-68-52.eu-west-1.compute.internal (10.10.68.52)
Host is up (0.00017s latency).
MAC Address: 02:48:E8:BF:78:E7 (Unknown)
Nmap scan report for ip-10-10-68-77.eu-west-1.compute.internal (10.10.68.77)
Host is up (-0.100s latency).
MAC Address: 02:0F:0A:1D:76:35 (Unknown)
Nmap scan report for ip-10-10-68-110.eu-west-1.compute.internal (10.10.68.110)
Host is up (-0.10s latency).
MAC Address: 02:6B:50:E9:C2:91 (Unknown)
Nmap scan report for ip-10-10-68-140.eu-west-1.compute.internal (10.10.68.140)
Host is up (0.00021s latency).
MAC Address: 02:58:59:63:0B:6B (Unknown)
Nmap scan report for ip-10-10-68-142.eu-west-1.compute.internal (10.10.68.142)
Host is up (0.00016s latency).
MAC Address: 02:C6:41:51:0A:0F (Unknown)
Nmap scan report for ip-10-10-68-220.eu-west-1.compute.internal (10.10.68.220)
Host is up (0.00026s latency).
MAC Address: 02:25:3F:DB:EE:0B (Unknown)
Nmap scan report for ip-10-10-68-222.eu-west-1.compute.internal (10.10.68.222)
Host is up (0.00025s latency).
MAC Address: 02:28:B1:2E:B0:1B (Unknown)
Nmap done: 256 IP addresses (8 hosts up) scanned in 2.11 seconds
```    
* Do not expect to learn the MAC addresses of the targets unless they are on the same subnet as the source system.
* Output indicates that Nmap did not need to send ICMP packets as it confirmed that these hosts are up based on the ARP responses received.
* Repeat the ICMP scan but now scanning from a system in a different subnet.
  * The results are similar but without the MAC addresses.
```
sudo nmap -PE -sn 10.10.68.220/24

Starting Nmap 7.92 ( https://nmap.org ) at 2021-09-02 12:16 EEST
Nmap scan report for 10.10.68.50
Host is up (0.12s latency).
Nmap scan report for 10.10.68.52
Host is up (0.12s latency).
Nmap scan report for 10.10.68.77
Host is up (0.11s latency).
Nmap scan report for 10.10.68.110
Host is up (0.11s latency).
Nmap scan report for 10.10.68.140
Host is up (0.11s latency).
Nmap scan report for 10.10.68.142
Host is up (0.11s latency).
Nmap scan report for 10.10.68.220
Host is up (0.11s latency).
Nmap scan report for 10.10.68.222
Host is up (0.11s latency).
Nmap done: 256 IP addresses (8 hosts up) scanned in 8.26 seconds     
```
* Wireshark shows one source IP address on a different subnet sending ICMP echo requests to all the IP addresses in the target subnet to see which one will reply.
* Because ICMP echo requests tend to be blocked consider ICMP Timestamp or ICMP Address Mask requests to tell if a system is online.
  * Nmap uses timestamp request (ICMP Type 13) and checks whether it will get a Timestamp reply (ICMP Type 14).
  * `-PP` option tells Nmap to use ICMP timestamp requests.
```
sudo nmap -PP -sn 10.10.68.220/24

Starting Nmap 7.92 ( https://nmap.org ) at 2021-09-02 12:06 EEST
Nmap scan report for 10.10.68.50
Host is up (0.13s latency).
Nmap scan report for 10.10.68.52
Host is up (0.25s latency).
Nmap scan report for 10.10.68.77
Host is up (0.14s latency).
Nmap scan report for 10.10.68.110
Host is up (0.14s latency).
Nmap scan report for 10.10.68.140
Host is up (0.15s latency).
Nmap scan report for 10.10.68.209
Host is up (0.14s latency).
Nmap scan report for 10.10.68.220
Host is up (0.14s latency).
Nmap scan report for 10.10.68.222
Host is up (0.14s latency).
Nmap done: 256 IP addresses (8 hosts up) scanned in 10.93 seconds      
```
* Scan sends many ICMP timestamp requests to every valid IP address in the target subnet.
* Wireshark shows one source IP address sending ICMP packets to every possible IP address to discover online hosts.
* Nmap uses address mask queries (ICMP Type 17) and checks whether it gets an address mask reply (ICMP Type 18).
  * Enable this with `-PM`.
  * Live hosts are expected to reply to ICMP address mask requests.
```
sudo nmap -PM -sn 10.10.68.220/24

Starting Nmap 7.92 ( https://nmap.org ) at 2021-09-02 12:13 EEST
Nmap done: 256 IP addresses (0 hosts up) scanned in 52.17 seconds
```       
* This scan returned none although based on the earlier scan there are at least eight live hosts.
  * Target system or a firewall on the route is blocking this type of ICMP packet.
  * This scan still sent ICMP address mask requests to every valid IP address and waited for a reply.
* If one type of packet is being blocked another can be chosen to discover the target network and services.

## Nmap Host Discovery Using TCP and UDP
### TCP SYN Ping
* Can send a packet with the SYN (Synchronise) flag set to a TCP port (80 by default) and wait for a response.
  * Open port should reply with a SYN/ACK (Acknowledge).
  * Closed port would result in an RST (Reset).
* Reminder of how TCP 3-way handshake works.

| Source | Destination
| --- | ---
| SYN -> |
| | <- SYN ACK
| ACK -> |

* Use Nmap TCP SYN ping via the option `-PS` followed by the port number, range, list, or a combination of them.
  * `-PS21` will target port 21.
  * `-PS21-25` will target ports 21, 22, 23, 24, and 25.
  * `-PS80,443,8080` will target ports 80, 443, and 8080.
* Privileged users (`root` and `sudoers`) can send TCP SYN packets and do not need to complete the TCP 3-way handshake even if the port is open.
* Unprivileged users have to complete the 3-way handshake if the port is open.
```
sudo nmap -PS -sn 10.10.68.220/24

Starting Nmap 7.92 ( https://nmap.org ) at 2021-09-02 13:45 EEST
Nmap scan report for 10.10.68.52
Host is up (0.10s latency).
Nmap scan report for 10.10.68.121
Host is up (0.16s latency).
Nmap scan report for 10.10.68.125
Host is up (0.089s latency).
Nmap scan report for 10.10.68.134
Host is up (0.13s latency).
Nmap scan report for 10.10.68.220
Host is up (0.11s latency).
Nmap done: 256 IP addresses (5 hosts up) scanned in 17.38 seconds     
```
* Wireshark analysis shows that TCP port 80 was used as no TCP ports were specified in the TCP SYN scan.
  * Any service listening on port 80 is expected to reply indirectly indicating that the host is online.

### TCP ACK Ping
* This sends a packet with an ACK flag set.
* Must be running Nmap as a privileged user.
  * Nmap will attempt a 3-way handshake If attempted as an unprivileged user.
* `-PA` should be followed by a port number, range, list, or a combination of them.
  * `-PA21`, `-PA21-25` and `-PA80,443,8080`.
  * Port 80 will be used if no port is specified.
* Any TCP packet with an ACK flag should get a TCP packet back with an RST flag set.
  * Target responds with RST flag set because the TCP packet with the ACK flag is not part of any ongoing connection.
  * Expected response is used to detect if the target host is up.
```
sudo nmap -PA -sn 10.10.68.220/24

Starting Nmap 7.92 ( https://nmap.org ) at 2021-09-02 13:46 EEST
Nmap scan report for 10.10.68.52
Host is up (0.11s latency).
Nmap scan report for 10.10.68.121
Host is up (0.12s latency).
Nmap scan report for 10.10.68.125
Host is up (0.10s latency).
Nmap scan report for 10.10.68.134
Host is up (0.10s latency).
Nmap scan report for 10.10.68.220
Host is up (0.10s latency).
Nmap done: 256 IP addresses (5 hosts up) scanned in 29.89 seconds      
```
* Wireshark analysis shows many packets with the ACK flag set and sent to port 80 of the target systems.
  * Nmap sends each packet twice.
  * The systems that do not respond are offline or inaccessible.

### UDP Ping
* Finally, we can use UDP to discover if the host is online.
* Contrary to TCP SYN ping, sending a UDP packet to an open port is not expected to lead to any reply.
* However, if we send a UDP packet to a closed UDP port, we expect to get an ICMP port unreachable packet; this indicates that the target system is up and available.
* In the following figure, we see a UDP packet sent to an open UDP port and not triggering any response.
* However, sending a UDP packet to any closed UDP port can trigger a response indirectly indicating that the target is online.
* The syntax to specify the ports is similar to that of TCP SYN ping and TCP ACK ping; Nmap uses -PU for UDP ping.
* In the following example, we use a UDP scan, and we discover five live hosts.
```
sudo nmap -PU -sn 10.10.68.220/24

Starting Nmap 7.92 ( https://nmap.org ) at 2021-09-02 13:45 EEST
Nmap scan report for 10.10.68.52
Host is up (0.10s latency).
Nmap scan report for 10.10.68.121
Host is up (0.10s latency).
Nmap scan report for 10.10.68.125
Host is up (0.14s latency).
Nmap scan report for 10.10.68.134
Host is up (0.096s latency).
Nmap scan report for 10.10.68.220
Host is up (0.11s latency).
Nmap done: 256 IP addresses (5 hosts up) scanned in 9.20 seconds      
```
* Let’s inspect the UDP packets generated.
* In the following Wireshark screenshot, we notice Nmap sending UDP packets to UDP ports that are most likely closed.
* The image below shows that Nmap uses an uncommon UDP port to trigger an ICMP destination unreachable (port unreachable) error.

## Masscan
* On a side note, Masscan uses a similar approach to discover the available systems.
* However, to finish its network scan quickly, Masscan is quite aggressive with the rate of packets it generates.
* The syntax is quite similar: -p can be followed by a port number, list, or range. Consider the following examples:
```
masscan 10.10.68.220/24 -p443
masscan 10.10.68.220/24 -p80,443
masscan 10.10.68.220/24 -p22-25
masscan 10.10.68.220/24 ‐‐top-ports 100
```
* If Masscan is not installed, it can be installed using apt install masscan.

## Using Reverse-DNS Lookup
* Nmap’s default behaviour is to use reverse-DNS online hosts.
* Because the hostnames can reveal a lot, this can be a helpful step.
* However, if you don’t want to send such DNS queries, you use -n to skip this step.
* By default, Nmap will look up online hosts; however, you can use the option -R to query the DNS server even for offline hosts.
* If you want to use a specific DNS server, you can add the --dns-servers DNS_SERVER option.

## Summary
* You have learned how ARP, ICMP, TCP, and UDP can detect live hosts by completing this room.
* Any response from a host is an indication that it is online.
* Below is a quick summary of the command-line options for Nmap that we have covered.

| Scan Type | Example Command
| --- | ---
| ARP Scan | `sudo nmap -PR -sn MACHINE_IP/24`
| ICMP Echo Scan | `sudo nmap -PE -sn MACHINE_IP/24`
| ICMP Timestamp Scan | `sudo nmap -PP -sn MACHINE_IP/24`
| ICMP Address Mask Scan | `sudo nmap -PM -sn MACHINE_IP/24`
| TCP SYN Ping Scan | `sudo nmap -PS22,80,443 -sn MACHINE_IP/30`
| TCP ACK Ping Scan | `sudo nmap -PA22,80,443 -sn MACHINE_IP/30`
| UDP Ping Scan | `sudo nmap -PU53,161,162 -sn MACHINE_IP/30`

* Remember to add -sn if you are only interested in host discovery without port-scanning.
* Omitting -sn will let Nmap default to port-scanning the live hosts.

| Option | Purpose
| --- | ---
| `-n` | no DNS lookup
| `-R` | reverse-DNS lookup for all hosts
| `-sn` | host discovery only
