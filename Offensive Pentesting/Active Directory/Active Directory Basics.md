# Active Directory Basics
## Windows Domains
* Windows domain is the group of users and computers under administration of a given business.
* **Active Directory (AD)**.
  * Centralises administration of common components (credentials) of Windows network in single repository.
* **Domain Controller (DC)**.
  * Server that runs AD services.
* Main advantges of Windows domain.
  * **Centralised identity management**.
    * All users can be configured from AD with minimal effort.    
  * **Centralised security policies**.
    * Policies configured directly from AD and applied to users and computers as needed.
## Active Directory
* **Active Directory Domain Service (AD DS)**.
  * Core of any Windows domain.
  * Acts as catalogue that holds information of all "objects".
    * Users, groups, machines, printers, shares, etc.
#### Users
* One of the objects known as **security principles**.
  * Can be authenticated by Windows domain.
  * Can be assigned privileges over **resources**.
    * E.g. files or printers. ## Managing Users in AD
* Can represent two entity types.
  * **People**.
    * E.g. employees.
  * **Services**.
    * Only have privileges needed to run their specific service.
    * E.g. IIS or SQL.
#### Machines
* Machine object created for every computer that joins AD domain.
* Also considered security principles.
* Created account has limited rights within domain.
* Account is local administrator on assigned computer.
  * Passwords are automatically rotated out.
  * Generally 120 random characters.
* Account mane is computer's name followed by dollar sign.
### Security Groups
* Define user groups to assign rights to resources.
* Allows better manageability as added users automatically inherit all group's privileges.
* Considered security principles.
* Can contain users, machines and other groups as members.

#### Important domain groups created by default

| Security Group | Description
| --- | --- 
| Domain Admins | Administrative privileges over entire domain. 
| Server Operators | Can administer DCs. Cannot change any administrative group memberships.
| Backup Operators | Can access any file, ignoring their permissions. Used to perfrom backups of computer data.
| Account Operators | Can create or modify othe domain accounts.
| Domain Users | All existing user accounts in the domain.
| Domain Computers | All existing computers in the domain
| Domain Controllers | All existing DCs in the domain

* [Complete list of default security groups](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups).
### Active Directory Users and Computers
* Software used to configure security principles.
* Displays hierarchy of objects that exist in domain.
* **Organisational Units (OUs)** are container objects used to classify users and machines.
  * User can only be a member of single OU.
  * Mainly used to define sets of users with similar policing requirements.
    * E.g. IT, Management, Marketing, R&D, Sales.

#### OUs automatically created by Windows

| Container | Description
| --- | ---
| Builtin | Contains default groups available to any Windows host.
| Computers | Any machine joining the domain is put here by default.
| Domain Controllers | Contains DCs by default.
| Users | Default users and groups that apply to domin-wide context.
| Managed Service Accounts | Accounts used by services within the Windows domain.

### Security Groups vs OUs
* **OUs** used for **applying policies** to users and computers.
* **Security Groups** used to **grant permissions over resources**.

## Managing Users in AD
### Delegation
* Grant specific users specific privileges to perfrom advanced tasks over an OU.
  * E.g. allow IT OU privileges to reset other low-privilege user passwords.
* PowerShell can be used if delegated user has no acces to Active Directory Users and Computers.
```
Set-ADAcountPassword sophie -Rest -NewPassword (Read-Host -AsSecureString -Prompt 'New Password') - Verbose
```
* Force user password reset at next login using PowerShell.
```
Set-ADUser -ChangePasswordAtLogin $true -Identity sophie -Verbose
```

## Managing Computers in AD
* Segregate devices according to their use.
#### Workstations
* Most common devices within AD domain.
* Should never have privileged users signed into them.
#### Servers
* Second most common device within AD domain.
* Provide services to users or other servers.
#### DCs
* Allow management of AD domain.
* Most sensitive devices within network.
  * Contain hashed passwords for all accounts.

## Group Policies
* Deploy different policies for each OU individually.
  * Configuration settings.
  * Security baselines.
* **Group Policy Objects (GPOs)** manage policies.
  * Aimed at either users or computers.
* **Group Policy Management** tool used to configure GPOs.
  * **Group Policy Objects** to create GPO.
  * Link GPO to OU.
  * GPO will apply to linked OU and any sub-OUs.
  * **Scope** tab is where GPO is linked in the AD.
    * **Security filtering** can be applied to GPOs so they only apply yo specific users / computers.
  * **Settings** tab contains GPO configurations.
### GPO distribution
* **SYSVOL** network share on DC used to distribute GPOs.
  * `C:\Windows\SYSVOL\sysvol\`
* GPO changes may take up to 2 hours to propagate.
  * `gpupdate /force` forces computer to sync GPOs immediately.

## Authentication Methods
### Kerberos Authentication
* Default authentication protocol in any recent Windows domain.
* Users assigned tickets as proof of previous authentication.
* Tickets presented to service for access.
#### Kerberos Authentication Process
1. User sends **username** and **timestamp** encrypted using key derived from their **password** to **Key Distribution Center (KDC)**.
   * KDC is service in charge of creating Kerberos tickets.
   * Usually installed on DC.
2. KDC creates and sends back **Ticket Granting Ticket (TGT)** and **Session Key**.
   * TGT allows user to request additional tickets to access specific services.
     * Service tickets can be requested without passing credentials each time.
   * TGT encrypted using **krbtgt** account's password hash.
     * User cannot access TGT contents.
   * TGT includes copy of Session Key.
     * KDC has no need to store Session Key as it can be recovered by decrypting TGT if needed.

![d36f5a024c20fb480cdae8cd09ddc09f](https://github.com/clydebuilt1974/TryHackMe/assets/157394432/02e285d5-5f07-4dcd-82c7-49e8f1dde151)

3. User uses TGT to ask KDC for **Ticket Granting Service (TGS)** when requesting access to specific network service.
   * Data required to request TGS.
     * Username and timestamp encrypted with Session Key.
     * TGT.
     * **Service Principal Name (SPN)** of service and server name to access.
4. KDC sends TGS and **Service Session Key** to authenticate to service.
   * TGS encrypted using key derived from **Service Owner Hash**.
     * Service Owner is user or machine account that service runs under.
   * TGS contains copy of Service Sesson Key to allow decryption by Service Owner. 
   
![84504666e78373c613d3e05d176282dc](https://github.com/clydebuilt1974/TryHackMe/assets/157394432/12b1b283-1c9b-468c-b50d-29c7d42b2ba1)

5. TGS sent to desired service to authenticate and establish connection.
   * Service uses its configured account's password pash to decrypt TGS and validate Service Session Key.
     
![8fbf08d03459c1b792f3b6efa4d7f285](https://github.com/clydebuilt1974/TryHackMe/assets/157394432/1057152f-55e0-4354-83e2-2a5240cc1e48)

### NetNTLM Authentication
* Legacy protocol kept for compatibility purposes.
* Works using challenge-response mechanism.
#### NetNTLM Authentication Process
1. Client sends authentication request to desired server.
2. Server generates random number and sends this as challenge to client.
3. Client combines NTLM password hash with challenge (and other data) to generate response and sends this back to server for verification.
4. Server forwards challenge and response to DC for verification.
5. DC uses challenge to recalculate response and compares result with original response sent by client.
   * Client authenticated if results match.
   * Authentication result sent back to server.
7. Server forwards authentication result to client.

![2eab5cacbd0d3e9dc9afb86169b711ec](https://github.com/clydebuilt1974/TryHackMe/assets/157394432/8c585dc7-9b27-4351-8a50-501543fbc822)

* User password / hash never transmitted through network for security.
* Above process applies when using domain account.
  * Server verifies response to challenge itself if local account is used.
  * Password hash stored locally on SAM.
 
## Trees, Forests and Trusts
### Trees
* Integration of multiple domains.
* Build tree with root domain and subdomains.
* Subdomains give better control over who can access what in domain.
* Policies configured independently for each domain in tree.
* **Enterprise Admins** group grants administrative privileges over all domains.
### Forests
* Union of several domain trees with different namespaces.
### Trust Relationships
* Join together domains arranged in trees and forests.
* Authorise user from one domain to access resources from another.
* **One-way trust relationship** means domain A trusts domain B allowing users on domain B to be authorised to access resources on domain A.
* **Two-way trust relationship** means domain A and doman B can mutually authorise users from the other.
  * Default type of trust relationship.
