# Enumerating Active Directory

### Why AD Enumeration <a href="#mpo51eizt6x4" id="mpo51eizt6x4"></a>

### AD Enumeration <a href="#id-362gdzbi9mek" id="id-362gdzbi9mek"></a>

Start enumerating various details about AD setup and structure once initial foothold achieved. Enumeration again performed once attack path identified by enumeration phase has been exploited.

![Attack chain](<../.gitbook/assets/0 (9).png>)

### Credential Injection <a href="#h1efbl5m9nch" id="h1efbl5m9nch"></a>

### Windows vs Linux <a href="#id-8ahtcwhurt9x" id="id-8ahtcwhurt9x"></a>

Windows machine is required to perform in-depth AD enumeration as this allows use of several built-in methods to stage enumeration.

### Runas Explained <a href="#anqilxs9otlg" id="anqilxs9otlg"></a>

**Runas** is native Windows binary that can be used to inject discovered credentials into memory:

```
runas.exe /netonly /user:<domain>\<username> cmd.exe
```

`/netonly` loads credentials for network authentication into memory but does not authenticate against DC. Commands executed locally on computer will run in context of standard Windows account. Any network connections will occur using specified account.

`/user` always safe bet to use FQDN instead of just NetBIOS name of domain as this helps with resolution.

`cmd.exe` binary to execute once the credentials are injected.

### It’s Always DNS <a href="#whd9xuif7ov2" id="whd9xuif7ov2"></a>

Verify that injected credentials are working by forcing network-based listing of  SYSVOL directory. Set DNS manually using IP of DC:

```powershell
$dnsip = “<DC IP>”
```

{% code overflow="wrap" %}
```powershell
$index = get-netadapter -name ‘<local interface>’ | select-object -expandproperty ‘ifindex’ set-dnsclientserveraddress =interfaceindex $index -serveraddress $dnsip
```
{% endcode %}

Listing SYSVOL as any AD account can read contents of this directory. SYSVOL stores Group Policy Objects (GPOs) and any other domain related scripts. Worth enumerating for additional AD credentials.

```
dir \\za.tryhackme.com\sysvol\
```

### IP vs Hostnames <a href="#b48wm6o9b7e1" id="b48wm6o9b7e1"></a>

Network authentication will first attempt to perform Kerberos authentication if hostname is provided. Organisations may be monitoring for **OverPass** and **Pass-The-Hash** attacks. Authentication type can be forced to NTLM if IP used.

### Using Injected Credentials <a href="#id-31x1d8usm2i8" id="id-31x1d8usm2i8"></a>

All network communication will use in-memory injected credentials for authentication if  `/netonly` runas option specified.

### Enumeration Through Microsoft Management Console <a href="#foya32pzfafl" id="foya32pzfafl"></a>

### Microsoft Management Console <a href="#id-9kcxztc04i8z" id="id-9kcxztc04i8z"></a>

Use Microsoft Management Console (MMC):

* Start -> search for **run** -> **mmc.**
* Attach AD Remote Server Management Tools (RSAT) Snap-in:
  * Click **File** -> **Add/Remove Snap-in**.
  * Select and **Add** all three Active Directory Snap-ins.
  * Click through any errors and warnings.
  * Right-click on **Active Directory Domains and Trusts** and select **Change Forest.**
  * Enter _za.tryhackme.com_ as **Root domain** and Click **OK.**
  * Right-click on **Active Directory Sites and Services** and select **Change Forest.**
  * Enter _za.tryhackme.com_ as **Root domain** and Click OK.
  * Right-click on **Active Directory Users and Computers** and select **Change Domain.**
  * Enter _za.tryhackme.com_ as **Domain** and Click **OK.**
  * Right-click on **Active Directory Users and Computers** in left-hand pane.
  * Click on **View** -> **Advanced Features.**

MMC should now be pointed to and authenticated against target domain.

### Users and Computers <a href="#id-48yme86s5s5f" id="id-48yme86s5s5f"></a>

Expand domain in ADUC to see initial Organisational Unit (OU) structure. Clicking on User or Computer objects allows review of all their properties and attributes. Passwords could be changed or accounts added to specific groups with relevant permissions. Search feature can be used to look for specific objects.

### Benefits <a href="#u8whjzilshdr" id="u8whjzilshdr"></a>

GUI provides excellent method to gain holistic view of AD environment. Rapid searching of AD objects. Direct method to view specific updates of AD objects. Directly update existing AD objects or add new ones.

### Drawbacks <a href="#gkgpn05eplel" id="gkgpn05eplel"></a>

GUI requires RDP access to machine where it is executed. Gathering AD wide properties or attributes cannot be performed.

### Enumeration Through Command Prompt <a href="#id-6wikzkkaor2s" id="id-6wikzkkaor2s"></a>

### Command Prompt <a href="#kr6x5cdz7p5l" id="kr6x5cdz7p5l"></a>

**net** built-in command can enumerate AD information.

{% embed url="https://learn.microsoft.com/en-us/troubleshoot/windows-server/networking/net-commands-on-operating-systems" %}
Full range of options associated with net command
{% endembed %}

### Users <a href="#ron9b0ff4ubq" id="ron9b0ff4ubq"></a>

Enumerate all AD domain users:

```
net user /domain
```

Enumerate more detailed information about single AD user account:

```
net user “<user name>” /domain
```

### Groups <a href="#h6oglj727e1n" id="h6oglj727e1n"></a>

Enumerate AD domain groups:

```
net group /domain
```

Enumerate members of specific AD group:

```
net group “<group name>” /domain
```

### Password Policy <a href="#mweb6jfdlgk5" id="mweb6jfdlgk5"></a>

Enumerate domain’s password policy. Beneficial if additional password-spraying attacks are to be staged as payload and attack intensity can be optimised.

```
net accounts /domain
```

![Domain password policy](<../.gitbook/assets/1 (3).png>)

### Benefits <a href="#x357a725y88" id="x357a725y88"></a>

No additional tooling required and commands are often not monitored for by defensive teams. No GUI required. VBScript and other macro languages often used for phishing payloads support these commands natively.

### Drawbacks <a href="#id-5kd3l1ikf2ox" id="id-5kd3l1ikf2ox"></a>

Commands must be executed from domain-joined machine. Some commands will not display all information due to output restrictions.

### Enumeration Through PowerShell <a href="#a5hk8bj11eb4" id="a5hk8bj11eb4"></a>

### PowerShell <a href="#j5e31m7wxjt0" id="j5e31m7wxjt0"></a>

PowerShell is upgrade to Command Prompt. Cmdlets are .NET classes that perform specific functions. AD-RSAT tool automatically installs 50+ cmdlets.

{% embed url="https://learn.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps" %}
Complete list of PowerShell AD-RSAT cmdlets
{% endembed %}

`-Filter` parameter provides control over enumeration.

`Format-Table` cmdlet displays results neatly.

### Users <a href="#m4p1awc8p9px" id="m4p1awc8p9px"></a>

**Get-ADUser** cmdlet enumerates properties of AD user:

```powershell
get-aduser -identity “<account name>” -server <DC FQDN> -properties *
```

Enumerate all AD users with particular name:

{% code overflow="wrap" %}
```powershell
get-aduser -filter ‘name -like “*stevens” -server <DC FQDN> | format-table name,samaccountname -A
```
{% endcode %}

### Groups <a href="#ystymyqoz3i6" id="ystymyqoz3i6"></a>

**Get-ADGroup** cmdlet enumerates AD group:

```powershell
get-adgroup -identity “administrators” -server <DC FQDN
```

**Get-ADGroupMember** cmdlet enumerates members of AD group:

```powershell
get-adgroupmember -identity “administrators” -server <DC FQDN>
```

### AD Objects <a href="#kibg65jbizp8" id="kibg65jbizp8"></a>

**Get-ADObject** cmdlet performs more generic search of AD.

Enumerate all AD objects changed after specific date:

```powershell
$changedate = new-object datetime(2022,02,28,12,00,00)
```

{% code overflow="wrap" %}
```powershell
get-adobject -filter ‘whenchanged -gt $changedate’ -includedeletedobjects -server <DC FQDN>
```
{% endcode %}

Enumerate AD accounts that have **badPwdCount** greater than 0. Exclude these accounts if performing password spraying attack.

```powershell
get-adobject -filter ‘badpwdcount -gt 0’ -server <DC FQDN>
```

### Domains <a href="#id-6va6fd8zzium" id="id-6va6fd8zzium"></a>

**Get-ADDomain** cmdlet retrieves additional information about domain:

```powershell
get-addomain -server <DC FQDN>
```

### Altering AD Objects <a href="#id-90ggrg68iiot" id="id-90ggrg68iiot"></a>

AD-RSAT cmdlets allow creation and modification of AD objects. This would be considered AD exploitation.

Change password of current user using **Set-ADAccountPassword** cmdlet:

{% code overflow="wrap" %}
```powershell
set-adaccountpassword -identity “<account name>” -server <DC FQDN> -oldpassword (convertto-securestring -asplaintext “<old password>” -force) -newpassword (convertto-securestring -asplaintext “<new password>” -force)
```
{% endcode %}

### Benefits <a href="#ulhvll7xxmjo" id="ulhvll7xxmjo"></a>

PowerShell cmdlets can enumerate significantly more information than Command Prompt **net** commands. Commands can be executed from non-domain-joined machine if server and domain are specified. Custom cmdlets can be created to enumerate specific information. AD-RSAT cmdlets can be used to directly change AD objects.

### Drawbacks <a href="#z0m5exp3zhdk" id="z0m5exp3zhdk"></a>

PowerShell usage often monitored by defensive teams. AD-RSAT must be installed or other potentially detectable scripts used.

### Enumeration Through Bloodhound <a href="#id-6ojxr3ypsrhm" id="id-6ojxr3ypsrhm"></a>

[**Bloodhound**](https://github.com/BloodHoundAD/BloodHound) is most powerful AD enumeration tool to date.

### Bloodhound History <a href="#s75l67kpizeh" id="s75l67kpizeh"></a>

Released in 2016 and gave attackers upper hand in AD enumeration. Microsoft integrated own version of Bloodhound into **Advanced Threat Protection** solution to help defenders visualise AD environment.

Provides graph format with interconnected nodes where each connection is possible path that could be exploited to reach a goal. Graph based thinking allows for a two-stage attack:

* Attacker performs phishing to get initial entry to enumerate AD information. Noisy initial payload would be detected and contained before attacker can do anything beyond exfiltrating enumerated data.
* Attacker uses data offline to create attack path in graph format and launches second phishing campaign using gathered information. Attacker reaches their goal in minutes once breach achieved.

### Sharphound <a href="#cpql22x4vcrf" id="cpql22x4vcrf"></a>

Sharphound is enumeration tool of Bloodhound.

Three different Sharphound collectors:

* **Sharphound.ps1** - PowerShell script for running Sharphound. Depreciated. Good to use with RATs as script can be loaded directly into memory to evade on-disk AV scanning.
* **Sharphound.exe** - Windows executable for running Sharphound.
* **AzureHound.ps1** - PowerShell script for running Sharphound for Azure (Microsoft Cloud Computing Services) instances.

Sharphound and Bloodhound versions must match otherwise old Sharphound results cannot be ingested.

High likelihood that SharpHound collector scripts will be detected as malware and raise alerts to Blue team.

Use **runas** command from non-domain-joined Windows machine to inject AD credentials and point Sharphound to DC.

Disable AV or create exceptions on breached Windows machine.

Copy Sharphound binary to breached Windows host:

![](<../.gitbook/assets/2 (3).png>)

Run Sharphound using **All** and **Session collection** methods:

```powershell
sharphound.exe --collectionmethods all --domain za.tryhackme.com --excludedcs
```

`--CollectionMethods` determines what kind of data Sharphound will collect. Common methods are **Default** or **All**. Can only use **Session** method after first scan has been run to retrieve new user sessions.

`--Domain` specifies domain to enumerate.

`--ExcludeDCs` reduces likelihood that Sharphound will raise alerts.

{% embed url="https://bloodhound.readthedocs.io/en/latest/data-collection/sharphound-all-flags.html" %}
List of SharpHound flags
{% endembed %}

![](<../.gitbook/assets/3 (4).png>)

Timestamped ZIP file created once Sharphound has completed enumeration:

![](<../.gitbook/assets/4 (2).png>)

### Bloodhound <a href="#jtcaj5euy6i" id="jtcaj5euy6i"></a>

AD information enumerated by Sharphound is displayed in Bloodhound's GUI. Bloodhound uses **Neoj4** as backend database and graphing system.

Load Neo4j graph database management system before starting Bloodhound:

```
neo4j console start
```

Run Bloodhound in another Terminal tab:

```
//bloodhound --no-sandbox
```

Default credentials are neo4j / neo4j.

Recover Sharphound ZIP file from breached Windows host using SCP:

{% code overflow="wrap" %}
```
scp natasha.howells@thmjmp1.za.tryhackme.com:c:/users/natasha.howells/documents/<Sharphound ZIP> .
```
{% endcode %}

![](<../.gitbook/assets/5 (2).png>)

Drag and drop ZIP file onto Bloodhound GUI to import it.

### Attack Paths <a href="#a8a1i32gyr6w" id="a8a1i32gyr6w"></a>

Pressing the three stripes next to **Search for a node** displays options. First tab displays import information.

Use **Node Info** tab to search for AD objects:

* **Overview** - Provides summaries information such as number of active sessions account has and if it can reach high-value targets.
* **Node Properties** - Shows information regarding AD account such as display name and title.
* **Extra Properties** - Provides more detailed AD information such as distinguished name and when account was created.
* **Group Membership** - Shows information regarding groups that account is member of.
* **Local Admin Rights** - Provides information on domain-joined hosts where account has administrative privileges.
* **Execution Rights** - Provides information on special privileges such as ability to RDP into machine.
* **Outbound Control Rights** - Shows information regarding AD objects where account has permissions to modify their attributes.
* **Inbound Control Rights** - Provides information regarding AD objects that can modify attributes of this account.

Press the number next to information query to display more information.

**Analysis** tab lists queries to enumerate helpful information. Icons are called **nodes**. Lines are called **edges**.

Look at available edges between the current position and privileges and where goal is to formulate target path.

**Filter** icon displays currently available edges.

**Path** icon allows for path searching.

### Session Data Only <a href="#b4wwyni73tzw" id="b4wwyni73tzw"></a>

Active sessions and LogOn events change constantly within AD. Sharphound creates point-in-time snapshot of AD structure resulting in inaccurate session data. Sharphound must be run regularly to mitigate this. Execute Sharphound using **All collection method** at start of assessment and then use **Session** method at least twice a day. 10:00 and 14:00 are good times. Clear stagnant session data before importing fresh data using **Clear Sessions** button in Database **Info** tab.

### Benefits <a href="#id-6o9mgg3rasuk" id="id-6o9mgg3rasuk"></a>

Provides an AD enumeration GUI. Displays attack paths using enumerated AD information. Provides profound insights into AD objects.

### Drawbacks <a href="#vwnksrhwkptj" id="vwnksrhwkptj"></a>

Requires execution of Sharphound that is noisy and often detected by AV or EDR solutions.

### Conclusion <a href="#id-51vf4bqoo6id" id="id-51vf4bqoo6id"></a>

Proper AD enumeration is required to understand structure of domain and determine attack paths that can be leveraged to perform privilege escalation or lateral movement.

### Additional Enumeration Techniques <a href="#tj45qr7aptwq" id="tj45qr7aptwq"></a>

[**LDAP enumeration**](https://book.hacktricks.xyz/pentesting/pentesting-ldap) - Any valid AD credential pair should be able to bind to DC's LDAP interface. This will allow LDAP search queries to be written to enumerate information regarding AD objects in domain.

[**PowerView**](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1) - PowerView is recon script part of [PowerSploit](https://github.com/PowerShellMafia/PowerSploit) project. Project no longer receiving support. However, scripts such as PowerView can be incredibly useful to perform semi-manual enumeration of AD objects.

[**Windows Management Instrumentation (WMI)**](https://0xinfection.github.io/posts/wmi-ad-enum/) - WMI can be used to enumerate information from Windows hosts. Has provider called **root\directory\ldap** that can be used to interact with AD. Provider and WMI can be used in PowerShell to perform AD enumeration.

### Mitigations <a href="#id-8n2rb56lnujy" id="id-8n2rb56lnujy"></a>

AD enumeration is very hard to defend against as many techniques mimic regular network traffic and behaviour. Powerful AD enumeration techniques like Sharphound generate large amount of LogOn events when enumerating session information. Sharphound executes from single AD account so LogOn events will be associated with this single account. **Detection rules** can be written to detect this type of behaviour if it occurs from a user account.

Write signature detection rules for tools that must be installed for specific AD enumeration techniques, such as SharpHound binaries and the AD-RSAT tooling.

Monitor the use of Command Prompt and Powershell (unless used by employees) to detect potential enumeration attempts from unauthorised sources.
