# Enumerating Active Directory

Enumerating Active Directory

### Why AD Enumeration <a href="#mpo51eizt6x4" id="mpo51eizt6x4"></a>

### AD Enumeration <a href="#id-362gdzbi9mek" id="id-362gdzbi9mek"></a>

* Start enumerating various details about the AD setup and structure once an initial foothold has been achieved.
* Enumeration is again performed once an attack path identified by the enumeration phase has been exploited.

![](<../.gitbook/assets/0 (9).png>)

### Credential Injection <a href="#h1efbl5m9nch" id="h1efbl5m9nch"></a>

### Windows vs Linux <a href="#id-8ahtcwhurt9x" id="id-8ahtcwhurt9x"></a>

* A Windows machine is required to perform in-depth AD enumeration as this allows use of several built-in methods to stage enumeration.

### Runas Explained <a href="#anqilxs9otlg" id="anqilxs9otlg"></a>

* “Runas” is a native Windows binary that can be used to inject discovered credentials into memory:

runas.exe /netonly /user:\<domain>\\\<username> cmd.exe

*
  * **/netonly** - load credentials for network authentication into memory but do not authenticate against a DC.
    * Commands executed locally on the computer will run in the context of the standard Windows account.
    * Any network connections will occur using the specified account.
  * **/user** - always a safe bet to use the FQDN instead of just the NetBIOS name of the domain as this helps with resolution.
  * **cmd.exe** - the binary to execute once the credentials are injected.

### It’s Always DNS <a href="#whd9xuif7ov2" id="whd9xuif7ov2"></a>

* Verify that injected credentials are working by forcing an network-based listing of the SYSVOL directory..
* Set DNS manually using the IP of the DC:

$dnsip = “\<DC IP>”

$index = get-netadapter -name ‘\<local interface>’ | select-object -expandproperty ‘ifindex’ set-dnsclientserveraddress =interfaceindex $index -serveraddress $dnsip

* List SYSVOL as any AD account can read the contents of this directory.
  * SYSVOL stores Group Policy Objects (GPOs) and any other domain related scripts - worth enumerating for additional AD credentials.

dir \\\za.tryhackme.com\sysvol\\

### IP vs Hostnames <a href="#b48wm6o9b7e1" id="b48wm6o9b7e1"></a>

* Network authentication will first attempt to perform Kerberos authentication if a hostname is provided.
  * Organisations may be monitoring for OverPass and Pass-The-Hash attacks.
* Authentication type can be forced to NTLM if the IP is used.

### Using Injected Credentials <a href="#id-31x1d8usm2i8" id="id-31x1d8usm2i8"></a>

* All network communication will use the in-memory injected credentials for authentication if the /netonly runas option is specified.

### Enumeration Through Microsoft Management Console <a href="#foya32pzfafl" id="foya32pzfafl"></a>

### Microsoft Management Console <a href="#id-9kcxztc04i8z" id="id-9kcxztc04i8z"></a>

* Use Microsoft Management Console (MMC):
  * Start | search for “run” | mmc
* Attach the AD Remote Server Management Tools (RSAT) Snap-in:
  * Click **File** -> **Add/Remove Snap-in**
  * Select and **Add** all three Active Directory Snap-ins
  * Click through any errors and warnings
  * Right-click on **Active Directory Domains and Trusts** and select **Change Forest**
  * Enter _za.tryhackme.com_ as the **Root domain** and Click **OK**
  * Right-click on **Active Directory Sites and Services** and select **Change Forest**
  * Enter _za.tryhackme.com_ as the **Root domain** and Click OK
  * Right-click on **Active Directory Users and Computers** and select **Change Domain**
  * Enter _za.tryhackme.com_ as the **Domain** and Click **OK**
  * Right-click on **Active Directory Users and Computers** in the left-hand pane
  * Click on **View** -> **Advanced Features**
* MMC should now be pointed to and authenticated against the target domain.

### Users and Computers <a href="#id-48yme86s5s5f" id="id-48yme86s5s5f"></a>

* Expand the domain to see the initial Organisational Unit (OU) structure.
* Clicking on User or Computer objects allows review of all their properties and attributes.
* Passwords could be changed or accounts added to specific groups with the relevant permissions.
* Search feature can be used to look for specific objects.

### Benefits <a href="#u8whjzilshdr" id="u8whjzilshdr"></a>

* GUI provides an excellent method to gain a holistic view of the AD environment.
* Rapid searching of AD objects.
* Direct method to view specific updates of AD objects.
* Directly update existing AD objects or add new ones.

### Drawbacks <a href="#gkgpn05eplel" id="gkgpn05eplel"></a>

* GUI requires RDP access to the machine where it is executed.
* Gathering AD wide properties or attributes cannot be performed.

### Enumeration Through Command Prompt <a href="#id-6wikzkkaor2s" id="id-6wikzkkaor2s"></a>

### Command Prompt <a href="#kr6x5cdz7p5l" id="kr6x5cdz7p5l"></a>

* net built-in command can enumerate AD information.
* Full range of options associated with the command are [here](https://learn.microsoft.com/en-us/troubleshoot/windows-server/networking/net-commands-on-operating-systems).

### Users <a href="#ron9b0ff4ubq" id="ron9b0ff4ubq"></a>

* Enumerate all AD domain users:

net user /domain

* Enumerate more detailed information about a single AD user account:

net user “\<user name>” /domain

### Groups <a href="#h6oglj727e1n" id="h6oglj727e1n"></a>

* Enumerate AD domain groups:

net group /domain

* Enumerate members of a specific AD group:

net group “\<group name>” /domain

### Password Policy <a href="#mweb6jfdlgk5" id="mweb6jfdlgk5"></a>

* Enumerate the domain’s password policy.
  * Beneficial if additional password-spraying attacks are to be staged as the payload and attack intensity can be optimised.

net accounts /domain

![](<../.gitbook/assets/1 (3).png>)

### Benefits <a href="#x357a725y88" id="x357a725y88"></a>

* No additional tooling is required and the commands are often not monitored for by defensive teams.
* No GUI is required.
* VBScript and other macro languages often used for phishing payloads support these commands natively.

### Drawbacks <a href="#id-5kd3l1ikf2ox" id="id-5kd3l1ikf2ox"></a>

* Commands must be executed from a domain-joined machine.
* Some commands will not display all information due to output restrictions.

### Enumeration Through PowerShell <a href="#a5hk8bj11eb4" id="a5hk8bj11eb4"></a>

### PowerShell <a href="#j5e31m7wxjt0" id="j5e31m7wxjt0"></a>

* PowerShell is the upgrade to Command Prompt.
* Cmdlets are .NET classes that perform specific functions.
* AD-RSAT tool automatically installs 50+ cmdlets.
* [Complete list of cmdlets](https://learn.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps).
* \-Filter parameter provides control over enumeration.
* Format-Table cmdlet displays results neatly.

### Users <a href="#m4p1awc8p9px" id="m4p1awc8p9px"></a>

* Get-ADUser cmdlet enumerates the properties of an AD user:

get-aduser -identity “\<account name>” -server \<DC FQDN> -properties \*

* Enumerate all AD users with a particular name:

get-aduser -filter ‘name -like “\*stevens” -server \<DC FQDN> | format-table name,samaccountname -A

### Groups <a href="#ystymyqoz3i6" id="ystymyqoz3i6"></a>

* Get-ADGroup cmdlet enumerates an AD group:

get-adgroup -identity “administrators” -server \<DC FQDN>

* Get-ADGroupMember cmdlet enumerates members of an AD group:

get-adgroupmember -identity “administrators” -server \<DC FQDN>

### AD Objects <a href="#kibg65jbizp8" id="kibg65jbizp8"></a>

* Get-ADObject cmdlet performs a more generic search of AD.
  * Enumerate all AD objects changed after a specific date:

$changedate = new-object datetime(2022,02,28,12,00,00)

get-adobject -filter ‘whenchanged -gt $changedate’ -includedeletedobjects -server \<DC FQDN>

*
  * Enumerate AD accounts that have a badPwdCount greater than 0.
    * Exclude these accounts if performing a password spraying attack.

get-adobject -filter ‘badpwdcount -gt 0’ -server \<DC FQDN>

### Domains <a href="#id-6va6fd8zzium" id="id-6va6fd8zzium"></a>

* Get-ADDomain cmdlet retrieves additional information about a domain:

get-addomain -server \<DC FQDN>

### Altering AD Objects <a href="#id-90ggrg68iiot" id="id-90ggrg68iiot"></a>

* AD-RSAT cmdlets allow the creation and modification of AD objects.
  * This would be considered AD exploitation.
  * Change the password of the current user using the Set-ADAccountPassword cmdlet:

set-adaccountpassword -identity “\<account name>” -server \<DC FQDN> -oldpassword (convertto-securestring -asplaintext “\<old password>” -force) -newpassword (convertto-securestring -asplaintext “\<new password>” -force)

### Benefits <a href="#ulhvll7xxmjo" id="ulhvll7xxmjo"></a>

* PowerShell cmdlets can enumerate significantly more information than Command Prompt “net” commands.
* Commands can be executed from a non-domain-joined machine if the server and domain are specified.
* Custom cmdlets can be created to enumerate specific information.
* AD-RSAT cmdlets can be used to directly change AD objects.

### Drawbacks <a href="#z0m5exp3zhdk" id="z0m5exp3zhdk"></a>

* PowerShell usage is often monitored by defensive teams.
* AD-RSAT must be installed or other potentially detectable scripts used.

### Enumeration Through Bloodhound <a href="#id-6ojxr3ypsrhm" id="id-6ojxr3ypsrhm"></a>

* [Bloodhound](https://github.com/BloodHoundAD/BloodHound) is the most powerful AD enumeration tool to date.

### Bloodhound History <a href="#s75l67kpizeh" id="s75l67kpizeh"></a>

* Released in 2016 and gave attackers the upper hand in AD enumeration.
* Microsoft integrated their own version of Bloodhound into its Advanced Threat Protection solution to help defenders visualise the AD environment.
* Provides a graph format with interconnected nodes where each connection is a possible path that could be exploited to reach a goal.
* Graph based thinking allows for a two-stage attack:
  * Attacker performs phishing to get an initial entry to enumerate AD information
    * Noisy initial payload would be detected and contained before the attacker can do anything beyond exfiltrating the enumerated data.
  * Attacker uses the data offline to create an attack path in graph format and launches a second phishing campaign using the gathered information.
    * Attacker reaches their goal in minutes once a breach is achieved.

### Sharphound <a href="#cpql22x4vcrf" id="cpql22x4vcrf"></a>

* Sharphound is the enumeration tool of Bloodhound.
* Three different Sharphound collectors:
  * **Sharphound.ps1** - PowerShell script for running Sharphound. Depreciated. Good to use with RATs as the script can be loaded directly into memory to evade on-disk AV scanning.
  * **Sharphound.exe** - Windows executable for running Sharphound.
  * **AzureHound.ps1** - PowerShell script for running Sharphound for Azure (Microsoft Cloud Computing Services) instances.
* Sharphound and Bloodhound versions must match otherwise old Sharphound results cannot be ingested.
* High likelihood that SharpHound collector scripts will be detected as malware and raise alerts to the Blue team.
  * Use the runas command from a non-domain-joined Windows machine to inject AD credentials and point Sharphound to a DC.
  * Disable AV or create exceptions on the breached Windows machine.
* Copy Sharphound binary to breached Windows host:

![](<../.gitbook/assets/2 (3).png>)

* Run Sharphound using the All and Session collection methods:

sharphound.exe --collectionmethods all --domain za.tryhackme.com --excludedcs

*
  * **--CollectionMethods** - determines what kind of data Sharphound will collect.
    * Common methods are **Default** or **All**.
    * Can only use the **Session** method after the first scan has been run to retrieve new user sessions.
  * **--Domain** - specify domain to enumerate.
  * **--ExcludeDCs** - reduces the likelihood that Sharphound will raise alerts.
  * [List of Sharphound flags](https://bloodhound.readthedocs.io/en/latest/data-collection/sharphound-all-flags.html).

![](<../.gitbook/assets/3 (4).png>)

* Timestamped ZIP file is created once Sharphound has completed the enumeration.

![](<../.gitbook/assets/4 (2).png>)

### Bloodhound <a href="#jtcaj5euy6i" id="jtcaj5euy6i"></a>

* AD information enumerated by Sharphound is displayed in Bloodhound's GUI.
* Bloodhound uses Neoj4 as its backend database and graphing system.
* Load the Neo4j graph database management system before starting Bloodhound:

neo4j console start

* Run Bloodhound in another Terminal tab.
  * Default credentials are neo4j / neo4j.

bloodhound --no-sandbox

* Recover the Sharphound ZIP file from the breached Windows host using SCP:

scp natasha.howells@thmjmp1.za.tryhackme.com:c:/users/natasha.howells/documents/\<Sharphound ZIP> .

![](<../.gitbook/assets/5 (2).png>)

* Drag and drop the ZIP file onto the Bloodhound GUI to import it.

### Attack Paths <a href="#a8a1i32gyr6w" id="a8a1i32gyr6w"></a>

* Pressing the three stripes next to “Search for a node” displays options.
* First tab displays import information.
* Use the **Node Info** tab to search for AD objects:
  * **Overview** - Provides summaries information such as the number of active sessions the account has and if it can reach high-value targets.
  * **Node Properties** - Shows information regarding the AD account, such as the display name and the title.
  * **Extra Properties** - Provides more detailed AD information such as the distinguished name and when the account was created.
  * **Group Membership** - Shows information regarding the groups that the account is a member of.
  * **Local Admin Rights** - Provides information on domain-joined hosts where the account has administrative privileges.
  * **Execution Rights** - Provides information on special privileges such as the ability to RDP into a machine.
  * **Outbound Control Rights** - Shows information regarding AD objects where this account has permissions to modify their attributes.
  * **Inbound Control Rights** - Provides information regarding AD objects that can modify the attributes of this account.
  * Press the number next to an information query to display more information.
* **Analysis** tab lists queries to enumerate helpful information.
  * Icons are called nodes.
  * Lines are called edges.
* Look at the available edges between the current position and privileges and where the goal is to formulate a target path.
* **Filter** icon displays the currently available edges.
* **Path** icon allows for path searching.

### Session Data Only <a href="#b4wwyni73tzw" id="b4wwyni73tzw"></a>

* Active sessions and LogOn events change constantly within AD.
* Sharphound creates a point-in-time snapshot of the AD structure resulting in inaccurate session data.
  * Sharphound must be run regularly to mitigate this.
* Execute Sharphound using the All collection method at the start of the assessment and then use the Session method at least twice a day.
  * 10:00 and 14:00 are good times.
* Clear stagnant session data before importing fresh data using the “Clear Sessions” button in the Database Info tab.

### Benefits <a href="#id-6o9mgg3rasuk" id="id-6o9mgg3rasuk"></a>

* Provides an AD enumeration GUI.
* Displays attack paths using the enumerated AD information.
* Provides profound insights into AD objects.

### Drawbacks <a href="#vwnksrhwkptj" id="vwnksrhwkptj"></a>

* Requires execution of Sharphound that is noisy and is often detected by AV or EDR solutions.

### Conclusion <a href="#id-51vf4bqoo6id" id="id-51vf4bqoo6id"></a>

* Proper AD enumeration is required to understand the structure of the domain and determine attack paths that can be leveraged to perform privilege escalation or lateral movement.

### Additional Enumeration Techniques <a href="#tj45qr7aptwq" id="tj45qr7aptwq"></a>

* [**LDAP enumeration**](https://book.hacktricks.xyz/pentesting/pentesting-ldap) - Any valid AD credential pair should be able to bind to a DC's LDAP interface.
  * This will allow LDAP search queries to be written to enumerate information regarding the AD objects in the domain.
* [**PowerView**](https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1) - PowerView is a recon script part of the[ PowerSploit](https://github.com/PowerShellMafia/PowerSploit) project.
  * This project is no longer receiving support.
    * However, scripts such as PowerView can be incredibly useful to perform semi-manual enumeration of AD objects.
* [**Windows Management Instrumentation (WMI)**](https://0xinfection.github.io/posts/wmi-ad-enum/) - WMI can be used to enumerate information from Windows hosts.
  * It has a provider called "root\directory\ldap" that can be used to interact with AD.
    * This provider and WMI can be used in PowerShell to perform AD enumeration.

### Mitigations <a href="#id-8n2rb56lnujy" id="id-8n2rb56lnujy"></a>

* AD enumeration is very hard to defend against as many techniques mimic regular network traffic and behaviour.
* Powerful AD enumeration techniques like Sharphound generate a large amount of LogOn events when enumerating session information.
  * Sharphound executes from a single AD account so the LogOn events will be associated with this single account.
  * **Detection rules** can be written to detect this type of behaviour if it occurs from a user account.
* Write signature detection rules for the tools that must be installed for specific AD enumeration techniques, such as the SharpHound binaries and the AD-RSAT tooling.
* Monitor the use of Command Prompt and Powershell unless used by employees to detect potential enumeration attempts from unauthorised sources.
